<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Chogui League - Sistema de Gestión Profesional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
            position: relative;
        }

        /* Efectos de fuego/energía similares al logo */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(220, 20, 60, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: linear-gradient(45deg, #ffd700, #ff8c00, #ff6b35);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.4);
            animation: float 6s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(1deg); }
        }

        @keyframes shine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            margin-bottom: 10px;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            opacity: 0.9;
            color: #1a1a2e;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .admin-controls {
            position: fixed;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .admin-btn {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            padding: 8px 16px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            cursor: pointer;
            border: none;
        }

        .admin-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.6);
            color: #1a1a2e;
            text-decoration: none;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            gap: 10px;
        }

        .nav-tab {
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            color: #ffd700;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            min-width: 120px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }

        .nav-tab:hover {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }

        .nav-tab.active {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.5);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 2px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transition: left 0.5s;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .card h3 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.4rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: relative;
            z-index: 1;
        }

        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ffd700;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            background: rgba(26, 26, 46, 0.8);
            color: #ffd700;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #ffd700;
            outline: none;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.6);
        }
        
        .btn-actualizar {
            background: linear-gradient(145deg, #007BFF, #0056b3);
            color: white;
        }
        .btn-actualizar:hover {
            background: linear-gradient(145deg, #0088ff, #0056b3);
            color: white;
            transform: translateY(-2px) scale(1.05);
        }
        .btn-actualizar[disabled] {
            background: #555;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-secondary {
            background: linear-gradient(145deg, #ff6b35, #dc143c);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .btn-secondary:hover {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            transform: scale(1.1);
        }
        
        .btn-edit {
            background: linear-gradient(145deg, #007BFF, #0056b3);
            color: white;
        }
        .btn-edit:hover {
            background: linear-gradient(145deg, #0088ff, #0056b3);
            color: white;
        }
        
        .btn-activar {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            font-weight: bold;
        }
        .btn-activar[disabled] {
            background: #555;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.4);
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            min-width: 600px;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            font-size: 0.9rem;
        }

        th {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: rgba(255, 215, 0, 0.1);
            transition: all 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #ffd700;
            font-style: italic;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #4CAF50;
            display: none;
        }

        .error-message {
            background: rgba(220, 20, 60, 0.2);
            color: #dc143c;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #dc143c;
            display: none;
        }

        .loading {
            color: #ffd700;
            font-style: italic;
        }

        /* Estilos específicos para la pestaña de Líderes */
        .leaders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .leader-card {
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .leader-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .leader-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 215, 0, 0.4);
            border-color: #ffd700;
        }

        .leader-card h4 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: relative;
            z-index: 1;
        }

        .leader-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .leader-item:last-child {
            border-bottom: none;
        }

        .leader-name {
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .leader-team {
            color: #ffd700;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .leader-stat {
            color: #ff8c00;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .stats-form-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .gold-medal {
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .silver-medal {
            color: #C0C0C0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .bronze-medal {
            color: #CD7F32;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        /* Nuevos estilos para líderes por posición específica */
        .position-leaders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .position-card {
            background: linear-gradient(135deg, #16213e, #1a1a2e);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .position-card:hover {
            border-color: #ffd700;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }

        .position-title {
            color: #ffd700;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .position-leader {
            text-align: left; /* CORREGIDO: para listas */
            padding: 0;
        }
        
        /* ESTILOS NUEVOS PARA LISTA TOP 5 */
        .position-leader-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }
        .position-leader-item:last-child {
            border-bottom: none;
        }
        
        .position-player-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .position-player {
            color: #fff;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .position-team {
            color: #ffd700;
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .position-rating {
            color: #ff8c00;
            font-weight: bold;
            font-size: 1.1rem;
        }
        /* FIN ESTILOS NUEVOS */

        /* Sistema WAR avanzado */
        .war-stats {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.1));
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .war-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .war-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.8rem;
        }

        .war-component {
            text-align: center;
            padding: 8px;
            background: rgba(26, 26, 46, 0.5);
            border-radius: 6px;
        }

        .war-component-title {
            color: #ffd700;
            font-size: 0.7rem;
            margin-bottom: 3px;
        }

        .war-component-value {
            color: #fff;
            font-weight: bold;
        }
        
        /* === INICIO ESTILOS FASE 7: CALENDARIO === */
        #calendario-generado {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .jornada-card {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
        }
        .jornada-card h4 {
            color: #ff8c00;
            border-bottom: 1px solid #ff8c00;
            padding-bottom: 8px;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .jornada-partido {
            font-size: 0.9rem;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .jornada-partido:last-child {
            border-bottom: none;
        }
        .jornada-partido strong {
            color: #fff;
        }
        .jornada-partido span {
            color: #ffd700;
            font-size: 0.8rem;
        }
        .jornada-descansa {
            margin-top: 10px;
            font-style: italic;
            color: #ff6b35;
            font-size: 0.9rem;
            font-weight: bold;
            background: rgba(255, 107, 53, 0.1);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        /* === FIN ESTILOS FASE 7 === */

        @media (max-width: 768px) {
            .form-container, .stats-form-container {
                grid-template-columns: 1fr;
            }
            
            .leaders-grid, .position-leaders-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-controls">
        <a href="index.html" class="admin-btn">👁️ Vista Pública</a>
        <button onclick="logout()" class="admin-btn">🚪 Salir</button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>🏆 CHOGUI LEAGUE - ADMIN</h1>
            <p>Panel de Administración - Sistema de Gestión Profesional MLB</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="equipos">🏅 Equipos</button>
            <button class="nav-tab" data-tab="partidos">🎯 Partidos</button>
            <button class="nav-tab" data-tab="jugadores">👤 Jugadores</button>
            <button class="nav-tab" data-tab="lideres">🏆 Líderes</button>
            <button class="nav-tab" data-tab="posiciones">📊 Posiciones</button>
            <button class="nav-tab" data-tab="torneos">🗓️ Torneos</button>
            <button class="nav-tab" data-tab="calendario">📅 Calendario</button>
            </div>

        <div id="equipos" class="tab-content active">
            <div class="card">
                <h3>➕ Agregar Nuevo Equipo</h3>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="nombreEquipo">Nombre del Equipo:</label>
                            <input type="text" id="nombreEquipo" required>
                        </div>
                        <div class="form-group">
                            <label for="managerEquipo">Manager:</label>
                            <input type="text" id="managerEquipo" required>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="ciudadEquipo">Ciudad:</label>
                            <input type="text" id="ciudadEquipo" required>
                        </div>
                        <div class="form-group">
                            <button class="btn-primary" onclick="agregarEquipo()">🏆 Agregar Equipo</button>
                        </div>
                    </div>
                </div>
                <div id="equipoMessage" class="success-message"></div>
                <div id="equipoError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>🏆 Equipos Registrados</h3>
                <div class="table-container">
                    <table id="equiposTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Equipo</th>
                                <th>Manager</th>
                                <th>Ciudad</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">Cargando equipos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="partidos" class="tab-content">
            <div class="card">
                <h3>⚾ Registrar Nuevo Partido</h3>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="equipoLocal">Equipo Local:</label>
                            <select id="equipoLocal" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="equipoVisitante">Equipo Visitante:</label>
                            <select id="equipoVisitante" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="carrerasLocal">Carreras Local:</label>
                            <input type="number" id="carrerasLocal" min="0">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="carrerasVisitante">Carreras Visitante:</label>
                            <input type="number" id="carrerasVisitante" min="0">
                        </div>
                        <div class="form-group">
                            <label for="inningsJugados">Innings Jugados:</label>
                            <input type="number" id="inningsJugados" min="1" max="15" value="9">
                        </div>
                        <div class="form-group">
                            <label for="fechaPartido">Fecha del Partido:</label>
                            <input type="date" id="fechaPartido" required>
                        </div>
                    </div>
                </div>
                <button class="btn-primary" onclick="registrarPartido()">🎯 Registrar Partido</button>
                <div id="partidoMessage" class="success-message"></div>
                <div id="partidoError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>🎯 Partidos Registrados</h3>
                <div class="table-container">
                    <table id="partidosTable">
                        <thead>
                            <tr>
                                <th>Local</th>
                                <th>Visitante</th>
                                <th>Resultado</th>
                                <th>Innings</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">Cargando partidos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="jugadores" class="tab-content">
            <div class="card">
                <h3>👤 Agregar Nuevo Jugador</h3>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="nombreJugador">Nombre del Jugador:</label>
                            <input type="text" id="nombreJugador" required>
                        </div>
                        <div class="form-group">
                            <label for="equipoJugador">Equipo:</label>
                            <select id="equipoJugador" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="posicionJugador">Posición:</label>
                            <select id="posicionJugador" required>
                                <option value="">Seleccionar posición...</option>
                                <option value="C">Catcher (C)</option>
                                <option value="1B">Primera Base (1B)</option>
                                <option value="2B">Segunda Base (2B)</option>
                                <option value="3B">Tercera Base (3B)</option>
                                <option value="SS">Shortstop (SS)</option>
                                <option value="LF">Left Field (LF)</option>
                                <option value="CF">Center Field (CF)</option>
                                <option value="RF">Right Field (RF)</option>
                                <option value="P">Pitcher (P)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="numeroJugador">Número:</label>
                            <input type="number" id="numeroJugador" min="1" max="99">
                        </div>
                        <div class="form-group">
                            <button class="btn-primary" onclick="agregarJugador()">👤 Agregar Jugador</button>
                        </div>
                    </div>
                </div>
                <div id="jugadorMessage" class="success-message"></div>
                <div id="jugadorError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>👥 Jugadores Registrados</h3>
                <div class="table-container">
                    <table id="jugadoresTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>Posición</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Cargando jugadores...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="lideres" class="tab-content">
            
            <div class="card">
                <h3>📝 Editar Estadísticas de Bateo</h3>
                <div class="table-container">
                    <table id="tablaEditarBateo">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>AB</th>
                                <th>H</th>
                                <th>HR</th>
                                <th>RBI</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3>📝 Editar Estadísticas de Pitcheo</h3>
                <div class="table-container">
                    <table id="tablaEditarPitcheo">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>IP</th>
                                <th>ER</th>
                                <th>W</th>
                                <th>L</th>
                                <th>SV</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="8" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>📝 Editar Estadísticas Defensivas</h3>
                <div class="table-container">
                    <table id="tablaEditarDefensa">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>PO</th>
                                <th>A</th>
                                <th>E</th>
                                <th>DP</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3>📊 Registrar Estadísticas Avanzadas (BATEO)</h3>
                <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 15px;">Use este formulario para **SUMAR** estadísticas a un jugador (ej. después de un partido).</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorStats">Jugador:</label>
                        <select id="jugadorStats" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="atBats">At Bats (AB):</label>
                        <input type="number" id="atBats" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="hits">Hits (H):</label>
                        <input type="number" id="hits" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="homeRuns">Home Runs (HR):</label>
                        <input type="number" id="homeRuns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="rbi">RBI:</label>
                        <input type="number" id="rbi" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="runs">Carreras (R):</label>
                        <input type="number" id="runs" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="walks">Bases por Bolas (BB):</label>
                        <input type="number" id="walks" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="stolenBases">Bases Robadas (SB):</label>
                        <input type="number" id="stolenBases" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="errors" style="color: #ff8c00; opacity: 0.7;">Errores (E):</label>
                        <input type="number" id="errors" min="0" value="0" disabled>
                         <small style="color: #ff8c00; font-size: 0.8rem;">Los errores se registran en el form defensivo.</small>
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarOfensiva" onclick="registrarEstadisticas()">📊 Registrar Estadísticas (Sumar)</button>
                <div id="statsMessage" class="success-message"></div>
                <div id="statsError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>⚾ Registrar Estadísticas de Pitcheo</h3>
                 <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 15px;">Use este formulario para **SUMAR** estadísticas a un pitcher.</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorPitcheo">Pitcher:</label>
                        <select id="jugadorPitcheo" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inningsPitched">Innings Pitched (IP):</label>
                        <input type="number" id="inningsPitched" step="0.1" min="0" value="0">
                        <small style="color: #ffd700; font-size: 0.8rem;">Ej: 5.2 = 5 innings y 2 outs</small>
                    </div>
                    <div class="form-group">
                        <label for="hitsAllowed">Hits Permitidos:</label>
                        <input type="number" id="hitsAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="earnedRuns">Carreras Limpias (ER):</label>
                        <input type="number" id="earnedRuns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="strikeouts">Ponches (SO):</label>
                        <input type="number" id="strikeouts" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="walksAllowed">Bases por Bolas (BB):</label>
                        <input type="number" id="walksAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="homeRunsAllowed">Home Runs Permitidos:</label>
                        <input type="number" id="homeRunsAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="wins">Victorias (W):</label>
                        <input type="number" id="wins" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="losses">Derrotas (L):</label>
                        <input type="number" id="losses" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="saves">Salvamentos (SV):</label>
                        <input type="number" id="saves" min="0" value="0">
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarPitcheo" onclick="registrarEstadisticasPitcheo()">⚾ Registrar Estadísticas (Sumar)</button>
                <div id="pitcheoMessage" class="success-message"></div>
                <div id="pitcheoError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>🛡 Registrar Estadísticas Defensivas</h3>
                 <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 15px;">Use este formulario para **SUMAR** estadísticas a un jugador.</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorDefensivo">Jugador:</label>
                        <select id="jugadorDefensivo" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="putouts">Eliminaciones (PO):</label>
                        <input type="number" id="putouts" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="assists">Asistencias (A):</label>
                        <input type="number" id="assists" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="defensiveErrors">Errores (E):</label>
                        <input type="number" id="defensiveErrors" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="doublePlays">Jugadas Dobles (DP):</label>
                        <input type="number" id="doublePlays" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="passedBalls">Pelotas Pasadas (PB):</label>
                        <input type="number" id="passedBalls" min="0" value="0">
                        <small style="color: #ffd700; font-size: 0.8rem;">Solo para catchers</small>
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarDefensa" onclick="registrarEstadisticasDefensivas()">🛡 Registrar Estadísticas (Sumar)</button>
                <div id="defensivaMessage" class="success-message"></div>
                <div id="defensivaError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>🥇 MEJORES POR POSICIÓN - DEFENSIVA</h3>
                <div class="position-leaders-grid" id="positionLeadersGrid">
                    <div class="loading">Cargando líderes defensivos...</div>
                </div>
            </div>

            <div class="card">
                <h3>🏆 Líderes Generales de la Liga - BATEO</h3>
                <div class="leaders-grid">
                    <div class="leader-card">
                        <h4>🥇 MEJOR PROMEDIO (AVG)</h4>
                        <div id="avgLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.---</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>⚾ LÍDERES EN HOME RUNS</h4>
                        <div id="hrLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>🎯 LÍDERES EN RBI</h4>
                        <div id="rbiLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>📈 LÍDERES EN OPS</h4>
                        <div id="opsLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.---</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>⭐ MEJOR WAR TOTAL</h4>
                        <div id="warLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.--</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>🏃 BASES ROBADAS</h4>
                        <div id="sbLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>📈 Estadísticas Completas de Bateo</h3>
                <div class="table-container">
                    <table id="statsTable">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>Pos</th>
                                <th>AB</th>
                                <th>H</th>
                                <th>AVG</th>
                                <th>OBP</th>
                                <th>OPS</th>
                                <th>HR</th>
                                <th>RBI</th>
                                <th>WAR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="11" class="loading">Cargando estadísticas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: #ffd700; font-size: 0.8rem;">
                    <strong>Leyenda:</strong> AB=At Bats, H=Hits, AVG=Average, OBP=On-Base %, OPS=On-Base+Slugging, HR=Home Runs, RBI=Runs Batted In, WAR=Wins Above Replacement
                </p>
            </div>
        </div>

        <div id="posiciones" class="tab-content">
            <div class="card">
                <h3>🏆 Tabla de Posiciones en Tiempo Real</h3>
                <div class="table-container">
                    <table id="posicionesTable">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Equipo</th>
                                <th>PJ</th>
                                <th>PG</th>
                                <th>PP</th>
                                <th>%</th>
                                <th>CF</th>
                                <th>CE</th>
                                <th>DIF</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="10" class="loading">Calculando posiciones...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: #ffd700; font-size: 0.8rem;">
                    <strong>Leyenda:</strong> PJ=Partidos Jugados, PG=Partidos Ganados, PP=Partidos Perdidos, %=Porcentaje, CF=Carreras a Favor, CE=Carreras en Contra, DIF=Diferencia
                </p>
            </div>
        </div>
        
        <div id="torneos" class="tab-content">
            <div class="card">
                <h3>➕ Crear Nuevo Torneo</h3>
                <div class="form-container" style="grid-template-columns: 1fr;">
                    <div>
                        <div class="form-group">
                            <label for="nombreTorneo">Nombre del Torneo:</label>
                            <input type="text" id="nombreTorneo" required placeholder="Ej: Torneo Verano 2026">
                        </div>
                        <div class="form-group">
                            <button class="btn-primary" onclick="crearTorneo()">🗓️ Crear Torneo</button>
                        </div>
                    </div>
                </div>
                <div id="torneoMessage" class="success-message"></div>
                <div id="torneoError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>🗓️ Torneos Existentes</h3>
                <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 15px;">Selecciona el torneo que estará **activo**. Todas las nuevas estadísticas se guardarán en este torneo.</p>
                <button class="btn-secondary" onclick="desactivarTodosLosTorneos()" style="background: #ff8c00; margin-bottom: 15px; font-weight: bold;">⚪ Desactivar Todos</button>
                <div class="table-container">
                    <table id="torneosTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre del Torneo</th>
                                <th>Fecha de Creación</th>
                                <th>Estado</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Cargando torneos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="calendario" class="tab-content">
            <div class="card">
                <h3>📅 Generador de Calendario (Round Robin)</h3>
                <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 20px;">
                    Genera el fixture para los <strong>9 equipos</strong>. Se crearán <strong>6 jornadas</strong> (4 juegos y 1 descanso por jornada).
                </p>
                
                <div class="form-container" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="fechaInicioCalendario">Fecha de Inicio (Jornada 1):</label>
                        <input type="date" id="fechaInicioCalendario" required>
                    </div>
                    <div class="form-group">
                        <label for="horariosJuego">Horarios (separados por coma):</label>
                        <input type="text" id="horariosJuego" value="09:00, 11:00, 13:00, 15:00">
                    </div>
                    <div class="form-group">
                        <label for="diasEntreJornadas">Días entre Jornadas:</label>
                        <input type="number" id="diasEntreJornadas" value="7" min="1">
                    </div>
                </div>
                
                <button class="btn-primary" onclick="generarCalendario()">📅 Generar Calendario</button>
                <button class="btn-primary btn-actualizar" id="btnGuardarCalendario" onclick="guardarCalendario()" disabled style="margin-left: 10px;">💾 Guardar Calendario en BD</button>
                
                <div id="calendarioMessage" class="success-message"></div>
                <div id="calendarioError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>🗓️ Fixture Generado</h3>
                <div id="calendario-generado">
                    <div class="empty-state">Presiona "Generar Calendario" para ver el fixture aquí.</div>
                </div>
            </div>
        </div>
        </div>

    <script>
        // Variables globales
        let equipos = [];
        let partidos = [];
        let jugadores = [];
        let estadisticas = []; // Esta variable ahora es para ESTADÍSTICAS OFENSIVAS
        
        // *** INICIO FASE 5: Variable para Torneo Activo ***
        let torneoActivo = { id: null, nombre: 'NINGUNO' }; // Default
        // *** FIN FASE 5 ***
        
        // Ajustes posicionales tipo MLB (valores reales)
        const AJUSTES_POSICIONALES = {
            'C': 12.5,    // Catcher - más difícil
            'SS': 7.5,    // Shortstop
            'CF': 2.5,    // Center Field
            '2B': 3.0,    // Segunda Base
            '3B': 2.0,    // Tercera Base
            'RF': -7.5,   // Right Field
            'LF': -7.0,   // Left Field
            '1B': -12.5,  // Primera Base - más fácil
            'P': 0.0      // Pitcher (especial)
        };

        // Verificar autenticación y cargar datos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacion();
            configurarEventListeners();
            cargarTodosLosDatos();
            establecerFechaActual();
        });

        // Verificar que el usuario sea administrador
        function verificarAutenticacion() {
            const userRole = localStorage.getItem('userRole');
            
            if (!userRole || userRole !== 'admin') {
                alert('⛔ Acceso denegado. Solo administradores pueden acceder.');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Administrador conectado:', localStorage.getItem('username'));
        }

        // Logout
        function logout() {
            localStorage.removeItem('userRole');
            localStorage.removeItem('username');
            alert('👋 Sesión cerrada correctamente');
            window.location.href = 'login.html';
        }

        // Establecer fecha actual en el formulario
        function establecerFechaActual() {
            const fechaInput = document.getElementById('fechaPartido');
            if (fechaInput) {
                const hoy = new Date().toISOString().split('T')[0];
                fechaInput.value = hoy;
            }
            // === INICIO CAMBIO FASE 7.2: Establecer fecha en calendario ===
            const fechaCalendarioInput = document.getElementById('fechaInicioCalendario');
            if(fechaCalendarioInput) {
                const hoy = new Date().toISOString().split('T')[0];
                fechaCalendarioInput.value = hoy;
            }
            // === FIN CAMBIO FASE 7.2 ===
        }

        // Configurar event listeners
        function configurarEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    mostrarPestana(this.dataset.tab);
                });
            });
        }

        // Sistema de navegación por pestañas
        function mostrarPestana(nombrePestana) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            const pestanaActiva = document.getElementById(nombrePestana);
            if (pestanaActiva) {
                pestanaActiva.classList.add('active');
            }

            const botonActivo = document.querySelector(`[data-tab="${nombrePestana}"]`);
            if (botonActivo) {
                botonActivo.classList.add('active');
            }

            // Cargar datos específicos de la pestaña
            if (nombrePestana === 'lideres') {
                actualizarLideres();
                actualizarLideresPorPosicion();
                cargarTablaEditarBateo();
                cargarTablaEditarPitcheo();
                cargarTablaEditarDefensa();
            }
            if (nombrePestana === 'torneos') {
                cargarTorneos();
            }
        }

        // ========== FUNCIONES DE CARGA DE DATOS ==========

        async function cargarTodosLosDatos() {
            try {
                await cargarTorneoActivo();
                
                await cargarEquipos();
                await cargarPartidos();
                await cargarJugadores();
                await cargarEstadisticas(); 
                actualizarSelectores();
                calcularPosiciones();
                actualizarLideres(); 
                actualizarLideresPorPosicion(); 
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarError('equipoError', 'Error de conexión al servidor');
            }
        }
        
        // *** INICIO FASE 5: Funciones de Torneos ***
        async function cargarTorneoActivo() {
             try {
                const response = await fetch('/api/torneos/activo');
                if (response.ok) {
                    torneoActivo = await response.json();
                    console.log(`✅ Torneo Activo: ${torneoActivo.nombre} (ID: ${torneoActivo.id})`);
                } else {
                    torneoActivo = { id: null, nombre: 'NINGUNO' };
                    console.warn('⚠️ No hay ningún torneo activo. Las estadísticas no se guardarán.');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('torneoError', 'Error cargando torneo activo.');
            }
        }
        
        async function cargarTorneos() {
            const tbody = document.querySelector('#torneosTable tbody');
            try {
                const response = await fetch('/api/torneos');
                if (!response.ok) throw new Error('Error al cargar');
                const torneos = await response.json();
                
                if (torneos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No hay torneos creados.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = torneos.map(torneo => `
                    <tr>
                        <td>${torneo.id}</td>
                        <td><strong>${torneo.nombre}</strong></td>
                        <td>${new Date(torneo.fecha_inicio).toLocaleDateString('es-AR')}</td>
                        <td>${torneo.activo ? '🟢 Activo' : '⚪ Inactivo'}</td>
                        <td>
                            <button class="btn-secondary btn-edit" onclick="editarTorneo(${torneo.id}, '${torneo.nombre}')">✏️ Editar</button>
                            <button 
                                class="btn-secondary btn-activar" 
                                onclick="activarTorneo(${torneo.id})"
                                ${torneo.activo ? 'disabled' : ''}
                            >
                                ${torneo.activo ? 'Ya Activo' : 'Activar'}
                            </button>
                            <button class="btn-secondary" onclick="eliminarTorneo(${torneo.id})" style="background: #dc143c;">🗑️ Eliminar</button>
                            </td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" class="error-message">${error.message}</td></tr>`;
            }
        }
        
        async function crearTorneo() {
            const nombre = document.getElementById('nombreTorneo').value.trim();
            if (!nombre) {
                mostrarError('torneoError', 'El nombre es requerido');
                return;
            }
            
             try {
                const response = await fetch('/api/torneos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre })
                });

                if (response.ok) {
                    document.getElementById('nombreTorneo').value = '';
                    mostrarExito('torneoMessage', `✅ Torneo "${nombre}" creado.`);
                    cargarTorneos(); // Recargar la lista
                } else {
                    const errorData = await response.json();
                    mostrarError('torneoError', errorData.error || 'Error al crear torneo');
                }
            } catch (error) {
                mostrarError('torneoError', 'Error de conexión');
            }
        }
        
        async function editarTorneo(id, nombreActual) {
            const nuevoNombre = prompt('Ingresa el nuevo nombre para el torneo:', nombreActual);
            
            if (!nuevoNombre || nuevoNombre.trim() === '' || nuevoNombre === nombreActual) {
                return; 
            }

            try {
                const response = await fetch(`/api/torneos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre: nuevoNombre.trim() })
                });

                if (response.ok) {
                    mostrarExito('torneoMessage', `✅ Nombre del torneo actualizado a "${nuevoNombre}".`);
                    await cargarTorneoActivo(); 
                    cargarTorneos(); 
                } else {
                    const errorData = await response.json();
                    mostrarError('torneoError', errorData.error || 'Error al editar torneo');
                }
            } catch (error) {
                mostrarError('torneoError', 'Error de conexión');
            }
        }
        
        async function activarTorneo(id) {
            if (!confirm('¿Estás seguro de activar este torneo? Todas las nuevas estadísticas se guardarán aquí.')) {
                return;
            }
            
             try {
                const response = await fetch(`/api/torneos/${id}/activar`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    const torneoActivado = await response.json();
                    mostrarExito('torneoMessage', `✅ Torneo "${torneoActivado.nombre}" está ahora activo.`);
                    await cargarTorneoActivo(); 
                    cargarTorneos(); 
                } else {
                    const errorData = await response.json();
                    mostrarError('torneoError', errorData.error || 'Error al activar torneo');
                }
            } catch (error) {
                mostrarError('torneoError', 'Error de conexión');
            }
        }
        
        async function desactivarTodosLosTorneos() {
            if (!confirm('¿Estás seguro? Esto hará que no haya ningún torneo activo. No podrás registrar nuevas estadísticas hasta que actives uno.')) {
                return;
            }
            try {
                const response = await fetch('/api/torneos/desactivar-todos', { method: 'PUT' });
                if (response.ok) {
                    mostrarExito('torneoMessage', 'Todos los torneos desactivados.');
                    await cargarTorneoActivo(); 
                    cargarTorneos();
                } else {
                    const errorData = await response.json();
                    mostrarError('torneoError', errorData.error || 'Error al desactivar');
                }
            } catch (error) {
                mostrarError('torneoError', 'Error de conexión');
            }
        }

        async function eliminarTorneo(id) {
            if (!confirm('¿Estás seguro de eliminar este torneo? Esta acción NO se puede deshacer.\n\nADVERTENCIA: Solo podrás eliminarlo si no tiene estadísticas asociadas.')) {
                return;
            }
            try {
                const response = await fetch(`/api/torneos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    mostrarExito('torneoMessage', 'Torneo eliminado correctamente.');
                    cargarTorneos();
                } else {
                    const errorData = await response.json();
                    mostrarError('torneoError', errorData.error || 'Error al eliminar');
                }
            } catch (error) {
                mostrarError('torneoError', 'Error de conexión');
            }
        }
        // *** FIN FASE 5 ***

        async function cargarEquipos() {
            try {
                const response = await fetch('/api/equipos');
                if (response.ok) {
                    equipos = await response.json();
                    actualizarTablaEquipos();
                } else {
                    throw new Error('Error cargando equipos');
                }
            } catch (error) {
                console.error('Error:', error);
                document.querySelector('#equiposTable tbody').innerHTML = 
                    '<tr><td colspan="6" class="error-message">Error cargando equipos</td></tr>';
            }
        }

        async function cargarPartidos() {
            try {
                const response = await fetch('/api/partidos');
                if (response.ok) {
                    partidos = await response.json();
                    actualizarTablaPartidos();
                } else {
                    throw new Error('Error cargando partidos');
                }
            } catch (error) {
                console.error('Error:', error);
                document.querySelector('#partidosTable tbody').innerHTML = 
                    '<tr><td colspan="6" class="error-message">Error cargando partidos</td></tr>';
            }
        }

        async function cargarJugadores() {
            try {
                const response = await fetch('/api/jugadores');
                if (response.ok) {
                    jugadores = await response.json();
                    actualizarTablaJugadores();
                } else {
                    throw new Error('Error cargando jugadores');
                }
            } catch (error) {
                console.error('Error:', error);
                document.querySelector('#jugadoresTable tbody').innerHTML = 
                    '<tr><td colspan="5" class="error-message">Error cargando jugadores</td></tr>';
            }
        }

        async function cargarEstadisticas() {
            try {
                const response = await fetch('/api/estadisticas-ofensivas');
                if (response.ok) {
                    estadisticas = await response.json();
                    console.log(`✅ ${estadisticas.length} estadísticas ofensivas cargadas desde la DB.`);
                } else {
                    throw new Error('Error cargando estadísticas ofensivas');
                }
                actualizarTablaEstadisticas();
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                estadisticas = [];
                actualizarTablaEstadisticas(); // Llama para mostrar el error
            }
        }
        
        // ========== FUNCIONES DE CÁLCULOS AVANZADOS MLB ==========

        function calcularOBP(hits, walks, atBats) {
            const totalBases = hits + walks;
            return atBats > 0 ? totalBases / (atBats + walks) : 0;
        }

        function calcularSLG(hits, homeRuns, atBats) {
            const totalBases = hits + (homeRuns * 3);
            return atBats > 0 ? totalBases / atBats : 0;
        }

        function calcularOPS(obp, slg) {
            return obp + slg;
        }

        function calcularWAR(jugador, stats) {
            if (!stats || !jugador || stats.at_bats < 10) return 0;
            const avg = stats.at_bats > 0 ? (stats.hits / stats.at_bats) : 0;
            const obp = calcularOBP(stats.hits, stats.walks || 0, stats.at_bats);
            const slg = calcularSLG(stats.hits, stats.home_runs, stats.at_bats);
            const ops = calcularOPS(obp, slg);
            const bateoCont = (ops - 0.700) * 100;
            const ajustePosicional = AJUSTES_POSICIONALES[jugador.posicion] || 0;
            const penalizacionErrores = 0; 
            const bonusVelocidad = (stats.stolen_bases || 0) * 0.2;
            const warTotal = (bateoCont + ajustePosicional + penalizacionErrores + bonusVelocidad) / 100;
            return Math.max(warTotal, -2.0);
        }

        // ========== FUNCIONES DE ACTUALIZACIÓN DE TABLAS ==========

        function actualizarTablaEquipos() {
            const tbody = document.querySelector('#equiposTable tbody');
            
            if (equipos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No hay equipos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = equipos.map(equipo => `
                <tr>
                    <td>${equipo.id}</td>
                    <td><strong>${equipo.nombre}</strong></td>
                    <td>${equipo.manager}</td>
                    <td>${equipo.ciudad}</td>
                    <td>${new Date(equipo.fecha_creacion).toLocaleDateString('es-AR')}</td>
                    <td>
                        <button class="btn-secondary" onclick="editarEquipo(${equipo.id})">✏️</button>
                        <button class="btn-secondary" onclick="eliminarEquipo(${equipo.id})" style="background: #dc143c;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        function actualizarTablaPartidos() {
            const tbody = document.querySelector('#partidosTable tbody');
            
            if (partidos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No hay partidos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = partidos.map(partido => {
                // === INICIO CAMBIO FASE 7.1: Mostrar partidos sin resultado ===
                let resultado = 'Pendiente';
                let ganadorHtml = `<small style="color: #ff8c00;">Pendiente</small>`;

                if (partido.carreras_local !== null && partido.carreras_visitante !== null) {
                    const ganador = partido.carreras_local > partido.carreras_visitante ? 
                        partido.equipo_local_nombre : partido.equipo_visitante_nombre;
                    resultado = `${partido.carreras_local} - ${partido.carreras_visitante}`;
                    ganadorHtml = `<small style="color: #4CAF50;">Ganó: ${ganador}</small>`;
                }
                // === FIN CAMBIO FASE 7.1 ===
                
                return `
                    <tr>
                        <td><strong>${partido.equipo_local_nombre}</strong></td>
                        <td><strong>${partido.equipo_visitante_nombre}</strong></td>
                        <td>
                            <strong>${resultado}</strong><br>
                            ${ganadorHtml}
                        </td>
                        <td>${partido.innings_jugados} inn</td>
                        <td>${new Date(partido.fecha_partido).toLocaleDateString('es-AR')}</td>
                        <td>
                            <button class="btn-secondary" onclick="editarPartido(${partido.id})">✏️</button>
                            <button class="btn-secondary" onclick="eliminarPartido(${partido.id})" style="background: #dc143c;">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function actualizarTablaJugadores() {
            const tbody = document.querySelector('#jugadoresTable tbody');
            
            if (jugadores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No hay jugadores registrados</td></tr>';
                return;
            }

            tbody.innerHTML = jugadores.map(jugador => `
                <tr>
                    <td>${jugador.numero || '-'}</td>
                    <td><strong>${jugador.nombre}</strong></td>
                    <td>${jugador.equipo_nombre}</td>
                    <td>${jugador.posicion}</td>
                    <td>
                        <button class="btn-secondary" onclick="editarJugador(${jugador.id})">✏️</button>
                        <button class="btn-secondary" onclick="eliminarJugador(${jugador.id})" style="background: #dc143c;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        function actualizarTablaEstadisticas() {
            const tbody = document.querySelector('#statsTable tbody');
            
            if (estadisticas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No hay estadísticas registradas</td></tr>';
                return;
            }

            tbody.innerHTML = estadisticas.map(stat => {
                const jugadorNombre = stat.jugador_nombre || 'Desconocido';
                const equipoNombre = stat.equipo_nombre || '-';
                const posicion = stat.posicion || '-';

                const avg = stat.at_bats > 0 ? (parseFloat(stat.hits) / parseFloat(stat.at_bats)).toFixed(3) : '.000';
                const obp = calcularOBP(parseFloat(stat.hits), parseFloat(stat.walks) || 0, parseFloat(stat.at_bats)).toFixed(3);
                const slg = calcularSLG(parseFloat(stat.hits), parseFloat(stat.home_runs), parseFloat(stat.at_bats)).toFixed(3);
                const ops = (parseFloat(obp) + parseFloat(slg)).toFixed(3);
                
                const jugador = { posicion: posicion }; 
                const war = calcularWAR(jugador, stat).toFixed(2);
                
                return `
                    <tr>
                        <td><strong>${jugadorNombre}</strong></td>
                        <td>${equipoNombre}</td>
                        <td>${posicion}</td>
                        <td>${stat.at_bats}</td>
                        <td>${stat.hits}</td>
                        <td><strong>${avg}</strong></td>
                        <td>${obp}</td>
                        <td><strong>${ops}</strong></td>
                        <td>${stat.home_runs}</td>
                        <td>${stat.rbi}</td>
                        <td><strong style="color: ${parseFloat(war) > 0 ? '#4CAF50' : '#dc143c'}">${war}</strong></td>
                    </tr>
                `;
            }).join('');
        }

        async function actualizarLideresPorPosicion() {
            const container = document.getElementById('positionLeadersGrid');
            if (!container) return;

            container.innerHTML = '<div class="loading">Cargando líderes defensivos...</div>';

            let defensiveStats = [];
            try {
                const response = await fetch('/api/lideres-defensivos');
                if (response.ok) {
                    defensiveStats = await response.json();
                } else {
                    throw new Error('Error al cargar estadísticas defensivas');
                }
            } catch (error) {
                console.error('Error cargando stats defensivas:', error);
                container.innerHTML = '<div class="error-message">Error al cargar estadísticas defensivas.</div>';
                return;
            }

            const posiciones = [
                { pos: 'C', nombre: '🥅 MEJOR CATCHER' },
                { pos: '1B', nombre: '🥇 MEJOR PRIMERA BASE' },
                { pos: '2B', nombre: '🥈 MEJOR SEGUNDA BASE' },
                { pos: '3B', nombre: '🥉 MEJOR TERCERA BASE' },
                { pos: 'SS', nombre: '⚡ MEJOR SHORTSTOP' },
                { pos: 'LF', nombre: '⬅️ MEJOR LEFT FIELD' },
                { pos: 'CF', nombre: '🎯 MEJOR CENTER FIELD' },
                { pos: 'RF', nombre: '➡️ MEJOR RIGHT FIELD' },
            ];

            container.innerHTML = posiciones.map(posicion => {
                
                const mejoresJugadores = defensiveStats
                    .filter(j => j.posicion === posicion.pos)
                    .sort((a, b) => {
                        const fldA = parseFloat(a.fielding_percentage) || 0;
                        const fldB = parseFloat(b.fielding_percentage) || 0;
                        if (fldB !== fldA) {
                            return fldB - fldA;
                        }
                        const chancesA = parseInt(a.total_chances) || 0;
                        const chancesB = parseInt(b.total_chances) || 0;
                        return chancesB - chancesA;
                    })
                    .slice(0, 5); 

                
                let leadersHTML;
                if (mejoresJugadores.length === 0) {
                    leadersHTML = `
                        <div class="position-leader" style="opacity: 0.5; text-align: center; padding: 10px;">
                            <div class="position-player">Sin jugadores con stats</div>
                            <div class="position-team">(Mínimo 5 chances)</div>
                            <div class="position-rating">-.---</div>
                        </div>
                    `;
                } else {
                    leadersHTML = mejoresJugadores.map((jugador, index) => {
                        const fld = parseFloat(jugador.fielding_percentage).toFixed(3);
                        const po = parseInt(jugador.putouts);
                        const a = parseInt(jugador.assists);
                        const e = parseInt(jugador.errors);

                        return `
                        <div class="position-leader-item">
                            <div class="position-player-container">
                                <div>
                                    <div class="position-player">${index + 1}. ${jugador.jugador_nombre}</div>
                                    <div class="position-team">${jugador.equipo_nombre}</div>
                                </div>
                                <div class="position-rating">FLD%: ${fld}</div>
                            </div>
                            <div class="war-stats" style="margin-top: 8px; padding: 8px;">
                                <div class="war-breakdown" style="gap: 5px;">
                                    <div class="war-component">
                                        <div class="war-component-title">PO</div>
                                        <div class="war-component-value">${po}</div>
                                    </div>
                                    <div class="war-component">
                                        <div class="war-component-title">A</div>
                                        <div class="war-component-value">${a}</div>
                                    </div>
                                    <div class="war-component">
                                        <div class="war-component-title">E</div>
                                        <div class="war-component-value">${e}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                }

                return `
                    <div class="position-card">
                        <div class="position-title">${posicion.nombre}</div>
                        <div class="position-leader">
                            ${leadersHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ========== INICIO LÓGICA FASE 6 (TOP 6 / 8 JUEGOS) ==========
        function calcularPosiciones() {
            const tbody = document.querySelector('#posicionesTable tbody');
            const PARTIDOS_TOTALES_TEMPORADA = 8; // ¡NUEVO! Total de juegos por equipo

            if (equipos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No hay equipos registrados</td></tr>';
                return;
            }
            if (partidos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No hay partidos para calcular posiciones</td></tr>';
                return;
            }

            // Calcular estadísticas por equipo
            const estadisticasEquipos = {};
            equipos.forEach(equipo => {
                estadisticasEquipos[equipo.id] = {
                    id: equipo.id,
                    nombre: equipo.nombre,
                    partidos_jugados: 0,
                    partidos_ganados: 0,
                    partidos_perdidos: 0,
                    carreras_favor: 0,
                    carreras_contra: 0
                };
            });

            partidos.forEach(partido => {
                const localId = partido.equipo_local_id;
                const visitanteId = partido.equipo_visitante_id;
                if (estadisticasEquipos[localId] && estadisticasEquipos[visitanteId]) {
                    
                    // === INICIO CAMBIO FASE 7.1: Contar todos los partidos para PJ (visual) ===
                    // Pero solo sumar PG/PP si hay resultado
                    estadisticasEquipos[localId].partidos_jugados++;
                    estadisticasEquipos[visitanteId].partidos_jugados++;
                    
                    if (partido.carreras_local !== null && partido.carreras_visitante !== null) {
                        estadisticasEquipos[localId].carreras_favor += partido.carreras_local;
                        estadisticasEquipos[localId].carreras_contra += partido.carreras_visitante;
                        estadisticasEquipos[visitanteId].carreras_favor += partido.carreras_visitante;
                        estadisticasEquipos[visitanteId].carreras_contra += partido.carreras_local;
                        
                        if (partido.carreras_local > partido.carreras_visitante) {
                            estadisticasEquipos[localId].partidos_ganados++;
                            estadisticasEquipos[visitanteId].partidos_perdidos++;
                        } else {
                            estadisticasEquipos[visitanteId].partidos_ganados++;
                            estadisticasEquipos[localId].partidos_perdidos++;
                        }
                    }
                    // === FIN CAMBIO FASE 7.1 ===
                }
            });

            // Convertir a array y ordenar
            const posiciones = Object.values(estadisticasEquipos)
                .map(stats => ({
                    ...stats,
                    // ¡NUEVO! PJ ahora cuenta solo los jugados con resultado
                    partidos_jugados_con_resultado: stats.partidos_ganados + stats.partidos_perdidos,
                    porcentaje: (stats.partidos_ganados + stats.partidos_perdidos) > 0 ? (stats.partidos_ganados / (stats.partidos_ganados + stats.partidos_perdidos)) : 0,
                    diferencia: stats.carreras_favor - stats.carreras_contra
                }))
                .sort((a, b) => {
                    if (b.porcentaje !== a.porcentaje) return b.porcentaje - a.porcentaje;
                    return b.diferencia - a.diferencia;
                });

            // ¡NUEVA LÓGICA DE CLASIFICACIÓN (TOP 6)!
            const equipoSexto = posiciones[5]; // Obtenemos al 6to lugar

            tbody.innerHTML = posiciones.map((equipo, index) => {
                const pos = index + 1;
                let estado = '';
                let estadoClass = '';
                const partidosJugados = equipo.partidos_jugados_con_resultado; // Usar la nueva variable

                if (pos <= 6) { // Clasifican 6
                    estado = 'CLASIFICADO';
                    estadoClass = 'style="background: linear-gradient(45deg, #4CAF50, #45a049); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;"';
                } else {
                    // Lógica de Eliminación (Número Mágico)
                    if (!equipoSexto || equipoSexto.partidos_jugados_con_resultado === 0) {
                        estado = 'EN LUCHA';
                        estadoClass = 'style="color: #ff8c00; font-size: 0.8rem; font-weight: bold;"';
                    } else {
                        const victoriasSexto = equipoSexto.partidos_ganados;
                        const derrotasEquipo = equipo.partidos_perdidos;
                        // (8 + 1) - Victorias del 6to - Derrotas del 7mo
                        const magicNumber = (PARTIDOS_TOTALES_TEMPORADA + 1) - victoriasSexto - derrotasEquipo;
                        const partidosRestantes = PARTIDOS_TOTALES_TEMPORADA - partidosJugados;

                        if (magicNumber <= 0 || magicNumber > partidosRestantes) {
                            estado = 'ELIMINADO';
                            estadoClass = 'style="color: #dc143c; font-size: 0.8rem; font-weight: bold;"';
                        } else {
                            estado = `EN LUCHA (M# ${magicNumber})`;
                            estadoClass = 'style="color: #ff8c00; font-size: 0.8rem; font-weight: bold;"';
                        }
                    }
                }

                return `
                    <tr>
                        <td>
                            <span style="display: inline-block; background: linear-gradient(45deg, #ffd700, #ff8c00); color: #1a1a2e; width: 25px; height: 25px; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; margin-right: 8px; font-size: 0.8rem;">
                                ${pos}
                            </span>
                        </td>
                        <td><strong>${equipo.nombre}</strong></td>
                        <td>${partidosJugados}</td> <td>${equipo.partidos_ganados}</td>
                        <td>${equipo.partidos_perdidos}</td>
                        <td><strong>${(equipo.porcentaje * 100).toFixed(1)}%</strong></td>
                        <td>${equipo.carreras_favor}</td>
                        <td>${equipo.carreras_contra}</td>
                        <td>${equipo.diferencia > 0 ? '+' : ''}${equipo.diferencia}</td>
                        <td><span ${estadoClass}>${estado}</span></td>
                    </tr>
                `;
            }).join('');
        }
        // ========== FIN LÓGICA FASE 6 ==========

        // ========== FUNCIONES DE LÍDERES Y ESTADÍSTICAS AVANZADAS ==========

        async function actualizarLideres() {
            let lideresOfensivos = [];
            try {
                const response = await fetch('/api/lideres-ofensivos');
                if (response.ok) {
                    lideresOfensivos = await response.json();
                } else {
                    throw new Error('Error cargando líderes ofensivos');
                }
            } catch (error) {
                console.error(error);
                mostrarLideresVacios('avgLeaders');
                mostrarLideresVacios('hrLeaders');
                mostrarLideresVacios('rbiLeaders');
                mostrarLideresVacios('opsLeaders');
                mostrarLideresVacios('warLeaders');
                mostrarLideresVacios('sbLeaders');
                return;
            }

            if (lideresOfensivos.length === 0) {
                mostrarLideresVacios('avgLeaders');
                mostrarLideresVacios('hrLeaders');
                mostrarLideresVacios('rbiLeaders');
                mostrarLideresVacios('opsLeaders');
                mostrarLideresVacios('warLeaders');
                mostrarLideresVacios('sbLeaders');
                return;
            }

            const avgLideres = [...lideresOfensivos].sort((a, b) => b.avg - a.avg).slice(0, 3);
            actualizarLideresHTML('avgLeaders', avgLideres, 'avg', true);

            const hrLideres = [...lideresOfensivos].sort((a, b) => b.home_runs - a.home_runs).slice(0, 3);
            actualizarLideresHTML('hrLeaders', hrLideres, 'home_runs');

            const rbiLideres = [...lideresOfensivos].sort((a, b) => b.rbi - a.rbi).slice(0, 3);
            actualizarLideresHTML('rbiLeaders', rbiLideres, 'rbi');

            const opsLideres = [...lideresOfensivos].sort((a, b) => b.ops - a.ops).slice(0, 3);
            actualizarLideresHTML('opsLeaders', opsLideres, 'ops', true);
            
            const sbLideres = [...lideresOfensivos].sort((a, b) => (b.stolen_bases || 0) - (a.stolen_bases || 0)).slice(0, 3);
            actualizarLideresHTML('sbLeaders', sbLideres, 'stolen_bases');

            const warLideres = lideresOfensivos.map(stat => {
                const jugador = { posicion: stat.posicion }; 
                return {
                    ...stat,
                    war: calcularWAR(jugador, stat)
                };
            })
            .sort((a, b) => b.war - a.war)
            .slice(0, 3);
            
            actualizarLideresHTML('warLeaders', warLideres, 'war', true);
        }

        function mostrarLideresVacios(containerId) {
             const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="leader-item">
                        <div>
                            <div class="leader-name">Sin datos suficientes</div>
                            <div class="leader-team">(Mínimo 10 AB)</div>
                        </div>
                        <div class="leader-stat">-</div>
                    </div>
                `;
            }
        }

        function actualizarLideresHTML(containerId, lideres, stat, isDecimal = false) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Contenedor no encontrado: ${containerId}`);
                return;
            }

            if (!lideres || lideres.length === 0) {
                let msg = "(Mínimo 10 AB)";
                if (containerId.includes('era') || containerId.includes('whip') || containerId.includes('wins') || containerId.includes('saves')) {
                    msg = "(Mínimo 5 IP)";
                } else if (containerId.includes('fielding')) {
                    msg = "(Mínimo 5 Chances)";
                }
                
                container.innerHTML = `
                    <div class="leader-item">
                        <div>
                            <div class="leader-name">Sin datos suficientes</div>
                            <div class="leader-team">${msg}</div>
                        </div>
                        <div class="leader-stat">-</div>
                    </div>
                `;
                return;
            }

            const medals = ['gold-medal', 'silver-medal', 'bronze-medal'];
            const medalIcons = ['🥇', '🥈', '🥉'];

            container.innerHTML = lideres.map((lider, index) => {
                let jugadorNombre, equipoNombre, valor;
                
                if (lider.jugador_nombre) {
                    jugadorNombre = lider.jugador_nombre;
                    equipoNombre = lider.equipo_nombre;
                } else {
                    const jugador = jugadores.find(j => j.id === lider.jugador_id);
                    jugadorNombre = jugador ? jugador.nombre : 'Desconocido';
                    equipoNombre = jugador ? jugador.equipo_nombre : '-';
                }
                
                let statValue = lider[stat];
                if (typeof statValue === 'string') {
                    statValue = parseFloat(statValue);
                }

                if (isDecimal) {
                    valor = statValue ? statValue.toFixed(3) : '0.000';
                    if (stat === 'war' || stat === 'era' || stat === 'whip') {
                        valor = statValue.toFixed(2);
                    }
                } else {
                    valor = statValue || 0;
                }
                
                const medalClass = medals[index] || '';
                const medalIcon = medalIcons[index] || '🏅';

                return `
                    <div class="leader-item">
                        <div>
                            <div class="leader-name ${medalClass}">${medalIcon} ${jugadorNombre}</div>
                            <div class="leader-team">${equipoNombre}</div>
                        </div>
                        <div class="leader-stat">${valor}</div>
                    </div>
                `;
            }).join('');
        }

        // ========== ACTUALIZAR SELECTORES ==========

        function actualizarSelectores() {
            const selectores = ['equipoLocal', 'equipoVisitante', 'equipoJugador'];
            
            selectores.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                if (select) {
                    select.innerHTML = '<option value="">Seleccionar equipo...</option>';
                    
                    equipos.forEach(equipo => {
                        const option = document.createElement('option');
                        option.value = equipo.id;
                        option.textContent = equipo.nombre;
                        select.appendChild(option);
                    });
                }
            });

            // Actualizar selector de jugadores para estadísticas
            const jugadorStatsSelect = document.getElementById('jugadorStats');
            if (jugadorStatsSelect) {
                jugadorStatsSelect.innerHTML = '<option value="">Seleccionar jugador...</option>';
                
                jugadores.forEach(jugador => {
                    const option = document.createElement('option');
                    option.value = jugador.id;
                    option.textContent = `${jugador.nombre} (${jugador.equipo_nombre} - ${jugador.posicion})`;
                    jugadorStatsSelect.appendChild(option);
                });
            }
            // Actualizar selectores para nuevos formularios
            const pitcheoSelect = document.getElementById('jugadorPitcheo');
            const defensivaSelect = document.getElementById('jugadorDefensivo');

            if (pitcheoSelect) {
                pitcheoSelect.innerHTML = '<option value="">Seleccionar jugador...</option>';
                jugadores.filter(j => j.posicion === 'P').forEach(jugador => {
                    pitcheoSelect.innerHTML += `<option value="${jugador.id}">${jugador.nombre} (${jugador.equipo_nombre})</option>`;
                });
            }

            if (defensivaSelect) {
                defensivaSelect.innerHTML = '<option value="">Seleccionar jugador...</option>';
                jugadores.forEach(jugador => {
                    defensivaSelect.innerHTML += `<option value="${jugador.id}">${jugador.nombre} (${jugador.equipo_nombre} - ${jugador.posicion})</option>`;
                });
            }
        }

        // ========== FUNCIONES PARA AGREGAR DATOS ==========

        async function agregarEquipo() {
            const nombre = document.getElementById('nombreEquipo').value.trim();
            const manager = document.getElementById('managerEquipo').value.trim();
            const ciudad = document.getElementById('ciudadEquipo').value.trim();

            if (!nombre || !manager || !ciudad) {
                mostrarError('equipoError', 'Por favor completa todos los campos');
                return;
            }

            try {
                const response = await fetch('/api/equipos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ nombre, manager, ciudad })
                });

                if (response.ok) {
                    const nuevoEquipo = await response.json();
                    equipos.push(nuevoEquipo);
                    
                    document.getElementById('nombreEquipo').value = '';
                    document.getElementById('managerEquipo').value = '';
                    document.getElementById('ciudadEquipo').value = '';
                    
                    mostrarExito('equipoMessage', `✅ Equipo "${nombre}" agregado correctamente`);
                    actualizarTablaEquipos();
                    actualizarSelectores();
                } else {
                    const errorData = await response.json();
                    mostrarError('equipoError', errorData.error || 'Error al agregar equipo');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('equipoError', 'Error de conexión al servidor');
            }
        }

        async function registrarPartido() {
            const equipoLocal = document.getElementById('equipoLocal').value;
            const equipoVisitante = document.getElementById('equipoVisitante').value;
            const carrerasLocal = parseInt(document.getElementById('carrerasLocal').value);
            const carrerasVisitante = parseInt(document.getElementById('carrerasVisitante').value);
            const inningsJugados = parseInt(document.getElementById('inningsJugados').value);
            const fechaPartido = document.getElementById('fechaPartido').value;

            // === INICIO CAMBIO FASE 7.1: Validación de carreras ===
            // Ya no son obligatorias, pero si se pone una, se debe poner la otra.
            if (!equipoLocal || !equipoVisitante || !fechaPartido) {
                mostrarError('partidoError', 'Equipo local, visitante y fecha son obligatorios.');
                return;
            }

            if ((!isNaN(carrerasLocal) && isNaN(carrerasVisitante)) || (isNaN(carrerasLocal) && !isNaN(carrerasVisitante))) {
                 mostrarError('partidoError', 'Si registras carreras, debes registrar tanto local como visitante.');
                return;
            }
            // === FIN CAMBIO FASE 7.1 ===

            if (equipoLocal === equipoVisitante) {
                mostrarError('partidoError', 'Los equipos local y visitante deben ser diferentes');
                return;
            }

            try {
                const response = await fetch('/api/partidos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        equipo_local_id: equipoLocal,
                        equipo_visitante_id: equipoVisitante,
                        // === INICIO CAMBIO FASE 7.1: Enviar null si está vacío ===
                        carreras_local: isNaN(carrerasLocal) ? null : carrerasLocal,
                        carreras_visitante: isNaN(carrerasVisitante) ? null : carrerasVisitante,
                        // === FIN CAMBIO FASE 7.1 ===
                        innings_jugados: inningsJugados,
                        fecha_partido: fechaPartido
                    })
                });

                if (response.ok) {
                    document.getElementById('equipoLocal').value = '';
                    document.getElementById('equipoVisitante').value = '';
                    document.getElementById('carrerasLocal').value = '';
                    document.getElementById('carrerasVisitante').value = '';
                    document.getElementById('inningsJugados').value = '9';
                    
                    mostrarExito('partidoMessage', `✅ Partido registrado correctamente`);
                    
                    await cargarPartidos();
                    calcularPosiciones();
                } else {
                    const errorData = await response.json();
                    mostrarError('partidoError', errorData.error || 'Error al registrar partido');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('partidoError', 'Error de conexión al servidor');
            }
        }

        async function agregarJugador() {
            const nombre = document.getElementById('nombreJugador').value.trim();
            const equipoId = document.getElementById('equipoJugador').value;
            const posicion = document.getElementById('posicionJugador').value;
            const numero = document.getElementById('numeroJugador').value;

            if (!nombre || !equipoId || !posicion) {
                mostrarError('jugadorError', 'Por favor completa todos los campos obligatorios');
                return;
            }

            try {
                const response = await fetch('/api/jugadores', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nombre,
                        equipo_id: equipoId,
                        posicion,
                        numero: numero || null
                    })
                });

                if (response.ok) {
                    const nuevoJugador = await response.json();
                    
                    document.getElementById('nombreJugador').value = '';
                    document.getElementById('equipoJugador').value = '';
                    document.getElementById('posicionJugador').value = '';
                    document.getElementById('numeroJugador').value = '';
                    
                    mostrarExito('jugadorMessage', `✅ Jugador "${nombre}" agregado correctamente`);
                    await cargarJugadores();
                    actualizarSelectores();
                } else {
                    const errorData = await response.json();
                    mostrarError('jugadorError', errorData.error || 'Error al agregar jugador');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('jugadorError', 'Error de conexión al servidor');
            }
        }

        async function registrarEstadisticas() {
            // *** INICIO FASE 5.5: Validar torneo activo ***
            if (!torneoActivo.id) {
                mostrarError('statsError', 'Error: No hay ningún torneo activo. Ve a la pestaña "Torneos" y activa uno.');
                return;
            }
            // *** FIN FASE 5.5 ***

            const jugadorId = parseInt(document.getElementById('jugadorStats').value);
            const atBats = parseInt(document.getElementById('atBats').value) || 0;
            const hits = parseInt(document.getElementById('hits').value) || 0;
            const homeRuns = parseInt(document.getElementById('homeRuns').value) || 0;
            const rbi = parseInt(document.getElementById('rbi').value) || 0;
            const runs = parseInt(document.getElementById('runs').value) || 0;
            const walks = parseInt(document.getElementById('walks').value) || 0;
            const stolenBases = parseInt(document.getElementById('stolenBases').value) || 0;

            if (!jugadorId) {
                mostrarError('statsError', 'Por favor selecciona un jugador');
                return;
            }

            if (hits > atBats) {
                mostrarError('statsError', 'Los hits no pueden ser mayores que los at-bats');
                return;
            }

            try {
                const response = await fetch('/api/estadisticas-ofensivas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jugador_id: jugadorId,
                        at_bats: atBats,
                        hits: hits,
                        home_runs: homeRuns,
                        rbi: rbi,
                        runs: runs,
                        walks: walks,
                        stolen_bases: stolenBases,
                        temporada: torneoActivo.nombre 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error del servidor');
                }
                
                limpiarFormulario('ofensiva');

                const jugador = jugadores.find(j => j.id === jugadorId);
                mostrarExito('statsMessage', `✅ Estadísticas de "${jugador ? jugador.nombre : 'Jugador'}" guardadas en la base de datos.`);
                
                await cargarEstadisticas();
                actualizarLideres();
                actualizarLideresPorPosicion();
                cargarTablaEditarBateo();

            } catch (error) {
                console.error('Error:', error);
                mostrarError('statsError', `Error al registrar estadísticas: ${error.message}`);
            }
        }


        // ========== FUNCIONES DE UTILIDAD ==========

        function mostrarExito(elementId, mensaje) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = mensaje;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 4000);
            }
        }

        function mostrarError(elementId, mensaje) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = mensaje;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

// ========== FUNCIONES DE EDICIÓN Y ELIMINACIÓN ==========

// ========== EQUIPOS ==========
async function editarEquipo(id) {
    try {
        const response = await fetch(`/api/equipos/${id}`);
        if (!response.ok) throw new Error('Error obteniendo datos del equipo');
        
        const equipo = await response.json();
        
        document.getElementById('nombreEquipo').value = equipo.nombre;
        document.getElementById('managerEquipo').value = equipo.manager;
        document.getElementById('ciudadEquipo').value = equipo.ciudad;
        
        const btnAgregar = document.querySelector('.btn-primary[onclick="agregarEquipo()"]');
        btnAgregar.textContent = '✏️ Actualizar Equipo';
        btnAgregar.setAttribute('onclick', `actualizarEquipo(${id})`);
        
        mostrarExito('equipoMessage', `Editando equipo "${equipo.nombre}". Modifica los campos y presiona "Actualizar Equipo".`);
        document.getElementById('nombreEquipo').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('nombreEquipo').focus();
    } catch (error) {
        console.error('Error:', error);
        mostrarError('equipoError', 'Error cargando datos del equipo para editar');
    }
}

async function actualizarEquipo(id) {
    const nombre = document.getElementById('nombreEquipo').value.trim();
    const manager = document.getElementById('managerEquipo').value.trim();
    const ciudad = document.getElementById('ciudadEquipo').value.trim();

    if (!nombre || !manager || !ciudad) {
        mostrarError('equipoError', 'Por favor completa todos los campos');
        return;
    }

    try {
        const response = await fetch(`/api/equipos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, manager, ciudad })
        });

        if (response.ok) {
            const equipoActualizado = await response.json();
            
            document.getElementById('nombreEquipo').value = '';
            document.getElementById('managerEquipo').value = '';
            document.getElementById('ciudadEquipo').value = '';
            
            const btnActualizar = document.querySelector('.btn-primary[onclick*="actualizarEquipo"]');
            btnActualizar.textContent = '🏆 Agregar Equipo';
            btnActualizar.setAttribute('onclick', 'agregarEquipo()');
            
            mostrarExito('equipoMessage', `✅ Equipo "${equipoActualizado.nombre}" actualizado correctamente`);
            
            await cargarEquipos();
            actualizarSelectores();
            calcularPosiciones();
        } else {
            const errorData = await response.json();
            mostrarError('equipoError', errorData.error || 'Error al actualizar equipo');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('equipoError', 'Error de conexión al servidor');
    }
}

async function eliminarEquipo(id) {
    try {
        const response = await fetch(`/api/equipos/${id}`);
        const equipo = await response.json();
        
        if (confirm(`¿Estás seguro de eliminar el equipo "${equipo.nombre}"?\n\n⚠️ Esta acción eliminará todos los jugadores y partidos relacionados.`)) {
            const deleteResponse = await fetch(`/api/equipos/${id}`, { method: 'DELETE' });

            if (deleteResponse.ok) {
                mostrarExito('equipoMessage', `✅ Equipo "${equipo.nombre}" eliminado correctamente`);
                await cargarEquipos();
                await cargarJugadores();
                await cargarPartidos();
                actualizarSelectores();
                calcularPosiciones();
            } else {
                const errorData = await deleteResponse.json();
                mostrarError('equipoError', errorData.error || 'Error al eliminar equipo');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('equipoError', 'Error de conexión al servidor');
    }
}

// ========== JUGADORES ==========
async function editarJugador(id) {
    try {
        const response = await fetch(`/api/jugadores/${id}`);
        if (!response.ok) throw new Error('Error obteniendo datos del jugador');
        
        const jugador = await response.json();
        
        document.getElementById('nombreJugador').value = jugador.nombre;
        document.getElementById('equipoJugador').value = jugador.equipo_id;
        document.getElementById('posicionJugador').value = jugador.posicion;
        document.getElementById('numeroJugador').value = jugador.numero || '';
        
        const btnAgregar = document.querySelector('.btn-primary[onclick="agregarJugador()"]');
        btnAgregar.textContent = '✏️ Actualizar Jugador';
        btnAgregar.setAttribute('onclick', `actualizarJugador(${id})`);
        
        mostrarExito('jugadorMessage', `Editando jugador "${jugador.nombre}". Modifica los campos y presiona "Actualizar Jugador".`);
        document.getElementById('nombreJugador').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('nombreJugador').focus();
    } catch (error) {
        console.error('Error:', error);
        mostrarError('jugadorError', 'Error cargando datos del jugador para editar');
    }
}

async function actualizarJugador(id) {
    const nombre = document.getElementById('nombreJugador').value.trim();
    const equipoId = document.getElementById('equipoJugador').value;
    const posicion = document.getElementById('posicionJugador').value;
    const numero = document.getElementById('numeroJugador').value;

    if (!nombre || !equipoId || !posicion) {
        mostrarError('jugadorError', 'Por favor completa todos los campos obligatorios');
        return;
    }

    try {
        const response = await fetch(`/api/jugadores/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, equipo_id: equipoId, posicion, numero: numero || null })
        });

        if (response.ok) {
            const jugadorActualizado = await response.json();
            
            document.getElementById('nombreJugador').value = '';
            document.getElementById('equipoJugador').value = '';
            document.getElementById('posicionJugador').value = '';
            document.getElementById('numeroJugador').value = '';
            
            const btnActualizar = document.querySelector('.btn-primary[onclick*="actualizarJugador"]');
            btnActualizar.textContent = '👤 Agregar Jugador';
            btnActualizar.setAttribute('onclick', 'agregarJugador()');
            
            mostrarExito('jugadorMessage', `✅ Jugador "${jugadorActualizado.nombre}" actualizado correctamente`);
            
            await cargarJugadores();
            actualizarSelectores();
        } else {
            const errorData = await response.json();
            mostrarError('jugadorError', errorData.error || 'Error al actualizar jugador');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('jugadorError', 'Error de conexión al servidor');
    }
}

async function eliminarJugador(id) {
    try {
        const response = await fetch(`/api/jugadores/${id}`);
        const jugador = await response.json();
        
        if (confirm(`¿Estás seguro de eliminar al jugador "${jugador.nombre}" del equipo "${jugador.equipo_nombre}"?`)) {
            const deleteResponse = await fetch(`/api/jugadores/${id}`, { method: 'DELETE' });

            if (deleteResponse.ok) {
                mostrarExito('jugadorMessage', `✅ Jugador "${jugador.nombre}" eliminado correctamente`);
                await cargarJugadores();
                actualizarSelectores();
                actualizarLideres();
                actualizarLideresPorPosicion();
            } else {
                const errorData = await deleteResponse.json();
                mostrarError('jugadorError', errorData.error || 'Error al eliminar jugador');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('jugadorError', 'Error de conexión al servidor');
    }
}

// ========== PARTIDOS ==========
async function editarPartido(id) {
    try {
        const response = await fetch(`/api/partidos/${id}`);
        if (!response.ok) throw new Error('Error obteniendo datos del partido');
        
        const partido = await response.json();
        
        document.getElementById('equipoLocal').value = partido.equipo_local_id;
        document.getElementById('equipoVisitante').value = partido.equipo_visitante_id;
        // === INICIO CAMBIO FASE 7.1: Mostrar 'null' como vacío ===
        document.getElementById('carrerasLocal').value = partido.carreras_local || '';
        document.getElementById('carrerasVisitante').value = partido.carreras_visitante || '';
        // === FIN CAMBIO FASE 7.1 ===
        document.getElementById('inningsJugados').value = partido.innings_jugados;
        document.getElementById('fechaPartido').value = partido.fecha_partido.split('T')[0];
        
        const btnAgregar = document.querySelector('.btn-primary[onclick="registrarPartido()"]');
        btnAgregar.textContent = '✏️ Actualizar Partido';
        btnAgregar.setAttribute('onclick', `actualizarPartido(${id})`);
        
        mostrarExito('partidoMessage', `Editando partido entre "${partido.equipo_local_nombre}" vs "${partido.equipo_visitante_nombre}".`);
        document.getElementById('equipoLocal').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('equipoLocal').focus();
    } catch (error) {
        console.error('Error:', error);
        mostrarError('partidoError', 'Error cargando datos del partido para editar');
    }
}

async function actualizarPartido(id) {
    const equipoLocal = document.getElementById('equipoLocal').value;
    const equipoVisitante = document.getElementById('equipoVisitante').value;
    const carrerasLocal = parseInt(document.getElementById('carrerasLocal').value);
    const carrerasVisitante = parseInt(document.getElementById('carrerasVisitante').value);
    const inningsJugados = parseInt(document.getElementById('inningsJugados').value);
    const fechaPartido = document.getElementById('fechaPartido').value;

    // === INICIO CAMBIO FASE 7.1: Validación de carreras ===
    if (!equipoLocal || !equipoVisitante || !fechaPartido) {
        mostrarError('partidoError', 'Equipo local, visitante y fecha son obligatorios.');
        return;
    }
    if ((!isNaN(carrerasLocal) && isNaN(carrerasVisitante)) || (isNaN(carrerasLocal) && !isNaN(carrerasVisitante))) {
         mostrarError('partidoError', 'Si registras carreras, debes registrar tanto local como visitante.');
        return;
    }
    // === FIN CAMBIO FASE 7.1 ===

    if (equipoLocal === equipoVisitante) {
        mostrarError('partidoError', 'Los equipos local y visitante deben ser diferentes');
        return;
    }

    try {
        const response = await fetch(`/api/partidos/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                equipo_local_id: equipoLocal,
                equipo_visitante_id: equipoVisitante,
                // === INICIO CAMBIO FASE 7.1: Enviar null si está vacío ===
                carreras_local: isNaN(carrerasLocal) ? null : carrerasLocal,
                carreras_visitante: isNaN(carrerasVisitante) ? null : carrerasVisitante,
                // === FIN CAMBIO FASE 7.1 ===
                innings_jugados: inningsJugados,
                fecha_partido: fechaPartido
            })
        });

        if (response.ok) {
            document.getElementById('equipoLocal').value = '';
            document.getElementById('equipoVisitante').value = '';
            document.getElementById('carrerasLocal').value = '';
            document.getElementById('carrerasVisitante').value = '';
            document.getElementById('inningsJugados').value = '9';
            
            const btnActualizar = document.querySelector('.btn-primary[onclick*="actualizarPartido"]');
            btnActualizar.textContent = '🎯 Registrar Partido';
            btnActualizar.setAttribute('onclick', 'registrarPartido()');
            
            mostrarExito('partidoMessage', `✅ Partido actualizado correctamente`);
            
            await cargarPartidos();
            calcularPosiciones();
        } else {
            const errorData = await response.json();
            mostrarError('partidoError', errorData.error || 'Error al actualizar partido');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('partidoError', 'Error de conexión al servidor');
    }
}

async function eliminarPartido(id) {
    try {
        const response = await fetch(`/api/partidos/${id}`);
        const partido = await response.json();
        
        let resultado = 'Pendiente';
        if (partido.carreras_local !== null && partido.carreras_visitante !== null) {
            resultado = `${partido.carreras_local} - ${partido.carreras_visitante}`;
        }

        if (confirm(`¿Estás seguro de eliminar el partido?\n\n"${partido.equipo_local_nombre}" vs "${partido.equipo_visitante_nombre}"\nResultado: ${resultado}\nFecha: ${new Date(partido.fecha_partido).toLocaleDateString('es-AR')}`)) {
            const deleteResponse = await fetch(`/api/partidos/${id}`, { method: 'DELETE' });

            if (deleteResponse.ok) {
                mostrarExito('partidoMessage', `✅ Partido eliminado correctamente`);
                await cargarPartidos();
                calcularPosiciones();
            } else {
                const errorData = await deleteResponse.json();
                mostrarError('partidoError', errorData.error || 'Error al eliminar partido');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarError('partidoError', 'Error de conexión al servidor');
    }
}

   // FUNCIONES PARA ESTADÍSTICAS DE PITCHEO
        async function registrarEstadisticasPitcheo() {
            if (!torneoActivo.id) {
                mostrarError('pitcheoError', 'Error: No hay ningún torneo activo. Ve a la pestaña "Torneos" y activa uno.');
                return;
            }

            const jugadorId = parseInt(document.getElementById('jugadorPitcheo').value);
            const inningsPitched = parseFloat(document.getElementById('inningsPitched').value) || 0;
            const hitsAllowed = parseInt(document.getElementById('hitsAllowed').value) || 0;
            const earnedRuns = parseInt(document.getElementById('earnedRuns').value) || 0;
            const strikeouts = parseInt(document.getElementById('strikeouts').value) || 0;
            const walksAllowed = parseInt(document.getElementById('walksAllowed').value) || 0;
            const homeRunsAllowed = parseInt(document.getElementById('homeRunsAllowed').value) || 0;
            const wins = parseInt(document.getElementById('wins').value) || 0;
            const losses = parseInt(document.getElementById('losses').value) || 0;
            const saves = parseInt(document.getElementById('saves').value) || 0;

            if (!jugadorId) {
                mostrarError('pitcheoError', 'Por favor selecciona un jugador');
                return;
            }

            try {
                const response = await fetch('/api/estadisticas-pitcheo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jugador_id: jugadorId,
                        innings_pitched: inningsPitched,
                        hits_allowed: hitsAllowed,
                        earned_runs: earnedRuns,
                        strikeouts: strikeouts,
                        walks_allowed: walksAllowed,
                        home_runs_allowed: homeRunsAllowed,
                        wins: wins,
                        losses: losses,
                        saves: saves,
                        temporada: torneoActivo.nombre 
                    })
                });

                if (response.ok) {
                    limpiarFormulario('pitcheo');
                    mostrarExito('pitcheoMessage', `✅ Estadísticas de pitcheo registradas correctamente`);
                    cargarTablaEditarPitcheo(); 
                } else {
                    const errorData = await response.json();
                    mostrarError('pitcheoError', errorData.error || 'Error al registrar estadísticas');
                }
            } catch (error) {
                mostrarError('pitcheoError', 'Error de conexión al servidor');
            }
        }

        // FUNCIONES PARA ESTADÍSTICAS DEFENSIVAS
        async function registrarEstadisticasDefensivas() {
            if (!torneoActivo.id) {
                mostrarError('defensivaError', 'Error: No hay ningún torneo activo. Ve a la pestaña "Torneos" y activa uno.');
                return;
            }
            
            const jugadorId = parseInt(document.getElementById('jugadorDefensivo').value);
            const putouts = parseInt(document.getElementById('putouts').value) || 0;
            const assists = parseInt(document.getElementById('assists').value) || 0;
            const errors = parseInt(document.getElementById('defensiveErrors').value) || 0;
            const doublePlays = parseInt(document.getElementById('doublePlays').value) || 0;
            const passedBalls = parseInt(document.getElementById('passedBalls').value) || 0;

            if (!jugadorId) {
                mostrarError('defensivaError', 'Por favor selecciona un jugador');
                return;
            }

            try {
                const response = await fetch('/api/estadisticas-defensivas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jugador_id: jugadorId,
                        putouts: putouts,
                        assists: assists,
                        errors: errors,
                        double_plays: doublePlays,
                        passed_balls: passedBalls,
                        chances: putouts + assists + errors,
                        temporada: torneoActivo.nombre 
                    })
                });

                if (response.ok) {
                    limpiarFormulario('defensiva');
                    mostrarExito('defensivaMessage', `✅ Estadísticas defensivas registradas correctamente`);
                    actualizarLideresPorPosicion();
                    cargarTablaEditarDefensa(); 
                } else {
                    const errorData = await response.json();
                    mostrarError('defensivaError', errorData.error || 'Error al registrar estadísticas');
                }
            } catch (error) {
                mostrarError('defensivaError', 'Error de conexión al servidor');
            }
        }

        // *** INICIO DE FUNCIONES DE EDICIÓN (FASE 4) ***
        async function cargarTablaEditarBateo() {
            const tbody = document.querySelector('#tablaEditarBateo tbody');
            try {
                const response = await fetch('/api/estadisticas-ofensivas');
                if (!response.ok) throw new Error('Error al cargar');
                const stats = await response.json();
                
                if (stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No hay estadísticas de bateo registradas.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = stats.map(stat => `
                    <tr>
                        <td>${stat.jugador_nombre}</td>
                        <td>${stat.equipo_nombre}</td>
                        <td>${stat.at_bats}</td>
                        <td>${stat.hits}</td>
                        <td>${stat.home_runs}</td>
                        <td>${stat.rbi}</td>
                        <td><button class="btn-secondary btn-edit" onclick="cargarParaEditar('ofensiva', ${stat.jugador_id})">✏️ Editar</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" class="error-message">${error.message}</td></tr>`;
            }
        }
        
        async function cargarTablaEditarPitcheo() {
            const tbody = document.querySelector('#tablaEditarPitcheo tbody');
             try {
                const response = await fetch('/api/estadisticas-pitcheo');
                if (!response.ok) throw new Error('Error al cargar');
                const stats = await response.json();
                
                if (stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No hay estadísticas de pitcheo registradas.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = stats.map(stat => `
                    <tr>
                        <td>${stat.jugador_nombre}</td>
                        <td>${stat.equipo_nombre}</td>
                        <td>${stat.innings_pitched}</td>
                        <td>${stat.earned_runs}</td>
                        <td>${stat.wins}</td>
                        <td>${stat.losses}</td>
                        <td>${stat.saves}</td>
                        <td><button class="btn-secondary btn-edit" onclick="cargarParaEditar('pitcheo', ${stat.jugador_id})">✏️ Editar</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="8" class="error-message">${error.message}</td></tr>`;
            }
        }
        
        async function cargarTablaEditarDefensa() {
            const tbody = document.querySelector('#tablaEditarDefensa tbody');
             try {
                const response = await fetch('/api/estadisticas-defensivas');
                if (!response.ok) throw new Error('Error al cargar');
                const stats = await response.json();
                
                if (stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No hay estadísticas defensivas registradas.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = stats.map(stat => `
                    <tr>
                        <td>${stat.jugador_nombre}</td>
                        <td>${stat.equipo_nombre}</td>
                        <td>${stat.putouts}</td>
                        <td>${stat.assists}</td>
                        <td>${stat.errors}</td>
                        <td>${stat.double_plays}</td>
                        <td><button class="btn-secondary btn-edit" onclick="cargarParaEditar('defensiva', ${stat.jugador_id})">✏️ Editar</button></td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" class="error-message">${error.message}</td></tr>`;
            }
        }
        
        // *** INICIO DE CORRECCIÓN: Lógica para Paso 4.3 ***
        
        // Función para limpiar formularios
        function limpiarFormulario(tipo) {
            if (tipo === 'ofensiva') {
                document.getElementById('jugadorStats').value = '';
                document.getElementById('atBats').value = '0';
                document.getElementById('hits').value = '0';
                document.getElementById('homeRuns').value = '0';
                document.getElementById('rbi').value = '0';
                document.getElementById('runs').value = '0';
                document.getElementById('walks').value = '0';
                document.getElementById('stolenBases').value = '0';
            } else if (tipo === 'pitcheo') {
                document.getElementById('jugadorPitcheo').value = '';
                document.getElementById('inningsPitched').value = '0';
                document.getElementById('hitsAllowed').value = '0';
                document.getElementById('earnedRuns').value = '0';
                document.getElementById('strikeouts').value = '0';
                document.getElementById('walksAllowed').value = '0';
                document.getElementById('homeRunsAllowed').value = '0';
                document.getElementById('wins').value = '0';
                document.getElementById('losses').value = '0';
                document.getElementById('saves').value = '0';
            } else if (tipo === 'defensiva') {
                document.getElementById('jugadorDefensivo').value = '';
                document.getElementById('putouts').value = '0';
                document.getElementById('assists').value = '0';
                document.getElementById('defensiveErrors').value = '0';
                document.getElementById('doublePlays').value = '0';
                document.getElementById('passedBalls').value = '0';
            }
        }

        // Función para resetear el botón de registro/actualización
        function resetearBoton(tipo) {
            if (tipo === 'ofensiva') {
                const btn = document.getElementById('btnRegistrarOfensiva');
                btn.textContent = '📊 Registrar Estadísticas (Sumar)';
                btn.classList.remove('btn-actualizar');
                btn.setAttribute('onclick', 'registrarEstadisticas()');
            } else if (tipo === 'pitcheo') {
                const btn = document.getElementById('btnRegistrarPitcheo');
                btn.textContent = '⚾ Registrar Estadísticas (Sumar)';
                btn.classList.remove('btn-actualizar');
                btn.setAttribute('onclick', 'registrarEstadisticasPitcheo()');
            } else if (tipo === 'defensiva') {
                const btn = document.getElementById('btnRegistrarDefensa');
                btn.textContent = '🛡 Registrar Estadísticas (Sumar)';
                btn.classList.remove('btn-actualizar');
                btn.setAttribute('onclick', 'registrarEstadisticasDefensivas()');
            }
        }

        // Cargar datos en el formulario para editar
        async function cargarParaEditar(tipo, jugadorId) {
            resetearBoton('ofensiva');
            resetearBoton('pitcheo');
            resetearBoton('defensiva');

            try {
                let stat;
                let endpointTipo = tipo;
                
                if (tipo === 'defensiva' || tipo === 'ofensiva') {
                    endpointTipo = tipo + 's';
                }
                
                const res = await fetch(`/api/estadisticas-${endpointTipo}/${jugadorId}`);
                if (!res.ok) {
                    throw new Error(`Estadísticas no encontradas para el jugador (ID: ${jugadorId}). Regístralas primero.`);
                }
                stat = await res.json();


                if (tipo === 'ofensiva') {
                    document.getElementById('jugadorStats').value = stat.jugador_id;
                    document.getElementById('atBats').value = stat.at_bats;
                    document.getElementById('hits').value = stat.hits;
                    document.getElementById('homeRuns').value = stat.home_runs;
                    document.getElementById('rbi').value = stat.rbi;
                    document.getElementById('runs').value = stat.runs;
                    document.getElementById('walks').value = stat.walks;
                    document.getElementById('stolenBases').value = stat.stolen_bases;
                    
                    const btn = document.getElementById('btnRegistrarOfensiva');
                    btn.textContent = '✏️ Actualizar Estadísticas (Reemplazar)';
                    btn.classList.add('btn-actualizar');
                    btn.setAttribute('onclick', `actualizarEstadistica('ofensiva', ${stat.jugador_id})`);
                    
                    document.getElementById('btnRegistrarOfensiva').scrollIntoView({ behavior: 'smooth' });
                } else if (tipo === 'pitcheo') {
                    document.getElementById('jugadorPitcheo').value = stat.jugador_id;
                    document.getElementById('inningsPitched').value = stat.innings_pitched;
                    document.getElementById('hitsAllowed').value = stat.hits_allowed;
                    document.getElementById('earnedRuns').value = stat.earned_runs;
                    document.getElementById('strikeouts').value = stat.strikeouts;
                    document.getElementById('walksAllowed').value = stat.walks_allowed;
                    document.getElementById('homeRunsAllowed').value = stat.home_runs_allowed;
                    document.getElementById('wins').value = stat.wins;
                    document.getElementById('losses').value = stat.losses;
                    document.getElementById('saves').value = stat.saves;
                    
                    const btn = document.getElementById('btnRegistrarPitcheo');
                    btn.textContent = '✏️ Actualizar Estadísticas (Reemplazar)';
                    btn.classList.add('btn-actualizar');
                    btn.setAttribute('onclick', `actualizarEstadistica('pitcheo', ${stat.jugador_id})`);

                    document.getElementById('btnRegistrarPitcheo').scrollIntoView({ behavior: 'smooth' });
                } else if (tipo === 'defensiva') {
                    document.getElementById('jugadorDefensivo').value = stat.jugador_id;
                    document.getElementById('putouts').value = stat.putouts;
                    document.getElementById('assists').value = stat.assists;
                    document.getElementById('defensiveErrors').value = stat.errors;
                    document.getElementById('doublePlays').value = stat.double_plays;
                    document.getElementById('passedBalls').value = stat.passed_balls;
                    
                    const btn = document.getElementById('btnRegistrarDefensa');
                    btn.textContent = '✏️ Actualizar Estadísticas (Reemplazar)';
                    btn.classList.add('btn-actualizar');
                    btn.setAttribute('onclick', `actualizarEstadistica('defensiva', ${stat.jugador_id})`);
                    
                    document.getElementById('btnRegistrarDefensa').scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                mostrarError('statsError', `Error al cargar datos para editar: ${error.message}`);
            }
        }
        
        async function actualizarEstadistica(tipo, jugadorId) {
            let body = { jugador_id: jugadorId, temporada: torneoActivo.nombre }; 
            let errorId = 'statsError'; 
            let endpointTipo = tipo;
            
            try {
                if (tipo === 'ofensiva') {
                    body.at_bats = parseInt(document.getElementById('atBats').value) || 0;
                    body.hits = parseInt(document.getElementById('hits').value) || 0;
                    body.home_runs = parseInt(document.getElementById('homeRuns').value) || 0;
                    body.rbi = parseInt(document.getElementById('rbi').value) || 0;
                    body.runs = parseInt(document.getElementById('runs').value) || 0;
                    body.walks = parseInt(document.getElementById('walks').value) || 0;
                    body.stolen_bases = parseInt(document.getElementById('stolenBases').value) || 0;
                } else if (tipo === 'pitcheo') {
                    errorId = 'pitcheoError';
                    body.innings_pitched = parseFloat(document.getElementById('inningsPitched').value) || 0;
                    body.hits_allowed = parseInt(document.getElementById('hitsAllowed').value) || 0;
                    body.earned_runs = parseInt(document.getElementById('earnedRuns').value) || 0;
                    body.strikeouts = parseInt(document.getElementById('strikeouts').value) || 0;
                    body.walks_allowed = parseInt(document.getElementById('walksAllowed').value) || 0;
                    body.home_runs_allowed = parseInt(document.getElementById('homeRunsAllowed').value) || 0;
                    body.wins = parseInt(document.getElementById('wins').value) || 0;
                    body.losses = parseInt(document.getElementById('losses').value) || 0;
                    body.saves = parseInt(document.getElementById('saves').value) || 0;
                } else if (tipo === 'defensiva') {
                    errorId = 'defensivaError';
                    endpointTipo = 'defensivas'; 
                    body.putouts = parseInt(document.getElementById('putouts').value) || 0;
                    body.assists = parseInt(document.getElementById('assists').value) || 0;
                    body.errors = parseInt(document.getElementById('defensiveErrors').value) || 0;
                    body.double_plays = parseInt(document.getElementById('doublePlays').value) || 0;
                    body.passed_balls = parseInt(document.getElementById('passedBalls').value) || 0;
                    body.chances = body.putouts + body.assists + body.errors;
                }
                
                const response = await fetch(`/api/estadisticas-${endpointTipo}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error del servidor');
                }
                
                limpiarFormulario(tipo);
                resetearBoton(tipo);
                mostrarExito(errorId.replace('Error', 'Message'), '✅ Estadísticas actualizadas (reemplazadas) correctamente.');
                
                if (tipo === 'ofensiva') {
                    await cargarEstadisticas(); 
                    cargarTablaEditarBateo();
                    actualizarLideres();
                } else if (tipo === 'pitcheo') {
                    cargarTablaEditarPitcheo();
                } else if (tipo === 'defensiva') {
                    cargarTablaEditarDefensa();
                    actualizarLideresPorPosicion();
                }

            } catch (error) {
                console.error('Error:', error);
                mostrarError(errorId, `Error al actualizar: ${error.message}`);
            }
        }
        // *** FIN DE FUNCIONES DE EDICIÓN (FASE 4) ***
        
        // ========== INICIO FASE 7: GENERADOR DE CALENDARIO ==========
        
        // Variable global para guardar los partidos generados
        let calendarioGenerado = [];

        // ¡INICIO FASE 7.3: LÓGICA DEL ALGORITMO!
        async function generarCalendario() {
            console.log('Iniciando generación de calendario...');
            const calendarioDiv = document.getElementById('calendario-generado');
            calendarioDiv.innerHTML = '<div class="loading">Generando calendario...</div>';
            
            // 1. Validar Equipos
            if (equipos.length !== 9) {
                mostrarError('calendarioError', `Error: Se necesitan 9 equipos para este generador. Tienes ${equipos.length}.`);
                calendarioDiv.innerHTML = '<div class="empty-state">Error: Se necesitan 9 equipos.</div>';
                return;
            }
            
            // 2. Obtener Parámetros
            const horariosStr = document.getElementById('horariosJuego').value;
            const horarios = horariosStr.split(',').map(h => h.trim());
            if (horarios.length !== 4) {
                mostrarError('calendarioError', 'Error: Debes ingresar 4 horarios separados por coma (ej. 09:00, 11:00, 13:00, 15:00).');
                calendarioDiv.innerHTML = '<div class="empty-state">Error: Se necesitan 4 horarios.</div>';
                return;
            }
            
            let fechaInicioStr = document.getElementById('fechaInicioCalendario').value;
            if (!fechaInicioStr) {
                mostrarError('calendarioError', 'Error: Debes seleccionar una fecha de inicio.');
                calendarioDiv.innerHTML = '<div class="empty-state">Error: Falta fecha de inicio.</div>';
                return;
            }
            // Ajuste para asegurar que la fecha se interprete en la zona horaria local
            // Asumimos Argentina (-03:00). ¡Ajusta esto si tu servidor está en otra zona!
            const fechaInicio = new Date(fechaInicioStr + 'T12:00:00-03:00'); 
            
            const diasEntre = parseInt(document.getElementById('diasEntreJornadas').value);
            
            // 3. Preparar Algoritmo (Round Robin para N impar)
            let misEquipos = [...equipos.map(e => ({ id: e.id, nombre: e.nombre }))];
            // Añadir un equipo "dummy" para gestionar el descanso (9 equipos -> 10)
            misEquipos.push({ id: 'dummy', nombre: 'Descansa' });
            
            const n = misEquipos.length; // 10
            
            // ¡CAMBIO FASE 7.4 (Opción C)!
            const numJornadas = 6; // 6 jornadas en lugar de (n-1)
            
            const numPartidosPorJornada = n / 2; // 5 "partidos" (4 reales, 1 descanso)
            
            let calendarioHTML = '';
            calendarioGenerado = []; // Limpiar calendario global
            
            for (let r = 0; r < numJornadas; r++) {
                let jornadaPartidos = [];
                // Sumar días a la fecha de inicio
                let fechaJornada = new Date(fechaInicio.getTime());
                fechaJornada.setDate(fechaJornada.getDate() + (r * diasEntre));
                let fechaISO = fechaJornada.toISOString().split('T')[0];
                
                calendarioHTML += `<div class="jornada-card"><h4>Jornada ${r + 1} (Fecha: ${fechaJornada.toLocaleDateString('es-AR')})</h4>`;
                
                let descansaEquipo = '';
                
                // === ¡INICIO FASE 7.5: LÓGICA DE ROTACIÓN DE HORARIOS! ===
                const offsetHorario = r % horarios.length;
                // === FIN FASE 7.5 ===

                for (let i = 0; i < numPartidosPorJornada; i++) {
                    const local = misEquipos[i];
                    const visitante = misEquipos[n - 1 - i];

                    if (local.id === 'dummy') {
                        descansaEquipo = visitante.nombre;
                        continue; // No es un partido, es un descanso
                    }
                    if (visitante.id === 'dummy') {
                        descansaEquipo = local.nombre;
                        continue; // No es un partido, es un descanso
                    }
                    
                    // Es un partido real
                    // === ¡CAMBIO FASE 7.5: Se aplica el offset! ===
                    const horarioIndex = (jornadaPartidos.length + offsetHorario) % horarios.length;
                    const horario = horarios[horarioIndex];
                    // === FIN CAMBIO FASE 7.5 ===

                    const partido = {
                        equipo_local_id: local.id,
                        equipo_visitante_id: visitante.id,
                        fecha_partido: `${fechaISO}T${horario}:00`, // Combinar fecha y hora para timestamp
                        local_nombre: local.nombre,
                        visitante_nombre: visitante.nombre,
                        horario: horario
                    };
                    
                    jornadaPartidos.push(partido);
                    calendarioHTML += `<div class="jornada-partido"><strong>${local.nombre}</strong> vs <strong>${visitante.nombre}</strong> <span>@ ${horario}</span></div>`;
                }
                
                calendarioGenerado.push(...jornadaPartidos);
                calendarioHTML += `<div class="jornada-descansa">Descansa: ${descansaEquipo}</div></div>`;

                // Rotar el array (algoritmo Round Robin)
                // Se mantiene el primer equipo (misEquipos[0])
                // El resto rota en sentido horario
                const ultimo = misEquipos.pop();
                misEquipos.splice(1, 0, ultimo);
            }
            
            // === INICIO FASE 7.5: Añadir Jornadas de Playoffs (Visual) ===
            let fechaJornada7 = new Date(fechaInicio.getTime());
            fechaJornada7.setDate(fechaJornada7.getDate() + (6 * diasEntre));
            calendarioHTML += `
                <div class="jornada-card" style="border-color: #ff6b35; background: rgba(255, 107, 53, 0.1);">
                    <h4>Jornada 7: Playoffs - Cuartos y Repechaje (Fecha: ${fechaJornada7.toLocaleDateString('es-AR')})</h4>
                    <div class="jornada-partido"><strong>(1er Lugar)</strong> vs <strong>(6to Lugar)</strong></div>
                    <div class="jornada-partido"><strong>(2do Lugar)</strong> vs <strong>(5to Lugar)</strong></div>
                    <div class="jornada-partido"><strong>(3er Lugar)</strong> vs <strong>(4to Lugar)</strong></div>
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 0;">
                    <div class="jornada-partido" style="color: #ff8c00;">Repechaje 1: (Perdedor 1) vs (Perdedor 2)</div>
                    <div class="jornada-partido" style="color: #ff8c00;">Repechaje 2: (Perdedor 1) vs (Perdedor 3)</div>
                    <div class="jornada-partido" style="color: #ff8c00;">Repechaje 3: (Perdedor 2) vs (Perdedor 3)</div>
                </div>`;

            let fechaJornada8 = new Date(fechaInicio.getTime());
            fechaJornada8.setDate(fechaJornada8.getDate() + (7 * diasEntre));
            calendarioHTML += `
                <div class="jornada-card" style="border-color: #ffd700; background: rgba(255, 215, 0, 0.1);">
                    <h4>Jornada 8: Semifinal y Final (Fecha: ${fechaJornada8.toLocaleDateString('es-AR')})</h4>
                    <div class="jornada-partido">Semifinal 1: (Ganador Cuartos 1) vs (Ganador Repechaje)</div>
                    <div class="jornada-partido">Semifinal 2: (Ganador Cuartos 2) vs (Ganador Cuartos 3)</div>
                    <hr style="border-color: rgba(255,255,255,0.1); margin: 10px 0;">
                    <div class="jornada-partido" style="font-size: 1.1rem; text-align: center;"><strong>🏆 GRAN FINAL 🏆</strong></div>
                </div>`;
            // === FIN FASE 7.5 ===

            // 4. Mostrar en UI
            calendarioDiv.innerHTML = calendarioHTML;
            document.getElementById('btnGuardarCalendario').disabled = false;
            document.getElementById('btnGuardarCalendario').textContent = '💾 Guardar Calendario en BD';
            mostrarExito('calendarioMessage', `¡Calendario de ${numJornadas} jornadas (más playoffs) generado! Revisa y presiona 'Guardar'.`);
        }

        async function guardarCalendario() {
            if (calendarioGenerado.length === 0) {
                mostrarError('calendarioError', 'Primero debes generar un calendario.');
                return;
            }
            // ¡CAMBIO! Mensaje de confirmación actualizado
            if (!confirm(`¿Estás seguro de guardar este calendario? Se crearán ${calendarioGenerado.length} partidos (solo las 6 jornadas de temporada regular) en la base de datos. Los playoffs son solo visuales.`)) {
                return;
            }

            const btn = document.getElementById('btnGuardarCalendario');
            btn.disabled = true;
            btn.textContent = 'Guardando...';

            try {
                let partidosCreados = 0;
                for (const partido of calendarioGenerado) {
                    
                    const response = await fetch('/api/partidos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            equipo_local_id: partido.equipo_local_id,
                            equipo_visitante_id: partido.equipo_visitante_id,
                            fecha_partido: partido.fecha_partido, // Ya tiene formato YYYY-MM-DDTHH:MM:SS
                            innings_jugados: 9, // Default
                            carreras_local: null, // Partido a futuro
                            carreras_visitante: null // Partido a futuro
                        })
                    });
                    
                    if (response.ok) {
                        partidosCreados++;
                    } else {
                        console.warn(`Error al guardar partido: ${partido.local_nombre} vs ${partido.visitante_nombre}`);
                    }
                }
                
                // ¡CAMBIO! Mensaje de éxito actualizado
                mostrarExito('calendarioMessage', `¡Calendario guardado! Se crearon ${partidosCreados} partidos de temporada regular.`);
                await cargarPartidos(); // Actualizar la tabla de partidos
                btn.textContent = 'Guardado ✔️';
                calendarioGenerado = []; // Limpiar para evitar doble guardado
            
            } catch (error) {
                console.error('Error guardando calendario:', error);
                mostrarError('calendarioError', 'Error de conexión al guardar el calendario.');
                btn.disabled = false;
                btn.textContent = '💾 Guardar Calendario en BD';
            }
        }
        // ¡FIN FASE 7.3!
        
        // ========== FIN FASE 7 ==========
    </script>
</body>
</html>
