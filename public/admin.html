<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Chogui League - Sistema de Gestión Profesional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
            position: relative;
        }

        /* Efectos de fuego/energía similares al logo */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(220, 20, 60, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: linear-gradient(45deg, #ffd700, #ff8c00, #ff6b35);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.4);
            animation: float 6s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(1deg); }
        }

        @keyframes shine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            margin-bottom: 10px;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            opacity: 0.9;
            color: #1a1a2e;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .admin-controls {
            position: fixed;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .admin-btn {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            padding: 8px 16px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            cursor: pointer;
            border: none;
        }

        .admin-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.6);
            color: #1a1a2e;
            text-decoration: none;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            gap: 10px;
        }

        .nav-tab {
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            color: #ffd700;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            min-width: 120px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }

        .nav-tab:hover {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }

        .nav-tab.active {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.5);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 2px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transition: left 0.5s;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.4);
        }

        .card h3 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.4rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: relative;
            z-index: 1;
        }

        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ffd700;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            background: rgba(26, 26, 46, 0.8);
            color: #ffd700;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #ffd700;
            outline: none;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.6);
        }
        
        .btn-actualizar {
            background: linear-gradient(145deg, #007BFF, #0056b3);
            color: white;
        }
        .btn-actualizar:hover {
            background: linear-gradient(145deg, #0088ff, #0056b3);
            color: white;
            transform: translateY(-2px) scale(1.05);
        }
        .btn-actualizar[disabled] {
            background: #555;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-secondary {
            background: linear-gradient(145deg, #ff6b35, #dc143c);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .btn-secondary:hover {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            transform: scale(1.1);
        }
        
        .btn-edit {
            background: linear-gradient(145deg, #007BFF, #0056b3);
            color: white;
        }
        .btn-edit:hover {
            background: linear-gradient(145deg, #0088ff, #0056b3);
            color: white;
        }
        
        .btn-activar {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            font-weight: bold;
        }
        .btn-activar[disabled] {
            background: #555;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.4);
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            min-width: 600px;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            font-size: 0.9rem;
        }

        th {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: rgba(255, 215, 0, 0.1);
            transition: all 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #ffd700;
            font-style: italic;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #4CAF50;
            display: none;
        }

        .error-message {
            background: rgba(220, 20, 60, 0.2);
            color: #dc143c;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #dc143c;
            display: none;
        }

        .loading {
            color: #ffd700;
            font-style: italic;
        }

        /* Estilos específicos para la pestaña de Líderes */
        .leaders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .leader-card {
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .leader-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .leader-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 215, 0, 0.4);
            border-color: #ffd700;
        }

        .leader-card h4 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: relative;
            z-index: 1;
        }

        .leader-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .leader-item:last-child {
            border-bottom: none;
        }

        .leader-name {
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .leader-team {
            color: #ffd700;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .leader-stat {
            color: #ff8c00;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .stats-form-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .gold-medal {
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .silver-medal {
            color: #C0C0C0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .bronze-medal {
            color: #CD7F32;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        /* Nuevos estilos para líderes por posición específica */
        .position-leaders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .position-card {
            background: linear-gradient(135deg, #16213e, #1a1a2e);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .position-card:hover {
            border-color: #ffd700;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
        }

        .position-title {
            color: #ffd700;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .position-leader {
            text-align: left; /* CORREGIDO: para listas */
            padding: 0;
        }
        
        /* ESTILOS NUEVOS PARA LISTA TOP 5 */
        .position-leader-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
        }
        .position-leader-item:last-child {
            border-bottom: none;
        }
        
        .position-player-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .position-player {
            color: #fff;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .position-team {
            color: #ffd700;
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .position-rating {
            color: #ff8c00;
            font-weight: bold;
            font-size: 1.1rem;
        }
        /* FIN ESTILOS NUEVOS */

        /* Sistema WAR avanzado */
        .war-stats {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.1));
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .war-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .war-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.8rem;
        }

        .war-component {
            text-align: center;
            padding: 8px;
            background: rgba(26, 26, 46, 0.5);
            border-radius: 6px;
        }

        .war-component-title {
            color: #ffd700;
            font-size: 0.7rem;
            margin-bottom: 3px;
        }

        .war-component-value {
            color: #fff;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-container, .stats-form-container {
                grid-template-columns: 1fr;
            }
            
            .leaders-grid, .position-leaders-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* AÑADIDO: CSS para Mejoras UX */
        .form-group { position: relative; }
        .field-error {
            color: #dc143c;
            font-size: 0.8rem;
            margin-top: 5px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        #main-content { position: relative; }

        /* PASO 5: Estilos para tablas mejoradas */
        .sortable {
            transition: background 0.3s ease;
            user-select: none;
        }
        .sortable:hover {
            background: rgba(255, 215, 0, 0.2) !important;
        }
        .sort-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.8rem;
            opacity: 0.5;
        }
        .sort-indicator.asc::after {
            content: '▲';
            color: #1a1a2e;
            opacity: 1;
        }
        .sort-indicator.desc::after {
            content: '▼';
            color: #1a1a2e;
            opacity: 1;
        }
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .pagination-btn {
            background: linear-gradient(145deg, #16213e, #1a1a2e);
            color: #ffd700;
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: linear-gradient(145deg, #ffd700, #ff8c00);
            color: #1a1a2e;
        }
        .items-per-page {
            color: #ffd700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .items-per-page select {
            background: rgba(26, 26, 46, 0.8);
            color: #ffd700;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            z-index: 100;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* ----- INICIO CORRECCIÓN 1: CAMBIAR SPINNER ----- */
        /* La clase .loading::after no se encontró. Se busca .loading-spinner y se reemplaza su animación. */
        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        /* Como no hay .loading::after, no se puede aplicar el estilo directamente sin cambiar HTML, lo cual está prohibido.
            Se deja la animación spin para .loading-spinner para no romper la funcionalidad visual existente. */
        /* ----- FIN CORRECCIÓN 1 ----- */
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alerta {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alerta-warning {
            background-color: rgba(255, 165, 0, 0.2);
            border-color: #ffa500;
            color: #ffa500;
        }
        .alerta-info {
            background-color: rgba(0, 191, 255, 0.2);
            border-color: #00bfff;
            color: #00bfff;
        }
        .alerta-success {
            background-color: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="admin-controls">
        <a href="index.html" class="admin-btn">👁️ Vista Pública</a>
        <button onclick="logout()" class="admin-btn">🚪 Salir</button>
    </div>
    
    <div id="main-content" class="container">
        <div class="header">
            <h1>🏆 CHOGUI LEAGUE - ADMIN</h1>
            <p>Panel de Administración - Sistema de Gestión Profesional</p>
            </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="equipos">🏅 Equipos</button>
            <button class="nav-tab" data-tab="partidos">🎯 Partidos</button>
            <button class="nav-tab" data-tab="jugadores">👤 Jugadores</button>
            <button class="nav-tab" data-tab="lideres">🏆 Líderes</button>
            <button class="nav-tab" data-tab="posiciones">📊 Posiciones</button>
            <button class="nav-tab" data-tab="torneos">🗓️ Torneos</button>
            <button class="nav-tab" data-tab="dashboard">📈 Dashboard</button>
        </div>

        <div id="equipos" class="tab-content active">
            <div class="card">
                <h3>➕ Agregar Nuevo Equipo</h3>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="nombreEquipo">Nombre del Equipo:</label>
                            <input type="text" id="nombreEquipo" required>
                        </div>
                        <div class="form-group">
                            <label for="managerEquipo">Manager:</label>
                            <input type="text" id="managerEquipo" required>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="ciudadEquipo">Ciudad:</label>
                            <input type="text" id="ciudadEquipo" required>
                        </div>
                        <div class="form-group">
                            <button id="btn-agregar-equipo" class="btn-primary" onclick="agregarEquipo()">🏆 Agregar Equipo</button>
                        </div>
                    </div>
                </div>
                <div id="equipoMessage" class="success-message"></div>
                <div id="equipoError" class="error-message"></div>
            </div>

            <div class="card" style="margin-bottom: 15px; padding: 15px;">
                <h4 style="color: #ffd700; margin-bottom: 15px;">Filtros de Equipos</h4>
                <div class="form-container">
                    <div class="form-group">
                        <label for="buscadorEquipos">🔍 Buscar Equipo:</label>
                        <input type="text" id="buscadorEquipos" placeholder="Buscar por nombre, manager o ciudad..." style="border-radius: 20px;">
                    </div>
                     <div class="form-group" style="align-self: end;">
                        <button class="btn-secondary" onclick="limpiarFiltrosEquipos()" style="background: #ff8c00; width: 100%; padding: 12px;">🗑️ Limpiar Filtros</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn-secondary" onclick="exportarTabla('equipos', 'csv')" style="background: #4CAF50;">📊 Exportar a CSV</button>
                    <div style="margin-left: auto; color: #ffd700; font-size: 0.9rem; display: flex; align-items: center;">
                        <span id="equipos-count">Total: 0 equipos</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🏆 Equipos Registrados</h3>
                <div class="table-container">
                    <table id="equiposTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="ordenarTablaEquipos('id')" style="cursor: pointer;">
                                    ID <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaEquipos('nombre')" style="cursor: pointer;">
                                    Equipo <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaEquipos('manager')" style="cursor: pointer;">
                                    Manager <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaEquipos('ciudad')" style="cursor: pointer;">
                                    Ciudad <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaEquipos('fecha_creacion')" style="cursor: pointer;">
                                    Fecha <span class="sort-indicator"></span>
                                </th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">Cargando equipos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="partidos" class="tab-content">
            <div class="card">
                <h3>⚾ Registrar Nuevo Partido</h3>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="equipoLocal">Equipo Local:</label>
                            <select id="equipoLocal" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="equipoVisitante">Equipo Visitante:</label>
                            <select id="equipoVisitante" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="carrerasLocal">Carreras Local:</label>
                            <input type="number" id="carrerasLocal" min="0">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="carrerasVisitante">Carreras Visitante:</label>
                            <input type="number" id="carrerasVisitante" min="0">
                        </div>
                        <div class="form-group">
                            <label for="inningsJugados">Innings Jugados:</label>
                            <input type="number" id="inningsJugados" min="1" max="15" value="9">
                        </div>
                        <div class="form-group">
                            <label for="fechaPartido">Fecha del Partido:</label>
                            <input type="date" id="fechaPartido" required>
                        </div>
                    </div>
                </div>
                <button id="btn-registrar-partido" class="btn-primary" onclick="registrarPartido()">🎯 Registrar Partido</button>
                <div id="partidoMessage" class="success-message"></div>
                <div id="partidoError" class="error-message"></div>
            </div>
            
            <div class="card" style="margin-bottom: 15px; padding: 15px;">
                <h4 style="color: #ffd700; margin-bottom: 15px;">Filtros de Partidos</h4>
                <div class="form-container">
                    <div class="form-group">
                        <label for="filtroEquipoPartidos">Filtrar por Equipo:</label>
                        <select id="filtroEquipoPartidos" style="border-radius: 20px;">
                            <option value="">-- Todos los Equipos --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroEstadoPartidos">Estado del Partido:</label>
                        <select id="filtroEstadoPartidos" style="border-radius: 20px;">
                            <option value="">-- Todos --</option>
                            <option value="finalizado">Finalizados</option>
                            <option value="pendiente">Pendientes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroFechaPartidos">Filtrar por Fecha:</label>
                        <input type="date" id="filtroFechaPartidos" style="border-radius: 20px;">
                    </div>
                    <div class="form-group" style="align-self: end;">
                        <button class="btn-secondary" onclick="limpiarFiltrosPartidos()" style="background: #ff8c00; width: 100%; padding: 12px;">🗑️ Limpiar Filtros</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <div style="margin-left: auto; color: #ffd700; font-size: 0.9rem; display: flex; align-items: center;">
                        <span id="partidos-count">Total: 0 partidos</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🎯 Partidos Registrados</h3>
                <div class="table-container">
                    <table id="partidosTable">
                        <thead>
                            <tr>
                                <th>Local</th>
                                <th>Visitante</th>
                                <th>Resultado</th>
                                <th>Innings</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">Cargando partidos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="jugadores" class="tab-content">
            <div class="card">
                <h3>👤 Agregar Nuevo Jugador</h3>
                <form id="jugadorForm">
                    <div class="form-container">
                        <div>
                            <div class="form-group">
                                <label for="nombreJugador">Nombre del Jugador:</label>
                                <input type="text" id="nombreJugador" required>
                            </div>
                            <div class="form-group">
                                <label for="equipoJugador">Equipo:</label>
                                <select id="equipoJugador">
                                    <option value="">Seleccionar equipo...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="posicionJugador">⚾ Posición (Opcional):</label>
                                <select id="posicionJugador">
                                    <option value="">(Opcional)</option>
                                    <option value="C">Catcher (C)</option>
                                    <option value="1B">Primera Base (1B)</option>
                                    <option value="2B">Segunda Base (2B)</option>
                                    <option value="3B">Tercera Base (3B)</option>
                                    <option value="SS">Shortstop (SS)</option>
                                    <option value="LF">Left Field (LF)</option>
                                    <option value="CF">Center Field (CF)</option>
                                    <option value="RF">Right Field (RF)</option>
                                    <option value="P">Pitcher (P)</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label for="numeroJugador">🔢 Número (Opcional):</label>
                                <input type="number" id="numeroJugador" min="1" max="99" placeholder="Ejemplo: 24 (Opcional)">
                            </div>
                            <div class="form-group">
                                <button type="button" id="btn-agregar-jugador" class="btn-primary" onclick="agregarJugador()">👤 Agregar Jugador</button>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="jugadorMessage" class="success-message"></div>
                <div id="jugadorError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>👥 Jugadores Registrados</h3>
                <div class="card" style="margin-bottom: 15px; padding: 15px;">
                    <h4 style="color: #ffd700; margin-bottom: 15px;">🔍 Filtros y Búsqueda Avanzada</h4>
                    <div class="form-container">
                        <div class="form-group">
                            <label for="buscadorJugadores">🔍 Buscar por Nombre:</label>
                            <input type="text" id="buscadorJugadores" placeholder="Buscar jugador..." style="border-radius: 20px;">
                        </div>
                        <div class="form-group">
                            <label for="filtroRosterEquipo">🏅 Filtrar por Equipo:</label>
                            <select id="filtroRosterEquipo" style="border-radius: 20px;">
                                <option value="">-- Todos los Equipos --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filtroPosicion">⚾ Filtrar por Posición:</label>
                            <select id="filtroPosicion" style="border-radius: 20px;">
                                <option value="">-- Todas las Posiciones --</option>
                                <option value="C">Catcher (C)</option>
                                <option value="1B">Primera Base (1B)</option>
                                <option value="2B">Segunda Base (2B)</option>
                                <option value="3B">Tercera Base (3B)</option>
                                <option value="SS">Shortstop (SS)</option>
                                <option value="LF">Left Field (LF)</option>
                                <option value="CF">Center Field (CF)</option>
                                <option value="RF">Right Field (RF)</option>
                                <option value="P">Pitcher (P)</option>
                            </select>
                        </div>
                        <div class="form-group" style="align-self: end;">
                            <button class="btn-secondary" onclick="limpiarFiltrosJugadores()" style="background: #ff8c00; width: 100%; padding: 12px;">🗑️ Limpiar Filtros</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="exportarTabla('jugadores', 'csv')" style="background: #4CAF50;">📊 Exportar CSV</button>
                        <div style="margin-left: auto; color: #ffd700; font-size: 0.9rem; display: flex; align-items: center;">
                            <span id="jugadores-count">Total: 0 jugadores</span>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table id="jugadoresTable">
                          <thead>
                            <tr>
                                <th class="sortable" onclick="ordenarTablaJugadores('numero')" style="cursor: pointer;">
                                    # <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaJugadores('nombre')" style="cursor: pointer;">
                                    Jugador <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaJugadores('equipo_nombre')" style="cursor: pointer;">
                                    Equipo <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaJugadores('posicion')" style="cursor: pointer;">
                                    Posición <span class="sort-indicator"></span>
                                </th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Cargando jugadores...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="lideres" class="tab-content">
            
            <div class="card">
                <h3>📝 Editar Estadísticas de Bateo</h3>
                <div class="table-container">
                    <table id="tablaEditarBateo">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>AB</th>
                                <th>H</th>
                                <th>HR</th>
                                <th>RBI</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3>📝 Editar Estadísticas de Pitcheo</h3>
                <div class="table-container">
                    <table id="tablaEditarPitcheo">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>IP</th>
                                <th>ER</th>
                                <th>W</th>
                                <th>L</th>
                                <th>SV</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="8" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>📝 Editar Estadísticas Defensivas</h3>
                <div class="table-container">
                    <table id="tablaEditarDefensa">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>PO</th>
                                <th>A</th>
                                <th>E</th>
                                <th>DP</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3>📊 Registrar Estadísticas Avanzadas (BATEO)</h3>
                <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 15px;">Use este formulario para **SUMAR** estadísticas a un jugador (ej. después de un partido).</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorStats">Jugador:</label>
                        <select id="jugadorStats" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="atBats">At Bats (AB):</label>
                        <input type="number" id="atBats" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="hits">Hits (H):</label>
                        <input type="number" id="hits" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="homeRuns">Home Runs (HR):</label>
                        <input type="number" id="homeRuns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="rbi">RBI:</label>
                        <input type="number" id="rbi" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="runs">Carreras (R):</label>
                        <input type="number" id="runs" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="walks">Bases por Bolas (BB):</label>
                        <input type="number" id="walks" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="stolenBases">Bases Robadas (SB):</label>
                        <input type="number" id="stolenBases" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="errors" style="color: #ff8c00; opacity: 0.7;">Errores (E):</label>
                        <input type="number" id="errors" min="0" value="0" disabled>
                          <small style="color: #ff8c00; font-size: 0.8rem;">Los errores se registran en el form defensivo.</small>
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarOfensiva" onclick="registrarEstadisticas()">📊 Registrar Estadísticas (Sumar)</button>
                <div id="statsMessage" class="success-message"></div>
                <div id="statsError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>⚾ Registrar Estadísticas de Pitcheo</h3>
                 <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 15px;">Use este formulario para **SUMAR** estadísticas a un pitcher.</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorPitcheo">Pitcher:</label>
                        <select id="jugadorPitcheo" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inningsPitched">Innings Pitched (IP):</label>
                        <input type="number" id="inningsPitched" step="0.1" min="0" value="0">
                        <small style="color: #ffd700; font-size: 0.8rem;">Ej: 5.2 = 5 innings y 2 outs</small>
                    </div>
                    <div class="form-group">
                        <label for="hitsAllowed">Hits Permitidos:</label>
                        <input type="number" id="hitsAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="earnedRuns">Carreras Limpias (ER):</label>
                        <input type="number" id="earnedRuns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="strikeouts">Ponches (SO):</label>
                        <input type="number" id="strikeouts" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="walksAllowed">Bases por Bolas (BB):</label>
                        <input type="number" id="walksAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="homeRunsAllowed">Home Runs Permitidos:</label>
                        <input type="number" id="homeRunsAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="wins">Victorias (W):</label>
                        <input type="number" id="wins" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="losses">Derrotas (L):</label>
                        <input type="number" id="losses" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="saves">Salvamentos (SV):</label>
                        <input type="number" id="saves" min="0" value="0">
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarPitcheo" onclick="registrarEstadisticasPitcheo()">⚾ Registrar Estadísticas (Sumar)</button>
                <div id="pitcheoMessage" class="success-message"></div>
                <div id="pitcheoError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>🛡 Registrar Estadísticas Defensivas</h3>
                 <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 15px;">Use este formulario para **SUMAR** estadísticas a un jugador.</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorDefensivo">Jugador:</label>
                        <select id="jugadorDefensivo" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="putouts">Eliminaciones (PO):</label>
                        <input type="number" id="putouts" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="assists">Asistencias (A):</label>
                        <input type="number" id="assists" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="defensiveErrors">Errores (E):</label>
                        <input type="number" id="defensiveErrors" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="doublePlays">Jugadas Dobles (DP):</label>
                        <input type="number" id="doublePlays" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="passedBalls">Pelotas Pasadas (PB):</label>
                        <input type="number" id="passedBalls" min="0" value="0">
                        <small style="color: #ffd700; font-size: 0.8rem;">Solo para catchers</small>
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarDefensa" onclick="registrarEstadisticasDefensivas()">🛡 Registrar Estadísticas (Sumar)</button>
                <div id="defensivaMessage" class="success-message"></div>
                <div id="defensivaError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>🥇 MEJORES POR POSICIÓN - DEFENSIVA</h3>
                <div class="position-leaders-grid" id="positionLeadersGrid">
                    <div class="loading">Cargando líderes defensivos...</div>
                </div>
            </div>

            <div class="card">
                <h3>🏆 Líderes Generales de la Liga - BATEO</h3>
                <div class="leaders-grid">
                    <div class="leader-card">
                        <h4>🥇 MEJOR PROMEDIO (AVG)</h4>
                        <div id="avgLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.---</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>⚾ LÍDERES EN HOME RUNS</h4>
                        <div id="hrLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>🎯 LÍDERES EN RBI</h4>
                        <div id="rbiLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>📈 LÍDERES EN OPS</h4>
                        <div id="opsLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.---</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>⭐ MEJOR WAR TOTAL</h4>
                        <div id="warLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.--</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>🏃 BASES ROBADAS</h4>
                        <div id="sbLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">🥇 Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>📈 Estadísticas Completas de Bateo</h3>
                <div class="table-container">
                    <table id="statsTable">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>Pos</th>
                                <th>AB</th>
                                <th>H</th>
                                <th>AVG</th>
                                <th>OBP</th>
                                <th>OPS</th>
                                <th>HR</th>
                                <th>RBI</th>
                                <th>WAR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="11" class="loading">Cargando estadísticas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: #ffd700; font-size: 0.8rem;">
                    <strong>Leyenda:</strong> AB=At Bats, H=Hits, AVG=Average, OBP=On-Base %, OPS=On-Base+Slugging, HR=Home Runs, RBI=Runs Batted In, WAR=Wins Above Replacement
                </p>
            </div>
        </div>

        <div id="posiciones" class="tab-content">
            <div class="card">
                <h3>🏆 Tabla de Posiciones en Tiempo Real</h3>
                <div class="table-container">
                    <table id="posicionesTable">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Equipo</th>
                                <th>PJ</th>
                                <th>PG</th>
                                <th>PP</th>
                                <th>%</th>
                                <th>CF</th>
                                <th>CE</th>
                                <th>DIF</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="10" class="loading">Calculando posiciones...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: #ffd700; font-size: 0.8rem;">
                    <strong>Leyenda:</strong> PJ=Partidos Jugados, PG=Partidos Ganados, PP=Partidos Perdidos, %=Porcentaje, CF=Carreras a Favor, CE=Carreras en Contra, DIF=Diferencia
                </p>
            </div>
        </div>
        
        <div id="torneos" class="tab-content">
            <div class="card">
                <h3>➕ Crear Nuevo Torneo</h3>
                <div class="form-container" style="grid-template-columns: 1fr;">
                    <div>
                        <div class="form-group">
                            <label for="nombreTorneo">Nombre del Torneo:</label>
                            <input type="text" id="nombreTorneo" required placeholder="Ej: Torneo Verano 2026">
                        </div>
                        <div class="form-group">
                            <button class="btn-primary" onclick="crearTorneo()">🗓️ Crear Torneo</button>
                        </div>
                    </div>
                </div>
                <div id="torneoMessage" class="success-message"></div>
                <div id="torneoError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>🗓️ Torneos Existentes</h3>
                <p style="font-size: 0.9rem; color: #ffd700; margin-bottom: 15px;">Selecciona el torneo que estará **activo**. Todas las nuevas estadísticas se guardarán en este torneo.</p>
                <button class="btn-secondary" onclick="desactivarTodosLosTorneos()" style="background: #ff8c00; margin-bottom: 15px; font-weight: bold;">⚪ Desactivar Todos</button>
                <div class="table-container">
                    <table id="torneosTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre del Torneo</th>
                                <th>Fecha de Creación</th>
                                <th>Estado</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Cargando torneos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="dashboard" class="tab-content">
            <div class="card">
                <h3>📊 Resumen Ejecutivo de la Liga</h3>
                <div class="leaders-grid">
                    <div class="leader-card">
                        <h4>🏆 EQUIPOS TOTALES</h4>
                        <div class="leader-item">
                            <div class="leader-name">Equipos Registrados</div>
                            <div class="leader-stat" id="total-equipos">0</div>
                        </div>
                        <div class="leader-item">
                            <div class="leader-name">Con Partidos Jugados</div>
                            <div class="leader-stat" id="equipos-activos">0</div>
                        </div>
                    </div>
        
                    <div class="leader-card">
                        <h4>👥 JUGADORES TOTALES</h4>
                        <div class="leader-item">
                            <div class="leader-name">Jugadores Registrados</div>
                            <div class="leader-stat" id="total-jugadores">0</div>
                        </div>
                        <div class="leader-item">
                            <div class="leader-name">Con Estadísticas</div>
                            <div class="leader-stat" id="jugadores-stats">0</div>
                        </div>
                    </div>
        
                    <div class="leader-card">
                        <h4>🎯 PARTIDOS TOTALES</h4>
                        <div class="leader-item">
                            <div class="leader-name">Partidos Registrados</div>
                            <div class="leader-stat" id="total-partidos">0</div>
                        </div>
                        <div class="leader-item">
                            <div class="leader-name">Partidos Finalizados</div>
                            <div class="leader-stat" id="partidos-finalizados">0</div>
                        </div>
                    </div>
        
                    <div class="leader-card">
                        <h4>🗓️ TORNEO ACTUAL</h4>
                        <div class="leader-item">
                            <div class="leader-name" id="torneo-nombre">Sin Torneo Activo</div>
                            <div class="leader-stat" id="torneo-status">❌</div>
                        </div>
                        <div class="leader-item">
                            <div class="leader-name">Última Actualización</div>
                            <div class="leader-stat" id="ultima-actualizacion">--</div>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="card">
                <h3>📈 Estadísticas de Rendimiento</h3>
                <div class="position-leaders-grid">
                    <div class="position-card">
                        <div class="position-title">⚾ PROMEDIO GENERAL DE BATEO</div>
                        <div class="position-leader">
                            <div class="leader-stat" style="font-size: 2rem; color: #ffd700;" id="avg-general">.000</div>
                            <div class="leader-team">Liga completa</div>
                        </div>
                    </div>
        
                    <div class="position-card">
                        <div class="position-title">🏃 CARRERAS POR PARTIDO</div>
                        <div class="position-leader">
                            <div class="leader-stat" style="font-size: 2rem; color: #ff8c00;" id="carreras-promedio">0.0</div>
                            <div class="leader-team">Promedio por equipo</div>
                        </div>
                    </div>
        
                    <div class="position-card">
                        <div class="position-title">🎯 PORCENTAJE DE FINALIZACIÓN</div>
                        <div class="position-leader">
                            <div class="leader-stat" style="font-size: 2rem; color: #4CAF50;" id="porcentaje-finalizacion">0%</div>
                            <div class="leader-team">Partidos completados</div>
                        </div>
                    </div>
        
                    <div class="position-card">
                        <div class="position-title">🏆 EQUIPO LÍDER</div>
                        <div class="position-leader">
                            <div class="leader-stat" style="font-size: 1.5rem; color: #ffd700;" id="equipo-lider">Sin datos</div>
                            <div class="leader-team" id="record-lider">0-0</div>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="card">
                <h3>⚠️ Alertas y Estado del Sistema</h3>
                <div id="alertas-container">
                    <div class="leader-item">
                        <div class="leader-name">Estado de la Base de Datos</div>
                        <div class="leader-stat" style="color: #4CAF50;">✅ Operativa</div>
                    </div>
                </div>
            </div>
        
            <div class="card">
                <h3>📊 Comparativas Temporales</h3>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label>📅 Último Partido Registrado:</label>
                        <div id="ultimo-partido" style="color: #ffd700; font-weight: bold;">Sin partidos</div>
                    </div>
                    <div class="form-group">
                        <label>👤 Último Jugador Agregado:</label>
                        <div id="ultimo-jugador" style="color: #ffd700; font-weight: bold;">Sin jugadores</div>
                    </div>
                    <div class="form-group">
                        <label>🏆 Último Equipo Creado:</label>
                        <div id="ultimo-equipo" style="color: #ffd700; font-weight: bold;">Sin equipos</div>
                    </div>
                    <div class="form-group">
                        <label>📈 Actividad Reciente:</label>
                        <div id="actividad-reciente" style="color: #ff8c00; font-weight: bold;">Sistema iniciado</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Variables globales
        let equipos = [];
        let partidos = [];
        let jugadores = [];
        let estadisticas = [];
        let torneoActivo = { id: null, nombre: 'NINGUNO' };
        
        const AJUSTES_POSICIONALES = {
            'C': 12.5, 'SS': 7.5, 'CF': 2.5, '2B': 3.0, '3B': 2.0,
            'RF': -7.5, 'LF': -7.0, '1B': -12.5, 'P': 0.0
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacion();
            configurarEventListeners();
            cargarTodosLosDatos();
            establecerFechaActual();
            setTimeout(() => {
                if (window.setupRealtimeValidation) {
                    setupRealtimeValidation();
                }
            }, 1000);
        });

        function verificarAutenticacion() {
            const userRole = localStorage.getItem('userRole');
            if (!userRole || userRole !== 'admin') {
                alert('⛔ Acceso denegado. Solo administradores pueden acceder.');
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.clear();
            alert('👋 Sesión cerrada correctamente');
            window.location.href = 'login.html';
        }

        function establecerFechaActual() {
            const fechaInput = document.getElementById('fechaPartido');
            if (fechaInput) {
                fechaInput.value = new Date().toISOString().split('T')[0];
            }
        }

        function configurarEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => mostrarPestana(tab.dataset.tab));
            });
        }
        
        function mostrarPestana(nombrePestana) {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.style.opacity = '0';
                mainContent.style.transition = 'opacity 0.2s ease-out';
            }
            setTimeout(() => {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
                const pestanaActiva = document.getElementById(nombrePestana);
                if (pestanaActiva) pestanaActiva.classList.add('active');
                const botonActivo = document.querySelector(`[data-tab="${nombrePestana}"]`);
                if (botonActivo) botonActivo.classList.add('active');
                if (nombrePestana === 'lideres') {
                    actualizarLideres();
                    actualizarLideresPorPosicion();
                    cargarTablaEditarBateo();
                    cargarTablaEditarPitcheo();
                    cargarTablaEditarDefensa();
                }
                if (nombrePestana === 'torneos') {
                    cargarTorneos();
                }
                if (nombrePestana === 'dashboard') {
                    cargarDashboard();
                }
                if(mainContent) mainContent.style.opacity = '1';
            }, 200);
        }

        async function cargarTodosLosDatos() {
            try {
                await cargarTorneoActivo();
                await Promise.all([
                    cargarEquipos(),
                    cargarPartidos(),
                    cargarJugadores()
                ]);
                await cargarEstadisticas();
                actualizarSelectores();
                calcularPosiciones();
                actualizarLideres();
                actualizarLideresPorPosicion();
                
                setTimeout(() => {
                    if (typeof configurarFiltrosEnTiempoReal === 'function') {
                        configurarFiltrosEnTiempoReal();
                    }
                }, 500);

            } catch (error) {
                console.error('Error cargando datos:', error);
                if (window.notificationManager) {
                    window.notificationManager.error('Error de conexión al servidor', 'Fallo de Carga');
                }
            }
        }

        // ===============================================
        // == INICIO DE LAS 13 FUNCIONES CORREGIDAS ==
        // ===============================================

        async function agregarJugador() {
            const nombre = document.getElementById('nombreJugador').value.trim();
            const equipoId = document.getElementById('equipoJugador').value;
            const posicion = document.getElementById('posicionJugador').value;
            const numero = document.getElementById('numeroJugador').value;

            if (!nombre || nombre.length < 3) {
                alert('El nombre del jugador debe tener al menos 3 caracteres');
                return;
            }

            const jugadorData = {
                nombre: nombre,
                equipo_id: equipoId || null,
                posicion: posicion || null,
                numero: numero || null
            };

            try {
                const response = await fetch('/api/jugadores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jugadorData)
                });

                if (response.ok) {
                    alert(`Jugador "${nombre}" agregado exitosamente`);
                    document.getElementById('jugadorForm').reset();
                    await cargarJugadores();
                } else {
                    const error = await response.text();
                    alert(`Error: ${error}`);
                }
            } catch (error) {
                console.error('Error agregando jugador:', error);
                alert('Error de conexión al servidor');
            }
        }

        function calcularOBP(h, bb, ab) {
            if (ab + bb === 0) return 0;
            return (h + bb) / (ab + bb);
        }

        function calcularSLG(h, hr, ab) {
            if (ab === 0) return 0;
            return (h + hr * 3) / ab;
        }

        async function cargarEquipos() {
            try {
                const response = await fetch('/api/equipos');
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (Array.isArray(data)) {
                    equipos = data;
                    console.log(`✅ Equipos cargados: ${equipos.length} elementos.`);
                } else {
                    console.error('Error: La respuesta de la API de equipos no es un array. Se inicializa como vacío.', data);
                    equipos = [];
                }
            } catch (error) {
                console.error('Error crítico al cargar equipos:', error);
                // Asegura que 'equipos' sea siempre un array para evitar errores en cascada.
                equipos = [];
            } finally {
                // Se ejecuta siempre, haya error o no, para mantener la UI consistente.
                equiposFiltrados = [...equipos];
                actualizarTablaEquipos();
            }
        }

        async function cargarPartidos() {
            try {
                const response = await fetch('/api/partidos');
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (Array.isArray(data)) {
                    partidos = data;
                    console.log(`✅ Partidos cargados: ${partidos.length} elementos.`);
                } else {
                    console.error('Error: La respuesta de la API de partidos no es un array. Se inicializa como vacío.', data);
                    partidos = [];
                }
            } catch (error) {
                console.error('Error crítico al cargar partidos:', error);
                // Garantiza que 'partidos' sea siempre un array.
                partidos = [];
            } finally {
                actualizarTablaPartidos();
            }
        }

        async function cargarJugadores() {
            try {
                const response = await fetch('/api/jugadores');
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (Array.isArray(data)) {
                    jugadores = data;
                    console.log(`✅ Jugadores cargados: ${jugadores.length} elementos.`);
                } else {
                    console.error('Error: La respuesta de la API de jugadores no es un array. Se inicializa como vacío.', data);
                    jugadores = [];
                }
            } catch (error) {
                console.error('Error crítico al cargar jugadores:', error);
                // Garantiza que 'jugadores' sea siempre un array.
                jugadores = [];
            } finally {
                jugadoresFiltrados = [...jugadores];
                
                // La lógica de retardo se mantiene como fue solicitado.
                setTimeout(() => {
                    configurarFiltrosEnTiempoReal();
                    actualizarTablaJugadores();
                }, 100);
            }
        }

        function actualizarTablaJugadores() {
            const buscador = document.getElementById('buscadorJugadores').value.toLowerCase().trim();
            const filtroEquipo = document.getElementById('filtroRosterEquipo').value;
            const filtroPosicion = document.getElementById('filtroPosicion')?.value || '';

            // Filtrar jugadores
            jugadoresFiltrados = jugadores.filter(jugador => {
                const coincideNombre = jugador.nombre.toLowerCase().includes(buscador);
                const coincideEquipo = !filtroEquipo || jugador.equipo_id == filtroEquipo;
                const coincidePosicion = !filtroPosicion || jugador.posicion === filtroPosicion;
                return coincideNombre && coincideEquipo && coincidePosicion;
            });

            // Aplicar ordenamiento si existe
            if (ordenJugadores.campo) {
                jugadoresFiltrados.sort((a, b) => {
                    let valorA = a[ordenJugadores.campo] || '';
                    let valorB = b[ordenJugadores.campo] || '';

                    if (ordenJugadores.campo === 'equipo_nombre') {
                        valorA = a.equipo_nombre || '';
                        valorB = b.equipo_nombre || '';
                    }

                    if (typeof valorA === 'string') {
                        valorA = valorA.toLowerCase();
                        valorB = valorB.toLowerCase();
                    }

                    let comparacion = valorA < valorB ? -1 : valorA > valorB ? 1 : 0;
                    return ordenJugadores.direccion === 'desc' ? -comparacion : comparacion;
                });
            }

            // Actualizar contador
            const counter = document.getElementById('jugadores-count');
            if (counter) {
                counter.textContent = `Total: ${jugadoresFiltrados.length} jugadores`;
            }

            // Renderizar tabla
            renderizarTablaJugadores();
        }

        function ordenarTablaJugadores(campo) {
            console.log('Ordenando por campo:', campo);

            // Cambiar dirección si es el mismo campo
            if (ordenJugadores.campo === campo) {
                ordenJugadores.direccion = ordenJugadores.direccion === 'asc' ? 'desc' : 'asc';
            } else {
                ordenJugadores.campo = campo;
                ordenJugadores.direccion = 'asc';
            }

            // Limpiar todos los indicadores
            document.querySelectorAll('#jugadoresTable .sort-indicator').forEach(el => {
                el.className = 'sort-indicator';
            });

            // Agregar indicador al campo activo
            const targetHeader = document.querySelector(`#jugadoresTable th[onclick*="${campo}"] .sort-indicator`);
            if (targetHeader) {
                targetHeader.className = `sort-indicator ${ordenJugadores.direccion}`;
            }

            // Actualizar tabla
            actualizarTablaJugadores();
            console.log(`Ordenado por ${campo} ${ordenJugadores.direccion}`);
        }

        function actualizarTablaEquipos() {
            const buscador = document.getElementById('buscadorEquipos')?.value?.toLowerCase().trim() || '';

            equiposFiltrados = equipos.filter(equipo => {
                return equipo.nombre.toLowerCase().includes(buscador) ||
                    equipo.manager.toLowerCase().includes(buscador) ||
                    equipo.ciudad.toLowerCase().includes(buscador);
            });

            // Aplicar ordenamiento
            if (ordenEquipos.campo) {
                equiposFiltrados.sort((a, b) => {
                    let valorA = a[ordenEquipos.campo] || '';
                    let valorB = b[ordenEquipos.campo] || '';

                    if (typeof valorA === 'string') {
                        valorA = valorA.toLowerCase();
                        valorB = valorB.toLowerCase();
                    }

                    let comparacion = valorA < valorB ? -1 : valorA > valorB ? 1 : 0;
                    return ordenEquipos.direccion === 'desc' ? -comparacion : comparacion;
                });
            }

            // Actualizar contador
            if (document.getElementById('equipos-count')) {
                document.getElementById('equipos-count').textContent = `Total: ${equiposFiltrados.length} equipos`;
            }

            renderizarTablaEquipos();
        }

        function actualizarTablaPartidos() {
            const filtroEquipo = document.getElementById('filtroEquipoPartidos')?.value || '';
            const filtroEstado = document.getElementById('filtroEstadoPartidos')?.value || '';
            const filtroFecha = document.getElementById('filtroFechaPartidos')?.value || '';

            let partidosFiltrados = partidos.filter(partido => {
                const coincideEquipo = !filtroEquipo || 
                    partido.equipo_local_id == filtroEquipo || 
                    partido.equipo_visitante_id == filtroEquipo;
                
                const coincideEstado = !filtroEstado || 
                    (filtroEstado === 'finalizado' && partido.carreras_local !== null) ||
                    (filtroEstado === 'pendiente' && partido.carreras_local === null);
                
                const coincideFecha = !filtroFecha || 
                    partido.fecha_partido?.startsWith(filtroFecha);

                return coincideEquipo && coincideEstado && coincideFecha;
            });

            // Actualizar contador
            if (document.getElementById('partidos-count')) {
                document.getElementById('partidos-count').textContent = `Total: ${partidosFiltrados.length} partidos`;
            }

            // Renderizar tabla
            const tbody = document.querySelector('#partidosTable tbody');
            if (!tbody) return;

            if (partidosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No se encontraron partidos</td></tr>';
                return;
            }

            tbody.innerHTML = partidosFiltrados.map(partido => {
                const resultado = partido.carreras_local !== null 
                    ? `${partido.carreras_local} - ${partido.carreras_visitante}`
                    : 'Pendiente';
                
                const ganador = partido.carreras_local !== null
                    ? (partido.carreras_local > partido.carreras_visitante 
                        ? partido.equipo_local_nombre 
                        : partido.equipo_visitante_nombre)
                    : '-';

                const fecha = partido.fecha_partido 
                    ? new Date(partido.fecha_partido).toLocaleDateString('es-AR')
                    : '-';

                return `
                    <tr>
                        <td>${partido.equipo_local_nombre}</td>
                        <td>${partido.equipo_visitante_nombre}</td>
                        <td>${resultado}</td>
                        <td>${partido.innings || '9'}</td>
                        <td>${fecha}</td>
                        <td>
                            <button class="btn-secondary btn-edit" onclick="editarPartido(${partido.id})">✏️</button>
                            <button class="btn-secondary" onclick="eliminarPartido(${partido.id})" style="background: #dc143c;">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function configurarFiltrosEnTiempoReal() {
            console.log('Configurando filtros en tiempo real...');

            // Jugadores
            const buscadorJugadores = document.getElementById('buscadorJugadores');
            const filtroEquipo = document.getElementById('filtroRosterEquipo');
            const filtroPosicion = document.getElementById('filtroPosicion');

            if (buscadorJugadores) {
                buscadorJugadores.removeEventListener('input', actualizarTablaJugadores);
                buscadorJugadores.addEventListener('input', actualizarTablaJugadores);
                console.log('✅ Buscador de jugadores configurado');
            }

            if (filtroEquipo) {
                filtroEquipo.removeEventListener('change', actualizarTablaJugadores);
                filtroEquipo.addEventListener('change', actualizarTablaJugadores);
                console.log('✅ Filtro de equipo configurado');
            }

            if (filtroPosicion) {
                filtroPosicion.removeEventListener('change', actualizarTablaJugadores);
                filtroPosicion.addEventListener('change', actualizarTablaJugadores);
                console.log('✅ Filtro de posición configurado');
            }

            // Equipos
            const buscadorEquipos = document.getElementById('buscadorEquipos');
            if (buscadorEquipos) {
                buscadorEquipos.removeEventListener('input', actualizarTablaEquipos);
                buscadorEquipos.addEventListener('input', actualizarTablaEquipos);
                console.log('✅ Buscador de equipos configurado');
            }

            // Partidos
            const filtroEquipoPartidos = document.getElementById('filtroEquipoPartidos');
            const filtroEstadoPartidos = document.getElementById('filtroEstadoPartidos');
            const filtroFechaPartidos = document.getElementById('filtroFechaPartidos');

            if (filtroEquipoPartidos) {
                filtroEquipoPartidos.removeEventListener('change', actualizarTablaPartidos);
                filtroEquipoPartidos.addEventListener('change', actualizarTablaPartidos);
            }

            if (filtroEstadoPartidos) {
                filtroEstadoPartidos.removeEventListener('change', actualizarTablaPartidos);
                filtroEstadoPartidos.addEventListener('change', actualizarTablaPartidos);
            }

            if (filtroFechaPartidos) {
                filtroFechaPartidos.removeEventListener('change', actualizarTablaPartidos);
                filtroFechaPartidos.addEventListener('change', actualizarTablaPartidos);
            }

            console.log('Filtros configurados correctamente');
        }

        async function cargarDashboard() {
            try {
                // KPIs principales
                document.getElementById('total-equipos').textContent = equipos.length;
                document.getElementById('total-jugadores').textContent = jugadores.length;
                document.getElementById('total-partidos').textContent = partidos.length;

                // Equipos activos (con partidos jugados)
                const equiposActivos = new Set();
                partidos.forEach(p => {
                    if (p.carreras_local !== null) {
                        equiposActivos.add(p.equipo_local_id);
                        equiposActivos.add(p.equipo_visitante_id);
                    }
                });
                document.getElementById('equipos-activos').textContent = equiposActivos.size;

                // Partidos finalizados
                const partidosFinalizados = partidos.filter(p => p.carreras_local !== null).length;
                document.getElementById('partidos-finalizados').textContent = partidosFinalizados;

                // Porcentaje de finalización
                const porcentaje = partidos.length > 0 
                    ? Math.round((partidosFinalizados / partidos.length) * 100)
                    : 0;
                document.getElementById('porcentaje-finalizacion').textContent = `${porcentaje}%`;

                // Jugadores con estadísticas
                document.getElementById('jugadores-stats').textContent = estadisticas.length;

                // Torneo activo
                document.getElementById('torneo-nombre').textContent = torneoActivo.nombre || 'NINGUNO';
                document.getElementById('torneo-status').textContent = torneoActivo.id ? '✅ Activo' : '⚠️ Inactivo';

                // Última actualización
                const ahora = new Date();
                document.getElementById('ultima-actualizacion').textContent = 
                    ahora.toLocaleTimeString('es-AR');

                // Promedio general de bateo
                const avgGeneral = estadisticas.length > 0
                    ? (estadisticas.reduce((sum, e) => sum + (e.promedio_bateo || 0), 0) / estadisticas.length).toFixed(3)
                    : '0.000';
                document.getElementById('avg-general').textContent = avgGeneral;

                // Carreras promedio por partido
                const carrerasPromedio = partidosFinalizados > 0
                    ? Math.round(
                        partidos
                            .filter(p => p.carreras_local !== null)
                            .reduce((sum, p) => sum + p.carreras_local + p.carreras_visitante, 0) 
                        / partidosFinalizados
                    )
                    : 0;
                document.getElementById('carreras-promedio').textContent = carrerasPromedio;

                // Equipo líder
                if (equipos.length > 0) {
                    const posiciones = calcularPosiciones();
                    if (posiciones && posiciones.length > 0) {
                        const lider = posiciones[0];
                        document.getElementById('equipo-lider').textContent = lider.nombre;
                        document.getElementById('record-lider').textContent = 
                            `${lider.victorias}-${lider.derrotas} (${lider.porcentaje}%)`;
                    } else {
                        document.getElementById('equipo-lider').textContent = 'N/A';
                        document.getElementById('record-lider').textContent = '0-0';
                    }
                }

                // Últimos registros
                if (partidos.length > 0) {
                    const ultimoPartido = partidos[partidos.length - 1];
                    document.getElementById('ultimo-partido').textContent = 
                        `${ultimoPartido.equipo_local_nombre} vs ${ultimoPartido.equipo_visitante_nombre}`;
                }

                if (jugadores.length > 0) {
                    const ultimoJugador = jugadores[jugadores.length - 1];
                    document.getElementById('ultimo-jugador').textContent = ultimoJugador.nombre;
                }

                if (equipos.length > 0) {
                    const ultimoEquipo = equipos[equipos.length - 1];
                    document.getElementById('ultimo-equipo').textContent = ultimoEquipo.nombre;
                }

                // Generar alertas
                generarAlertas();

            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }
        
        function generarAlertas() {
            const alertasContainer = document.getElementById('alertas-container');
            if (!alertasContainer) return;

            const alertas = [];

            // Alerta de torneo activo
            if (!torneoActivo.id) {
                alertas.push({
                    tipo: 'warning',
                    mensaje: '⚠️ No hay torneo activo. Activa un torneo para comenzar a registrar partidos.',
                    accion: 'Activar Torneo'
                });
            }

            // Partidos pendientes
            const partidosPendientes = partidos.filter(p => p.carreras_local === null).length;
            if (partidosPendientes > 0) {
                alertas.push({
                    tipo: 'info',
                    mensaje: `📅 Hay ${partidosPendientes} partido(s) pendiente(s) de completar.`,
                    accion: 'Ver Partidos'
                });
            }

            // Jugadores sin estadísticas
            const jugadoresSinStats = jugadores.length - estadisticas.length;
            if (jugadoresSinStats > 0) {
                alertas.push({
                    tipo: 'info',
                    mensaje: `📊 ${jugadoresSinStats} jugador(es) sin estadísticas registradas.`,
                    accion: 'Registrar Estadísticas'
                });
            }

            // Renderizar alertas
            if (alertas.length === 0) {
                alertasContainer.innerHTML = `
                    <div class="alerta alerta-success">
                        <strong>✅ Sistema funcionando correctamente</strong>
                        <p>No hay alertas pendientes</p>
                    </div>
                `;
            } else {
                alertasContainer.innerHTML = alertas.map(alerta => `
                    <div class="alerta alerta-${alerta.tipo}">
                        <strong>${alerta.mensaje}</strong>
                        ${alerta.accion ? `<button class="btn-secondary">${alerta.accion}</button>` : ''}
                    </div>
                `).join('');
            }
        }

        // ===============================================
        // == FIN DE LAS 13 FUNCIONES CORREGIDAS ==
        // ===============================================
        
        async function cargarTorneoActivo() {
            try {
                const response = await fetch('/api/torneos/activo');
                if (response.ok) {
                    const data = await response.json();
                    torneoActivo = (data && data.id) ? data : { id: null, nombre: 'NINGUNO' };
                } else {
                    torneoActivo = { id: null, nombre: 'NINGUNO' };
                }
            } catch (error) {
                console.error('Error al cargar torneo activo:', error);
                torneoActivo = { id: null, nombre: 'NINGUNO' };
            }
        }

        async function cargarTorneos() {
            try {
                const response = await fetch('/api/torneos');
                const torneosList = await response.json();
                const tbody = document.querySelector('#torneosTable tbody');
                if (!tbody) return;

                if (torneosList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No se han creado torneos.</td></tr>';
                    return;
                }

                tbody.innerHTML = torneosList.map(torneo => `
                    <tr>
                        <td>${torneo.id}</td>
                        <td><strong>${torneo.nombre}</strong></td>
                        <td>${new Date(torneo.fecha_creacion).toLocaleDateString('es-AR')}</td>
                        <td>
                            <span style="color: ${torneo.activo ? '#4CAF50' : '#ff8c00'}; font-weight: bold;">
                                ${torneo.activo ? '✅ ACTIVO' : '⚪ Inactivo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-activar" onclick="activarTorneo(${torneo.id})" ${torneo.activo ? 'disabled' : ''}>
                                Activar
                            </button>
                            <button class="btn-edit" onclick="editarTorneo(${torneo.id}, '${torneo.nombre.replace(/'/g, "\\'")}')">✏️</button>
                            <button class="btn-secondary" onclick="eliminarTorneo(${torneo.id})">🗑️</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error al cargar torneos:', error);
                const tbody = document.querySelector('#torneosTable tbody');
                if(tbody) tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="color:#dc143c;">Error al cargar torneos.</td></tr>';
            }
        }

        async function crearTorneo() {
            const nombreInput = document.getElementById('nombreTorneo');
            const nombre = nombreInput.value.trim();
            if (!nombre) {
                alert('El nombre del torneo es obligatorio.');
                return;
            }
            try {
                const response = await fetch('/api/torneos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre })
                });
                if (response.ok) {
                    alert('Torneo creado exitosamente.');
                    nombreInput.value = '';
                    await cargarTorneos();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.message || 'No se pudo crear el torneo.'}`);
                }
            } catch (error) {
                alert('Error de conexión al crear torneo.');
            }
        }

        async function editarTorneo(id, nombreActual) {
            const nuevoNombre = prompt("Editar nombre del torneo:", nombreActual);
            if (nuevoNombre && nuevoNombre.trim() && nuevoNombre.trim() !== nombreActual) {
                try {
                    const response = await fetch(`/api/torneos/${id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ nombre: nuevoNombre.trim() })
                    });
                    if (response.ok) {
                        alert('Torneo actualizado.');
                        await cargarTorneos();
                        if (torneoActivo.id === id) {
                            await cargarTorneoActivo();
                        }
                    } else {
                        alert('No se pudo actualizar el torneo.');
                    }
                } catch (e) {
                    alert('Error de conexión.');
                }
            }
        }

        async function activarTorneo(id) {
            try {
                const response = await fetch(`/api/torneos/${id}/activar`, { method: 'PUT' });
                if (response.ok) {
                    alert('Torneo activado.');
                    await cargarTorneoActivo();
                    await cargarTorneos();
                } else {
                    alert('Error al activar el torneo.');
                }
            } catch(e) {
                alert('Error de conexión.');
            }
        }

        async function desactivarTodosLosTorneos() {
            if (!confirm('¿Desactivar todos los torneos? Ninguno quedará como activo.')) return;
            try {
                const response = await fetch(`/api/torneos/desactivar-todos`, { method: 'PUT' });
                if (response.ok) {
                    alert('Todos los torneos desactivados.');
                    await cargarTorneoActivo();
                    await cargarTorneos();
                } else {
                    alert('Error al desactivar torneos.');
                }
            } catch(e) {
                alert('Error de conexión.');
            }
        }

        async function eliminarTorneo(id) {
            if (!confirm('¿Seguro que quieres eliminar este torneo? Se borrarán todas sus estadísticas asociadas.')) return;
            try {
                const response = await fetch(`/api/torneos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('Torneo eliminado.');
                    await cargarTorneos();
                    if(torneoActivo.id === id) {
                        await cargarTorneoActivo();
                    }
                } else {
                    alert('Error al eliminar el torneo.');
                }
            } catch(e) {
                alert('Error de conexión.');
            }
        }

        async function cargarEstadisticas() {
            try {
                const [ofensivasRes, defensivasRes, pitcheoRes] = await Promise.all([
                    fetch('/api/estadisticas-ofensivas'),
                    fetch('/api/estadisticas-defensivas'),
                    fetch('/api/estadisticas-pitcheo')
                ]);

                const ofensivas = ofensivasRes.ok ? await ofensivasRes.json() : [];
                const defensivas = defensivasRes.ok ? await defensivasRes.json() : [];
                const pitcheo = pitcheoRes.ok ? await pitcheoRes.json() : [];

                const statsMap = new Map();

                const mergeStats = (statList) => {
                    statList.forEach(stat => {
                        const existing = statsMap.get(stat.jugador_id) || { jugador_id: stat.jugador_id };
                        statsMap.set(stat.jugador_id, { ...existing, ...stat });
                    });
                };

                mergeStats(ofensivas);
                mergeStats(defensivas);
                mergeStats(pitcheo);

                estadisticas = Array.from(statsMap.values());
                actualizarTablaEstadisticas();
            } catch (error) {
                console.error("Error cargando todas las estadísticas:", error);
                estadisticas = [];
            }
        }

        function calcularWAR(jugador, stats) {
            const { at_bats = 0, hits = 0, home_runs = 0, walks = 0 } = stats;
            const pa = at_bats + walks;
            if (pa === 0) return 0;

            const wOBA = (0.69 * walks + 0.89 * (hits - home_runs) + 2.1 * home_runs) / pa;
            const leagueWOBA = 0.320;
            const wRAA = ((wOBA - leagueWOBA) / 1.25) * pa;

            const positionalAdjustment = AJUSTES_POSICIONALES[jugador.posicion] || 0;
            const replacementRuns = (pa / 600) * 20;
            
            const totalRuns = wRAA + positionalAdjustment - replacementRuns;
            const war = totalRuns / 10;
            return isNaN(war) ? 0.0 : war;
        }

        function actualizarTablaEstadisticas() {
            const tbody = document.querySelector('#statsTable tbody');
            if (!tbody) return;

            const statsConJugador = estadisticas.map(stat => {
                const jugador = jugadores.find(j => j.id === stat.jugador_id);
                if (!jugador) return null;
                return { ...stat, ...jugador, jugador_nombre: jugador.nombre, equipo_nombre: jugador.equipo_nombre };
            }).filter(Boolean);

            if (statsConJugador.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No hay estadísticas para mostrar.</td></tr>';
                return;
            }
            
            tbody.innerHTML = statsConJugador.map(s => {
                const ab = s.at_bats || 0;
                const h = s.hits || 0;
                const hr = s.home_runs || 0;
                const bb = s.walks || 0;
                const avg = ab > 0 ? (h / ab).toFixed(3) : '.000';
                const obp = calcularOBP(h, bb, ab);
                const slg = calcularSLG(h, hr, ab);
                const ops = (obp + slg).toFixed(3);
                const war = calcularWAR(s, s).toFixed(2);

                return `
                    <tr>
                        <td><strong>${s.jugador_nombre}</strong></td>
                        <td>${s.equipo_nombre}</td>
                        <td>${s.posicion || 'N/A'}</td>
                        <td>${ab}</td>
                        <td>${h}</td>
                        <td style="font-weight: bold; color: #ffd700;">${avg}</td>
                        <td>${obp.toFixed(3)}</td>
                        <td style="font-weight: bold; color: #ff8c00;">${ops}</td>
                        <td>${hr || 0}</td>
                        <td>${s.rbi || 0}</td>
                        <td style="font-weight: bold; color: #4CAF50;">${war}</td>
                    </tr>
                `;
            }).join('');
        }

        async function actualizarLideresPorPosicion() {
            try {
                const response = await fetch('/api/estadisticas-defensivas');
                if (!response.ok) throw new Error('Failed to fetch defensive stats');
                const defensivas = await response.json();
                
                const grid = document.getElementById('positionLeadersGrid');
                if (!grid) return;
                grid.innerHTML = '';
                
                const posGroups = {};
                defensivas.forEach(stat => {
                    const player = jugadores.find(j => j.id === stat.jugador_id);
                    if (!player || !player.posicion) return;
                    
                    if (!posGroups[player.posicion]) posGroups[player.posicion] = [];
                    const po = stat.putouts || 0;
                    const a = stat.assists || 0;
                    const e = stat.errors || 0;
                    const chances = po + a + e;
                    const rating = chances > 0 ? ((po + a) / chances) : 1;
                    posGroups[player.posicion].push({ ...player, rating: rating.toFixed(3) });
                });
                
                Object.keys(AJUSTES_POSICIONALES).forEach(pos => {
                    const leaders = (posGroups[pos] || []).sort((a,b) => b.rating - a.rating).slice(0,3);
                    
                    let leaderHtml = `<div class="position-leader empty-state" style="padding: 10px 0;">Sin datos</div>`;
                    if (leaders.length > 0) {
                        leaderHtml = leaders.map(l => `
                            <div class="position-leader-item">
                                <div class="position-player-container">
                                    <div>
                                        <div class="position-player">${l.nombre}</div>
                                        <div class="position-team">${l.equipo_nombre}</div>
                                    </div>
                                    <div class="position-rating">${l.rating}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    grid.innerHTML += `
                        <div class="position-card">
                            <div class="position-title">🛡️ MEJORES ${pos} (FLD%)</div>
                            <div class="position-leader">${leaderHtml}</div>
                        </div>`;
                });
                if(grid.innerHTML === '') grid.innerHTML = `<p class="empty-state">No hay suficientes datos defensivos.</p>`;
            } catch (error) {
                console.error(error);
            }
        }

        function calcularPosiciones() {
            const tbody = document.querySelector('#posicionesTable tbody');
            if (!tbody) return []; // Retornar array vacío para el dashboard
            if (equipos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="empty-state">No hay equipos registrados.</td></tr>`;
                return [];
            }

            const standings = new Map(equipos.map(e => [e.id, { id: e.id, nombre: e.nombre, PJ: 0, PG: 0, PP: 0, CF: 0, CE: 0 }]));
            
            partidos.forEach(p => {
                if (p.carreras_local !== null && p.carreras_visitante !== null) {
                    const local = standings.get(p.equipo_local_id);
                    const visitante = standings.get(p.equipo_visitante_id);
                    
                    if (!local || !visitante) return;
                    
                    local.PJ++; visitante.PJ++;
                    local.CF += p.carreras_local; visitante.CF += p.carreras_visitante;
                    local.CE += p.carreras_visitante; visitante.CE += p.carreras_local;

                    if (p.carreras_local > p.carreras_visitante) {
                        local.PG++; visitante.PP++;
                    } else if (p.carreras_visitante > p.carreras_local) {
                        visitante.PG++; local.PP++;
                    }
                }
            });

            const sorted = [...standings.values()].sort((a, b) => {
                const pctA = a.PJ > 0 ? a.PG / a.PJ : 0;
                const pctB = b.PJ > 0 ? b.PG / b.PJ : 0;
                if (pctB > pctA) return 1;
                if (pctA > pctB) return -1;
                const diffA = a.CF - a.CE;
                const diffB = b.CF - b.CE;
                return diffB - diffA;
            });
            
            if (sorted.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="empty-state">No hay partidos jugados.</td></tr>`;
                return [];
            }

            tbody.innerHTML = sorted.map((team, index) => {
                const pct = team.PJ > 0 ? (team.PG / team.PJ).toFixed(3) : '.000';
                const diff = team.CF - team.CE;
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${team.nombre}</strong></td>
                        <td>${team.PJ}</td>
                        <td style="color:#4CAF50;">${team.PG}</td>
                        <td style="color:#dc143c;">${team.PP}</td>
                        <td>${pct}</td>
                        <td>${team.CF}</td>
                        <td>${team.CE}</td>
                        <td>${diff > 0 ? `+${diff}` : diff}</td>
                        <td>-</td>
                    </tr>
                `;
            }).join('');

            // Devolver para el dashboard
            return sorted.map(t => ({
                nombre: t.nombre,
                victorias: t.PG,
                derrotas: t.PP,
                porcentaje: t.PJ > 0 ? ((t.PG / t.PJ) * 100).toFixed(1) : '0.0'
            }));
        }


        async function actualizarLideres() {
            if (estadisticas.length === 0 || jugadores.length === 0) {
                ['avgLeaders', 'hrLeaders', 'rbiLeaders', 'opsLeaders', 'warLeaders', 'sbLeaders'].forEach(mostrarLideresVacios);
                return;
            }
            const minAB = 10;
            const enrichedStats = estadisticas
                .map(stat => {
                    const jugador = jugadores.find(j => j.id === stat.jugador_id);
                    return jugador ? { ...stat, ...jugador, jugador_nombre: jugador.nombre, equipo_nombre: jugador.equipo_nombre } : null;
                })
                .filter(s => s && s.at_bats > 0);

            const qualified = enrichedStats.filter(s => s.at_bats >= minAB);

            actualizarLideresHTML('avgLeaders', [...qualified].sort((a,b) => (b.hits/b.at_bats) - (a.hits/a.at_bats)).slice(0,3), 'avg', true);
            actualizarLideresHTML('hrLeaders', [...enrichedStats].sort((a,b) => (b.home_runs || 0) - (a.home_runs || 0)).slice(0,3), 'home_runs');
            actualizarLideresHTML('rbiLeaders', [...enrichedStats].sort((a,b) => (b.rbi || 0) - (a.rbi || 0)).slice(0,3), 'rbi');
            actualizarLideresHTML('sbLeaders', [...enrichedStats].sort((a,b) => (b.stolen_bases || 0) - (a.stolen_bases || 0)).slice(0,3), 'stolen_bases');

            const opsLeaders = qualified.map(s => {
                const obp = calcularOBP(s.hits || 0, s.walks || 0, s.at_bats);
                const slg = calcularSLG(s.hits || 0, s.home_runs || 0, s.at_bats);
                s.ops = obp + slg;
                return s;
            }).sort((a,b) => b.ops - a.ops).slice(0,3);
            actualizarLideresHTML('opsLeaders', opsLeaders, 'ops', true);

            const warLeaders = enrichedStats.map(s => {
                s.war = calcularWAR(s, s);
                return s;
            }).sort((a,b) => b.war - a.war).slice(0,3);
            actualizarLideresHTML('warLeaders', warLeaders, 'war', true);
        }

        function mostrarLideresVacios(containerId) {
            const container = document.getElementById(containerId);
            if(container) container.innerHTML = `<div class="leader-item"><div class="leader-name" style="font-style: italic; color: #aaa;">Sin datos suficientes</div></div>`;
        }

        function actualizarLideresHTML(containerId, lideres, stat, isDecimal = false) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (!lideres || lideres.length === 0) {
                mostrarLideresVacios(containerId);
                return;
            }
            const medals = ['🥇', '🥈', '🥉'];
            const medalClasses = ['gold-medal', 'silver-medal', 'bronze-medal'];

            container.innerHTML = lideres.map((l, index) => {
                let statValue;
                if (stat === 'avg') statValue = (l.hits / l.at_bats).toFixed(3);
                else if (stat === 'ops') statValue = l.ops.toFixed(3);
                else if (stat === 'war') statValue = l.war.toFixed(2);
                else statValue = l[stat] || 0;
                
                return `
                <div class="leader-item">
                    <div>
                        <div class="leader-name ${medalClasses[index]}">${medals[index]} ${l.jugador_nombre}</div>
                        <div class="leader-team">${l.equipo_nombre || 'Sin equipo'}</div>
                    </div>
                    <div class="leader-stat">${statValue}</div>
                </div>`;
            }).join('');
        }

        function actualizarSelectores() {
            const equipoOptions = equipos.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
            ['equipoLocal', 'equipoVisitante', 'equipoJugador', 'filtroEquipoPartidos', 'filtroRosterEquipo'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const first = select.options[0].outerHTML;
                    select.innerHTML = first + equipoOptions;
                }
            });
            const jugadorOptions = jugadores.map(j => `<option value="${j.id}">${j.nombre} (${j.equipo_nombre || 'N/A'})</option>`).join('');
            ['jugadorStats', 'jugadorPitcheo', 'jugadorDefensivo'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const first = select.options[0].outerHTML;
                    select.innerHTML = first + jugadorOptions;
                }
            });
        }

        async function agregarEquipo() {
            const nombre = document.getElementById('nombreEquipo').value.trim();
            const manager = document.getElementById('managerEquipo').value.trim();
            const ciudad = document.getElementById('ciudadEquipo').value.trim();
            if(!nombre || !manager || !ciudad) {
                alert('Todos los campos son requeridos.');
                return;
            }
            
            try {
                const res = await fetch('/api/equipos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nombre, manager, ciudad })
                });
                if(res.ok) {
                    alert('Equipo agregado exitosamente.');
                    document.getElementById('nombreEquipo').value = '';
                    document.getElementById('managerEquipo').value = '';
                    document.getElementById('ciudadEquipo').value = '';
                    await cargarEquipos();
                    actualizarSelectores();
                } else {
                    alert('Error al agregar equipo.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        async function registrarPartido() {
            const equipo_local_id = document.getElementById('equipoLocal').value;
            const equipo_visitante_id = document.getElementById('equipoVisitante').value;
            const carreras_local = document.getElementById('carrerasLocal').value;
            const carreras_visitante = document.getElementById('carrerasVisitante').value;
            const fecha_partido = document.getElementById('fechaPartido').value;

            if (!equipo_local_id || !equipo_visitante_id || !fecha_partido) {
                alert('Equipos y fecha son obligatorios.');
                return;
            }
            if (equipo_local_id === equipo_visitante_id) {
                alert('Un equipo no puede jugar contra sí mismo.');
                return;
            }

            const body = {
                equipo_local_id,
                equipo_visitante_id,
                fecha_partido,
                carreras_local: carreras_local !== "" ? parseInt(carreras_local) : null,
                carreras_visitante: carreras_visitante !== "" ? parseInt(carreras_visitante) : null,
            };

            try {
                const res = await fetch('/api/partidos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    alert('Partido registrado exitosamente.');
                    await cargarPartidos();
                    calcularPosiciones();
                    document.getElementById('equipoLocal').value = '';
                    document.getElementById('equipoVisitante').value = '';
                    document.getElementById('carrerasLocal').value = '';
                    document.getElementById('carrerasVisitante').value = '';
                } else {
                    alert('Error al registrar partido.');
                }
            } catch (e) {
                alert('Error de red.');
            }
        }

        async function registrarEstadisticas() {
            const jugador_id = document.getElementById('jugadorStats').value;
            if (!jugador_id) {
                alert('Selecciona un jugador.');
                return;
            }
            
            const data = {
                jugador_id: parseInt(jugador_id),
                at_bats: parseInt(document.getElementById('atBats').value) || 0,
                hits: parseInt(document.getElementById('hits').value) || 0,
                home_runs: parseInt(document.getElementById('homeRuns').value) || 0,
                rbi: parseInt(document.getElementById('rbi').value) || 0,
                runs: parseInt(document.getElementById('runs').value) || 0,
                walks: parseInt(document.getElementById('walks').value) || 0,
                stolen_bases: parseInt(document.getElementById('stolenBases').value) || 0
            };
            
            try {
                const res = await fetch('/api/estadisticas-ofensivas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Estadísticas registradas exitosamente.');
                    await cargarEstadisticas();
                    document.querySelectorAll('#atBats, #hits, #homeRuns, #rbi, #runs, #walks, #stolenBases').forEach(el => el.value = 0);
                } else {
                    alert('Error al registrar estadísticas.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        async function eliminarEquipo(id) {
            if (!confirm('¿Eliminar este equipo?')) return;
            try {
                const res = await fetch(`/api/equipos/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Equipo eliminado.');
                    await cargarEquipos();
                } else {
                    alert('Error al eliminar.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        async function editarEquipo(id) {
            const equipo = equipos.find(e => e.id === id);
            if (!equipo) return;
            document.getElementById('nombreEquipo').value = equipo.nombre;
            document.getElementById('managerEquipo').value = equipo.manager;
            document.getElementById('ciudadEquipo').value = equipo.ciudad;
            document.getElementById('btn-agregar-equipo').textContent = '✅ Actualizar';
            document.getElementById('btn-agregar-equipo').onclick = () => actualizarEquipo(id);
        }

        async function actualizarEquipo(id) {
            const nombre = document.getElementById('nombreEquipo').value.trim();
            const manager = document.getElementById('managerEquipo').value.trim();
            const ciudad = document.getElementById('ciudadEquipo').value.trim();
            if(!nombre || !manager || !ciudad) {
                alert('Todos los campos son requeridos.');
                return;
            }
            
            try {
                const res = await fetch(`/api/equipos/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nombre, manager, ciudad })
                });
                if(res.ok) {
                    alert('Equipo actualizado.');
                    document.getElementById('nombreEquipo').value = '';
                    document.getElementById('managerEquipo').value = '';
                    document.getElementById('ciudadEquipo').value = '';
                    document.getElementById('btn-agregar-equipo').textContent = '🏆 Agregar Equipo';
                    document.getElementById('btn-agregar-equipo').onclick = agregarEquipo;
                    await cargarEquipos();
                } else {
                    alert('Error al actualizar equipo.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        async function editarJugador(id) {
            const jugador = jugadores.find(j => j.id === id);
            if (!jugador) return;
            document.getElementById('nombreJugador').value = jugador.nombre;
            document.getElementById('equipoJugador').value = jugador.equipo_id || '';
            document.getElementById('posicionJugador').value = jugador.posicion || '';
            document.getElementById('numeroJugador').value = jugador.numero || '';
            document.getElementById('btn-agregar-jugador').textContent = '✅ Actualizar';
            document.getElementById('btn-agregar-jugador').onclick = () => actualizarJugador(id);
        }

        async function actualizarJugador(id) {
            const nombre = document.getElementById('nombreJugador').value.trim();
            const equipo_id = document.getElementById('equipoJugador').value || null;
            const posicion = document.getElementById('posicionJugador').value || null;
            const numero = document.getElementById('numeroJugador').value || null;
            
            if (!nombre || nombre.length < 3) {
                alert('El nombre debe tener al menos 3 caracteres.');
                return;
            }
            
            try {
                const response = await fetch(`/api/jugadores/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, equipo_id, posicion, numero: numero ? parseInt(numero) : null })
                });
                
                if (response.ok) {
                    alert('Jugador actualizado exitosamente.');
                    document.getElementById('jugadorForm').reset();
                    document.getElementById('btn-agregar-jugador').textContent = '👤 Agregar Jugador';
                    document.getElementById('btn-agregar-jugador').onclick = agregarJugador;
                    await cargarJugadores();
                } else {
                    alert('Error al actualizar jugador.');
                }
            } catch (error) {
                alert('Error de conexión.');
                }
        }

        async function eliminarJugador(id) {
            if (!confirm('¿Eliminar este jugador?')) return;
            try {
                const res = await fetch(`/api/jugadores/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Jugador eliminado.');
                    await cargarJugadores();
                } else {
                    alert('Error al eliminar.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        async function editarPartido(id) {
            const partido = partidos.find(p => p.id === id);
            if (!partido) return;
            document.getElementById('equipoLocal').value = partido.equipo_local_id;
            document.getElementById('equipoVisitante').value = partido.equipo_visitante_id;
            document.getElementById('carrerasLocal').value = partido.carreras_local || '';
            document.getElementById('carrerasVisitante').value = partido.carreras_visitante || '';
            document.getElementById('fechaPartido').value = partido.fecha_partido.split('T')[0];
            document.getElementById('btn-registrar-partido').textContent = '✅ Actualizar';
            document.getElementById('btn-registrar-partido').onclick = () => actualizarPartido(id);
        }

        async function actualizarPartido(id) {
            const equipo_local_id = document.getElementById('equipoLocal').value;
            const equipo_visitante_id = document.getElementById('equipoVisitante').value;
            const carreras_local = document.getElementById('carrerasLocal').value;
            const carreras_visitante = document.getElementById('carrerasVisitante').value;
            const fecha_partido = document.getElementById('fechaPartido').value;

            if (!equipo_local_id || !equipo_visitante_id || !fecha_partido) {
                alert('Equipos y fecha son obligatorios.');
                return;
            }

            const body = {
                equipo_local_id,
                equipo_visitante_id,
                fecha_partido,
                carreras_local: carreras_local !== "" ? parseInt(carreras_local) : null,
                carreras_visitante: carreras_visitante !== "" ? parseInt(carreras_visitante) : null,
            };

            try {
                const res = await fetch(`/api/partidos/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    alert('Partido actualizado.');
                    document.getElementById('equipoLocal').value = '';
                    document.getElementById('equipoVisitante').value = '';
                    document.getElementById('carrerasLocal').value = '';
                    document.getElementById('carrerasVisitante').value = '';
                    document.getElementById('btn-registrar-partido').textContent = '🎯 Registrar Partido';
                    document.getElementById('btn-registrar-partido').onclick = registrarPartido;
                    await cargarPartidos();
                    calcularPosiciones();
                } else {
                    alert('Error al actualizar partido.');
                }
            } catch (e) {
                alert('Error de red.');
            }
        }

        async function eliminarPartido(id) {
            if (!confirm('¿Eliminar este partido?')) return;
            try {
                const res = await fetch(`/api/partidos/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Partido eliminado.');
                    await cargarPartidos();
                    calcularPosiciones();
                } else {
                    alert('Error al eliminar.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        async function registrarEstadisticasPitcheo() {
            const jugador_id = document.getElementById('jugadorPitcheo').value;
            if (!jugador_id) {
                alert('Selecciona un pitcher.');
                return;
            }
            
            const data = {
                jugador_id: parseInt(jugador_id),
                innings_pitched: parseFloat(document.getElementById('inningsPitched').value) || 0,
                hits_allowed: parseInt(document.getElementById('hitsAllowed').value) || 0,
                earned_runs: parseInt(document.getElementById('earnedRuns').value) || 0,
                strikeouts: parseInt(document.getElementById('strikeouts').value) || 0,
                walks_allowed: parseInt(document.getElementById('walksAllowed').value) || 0,
                home_runs_allowed: parseInt(document.getElementById('homeRunsAllowed').value) || 0,
                wins: parseInt(document.getElementById('wins').value) || 0,
                losses: parseInt(document.getElementById('losses').value) || 0,
                saves: parseInt(document.getElementById('saves').value) || 0
            };
            
            try {
                const res = await fetch('/api/estadisticas-pitcheo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Estadísticas de pitcheo registradas.');
                    await cargarEstadisticas();
                    document.querySelectorAll('#inningsPitched, #hitsAllowed, #earnedRuns, #strikeouts, #walksAllowed, #homeRunsAllowed, #wins, #losses, #saves').forEach(el => el.value = 0);
                } else {
                    alert('Error al registrar estadísticas.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        async function registrarEstadisticasDefensivas() {
            const jugador_id = document.getElementById('jugadorDefensivo').value;
            if (!jugador_id) {
                alert('Selecciona un jugador.');
                return;
            }
            
            const data = {
                jugador_id: parseInt(jugador_id),
                putouts: parseInt(document.getElementById('putouts').value) || 0,
                assists: parseInt(document.getElementById('assists').value) || 0,
                errors: parseInt(document.getElementById('defensiveErrors').value) || 0,
                double_plays: parseInt(document.getElementById('doublePlays').value) || 0,
                passed_balls: parseInt(document.getElementById('passedBalls').value) || 0
            };
            
            try {
                const res = await fetch('/api/estadisticas-defensivas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Estadísticas defensivas registradas.');
                    await cargarEstadisticas();
                    document.querySelectorAll('#putouts, #assists, #defensiveErrors, #doublePlays, #passedBalls').forEach(el => el.value = 0);
                } else {
                    alert('Error al registrar estadísticas.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        async function cargarTablaEditarBateo() {
            const tbody = document.querySelector('#tablaEditarBateo tbody');
            if (!tbody) return;
            
            try {
                const response = await fetch('/api/estadisticas-ofensivas');
                if (!response.ok) throw new Error('Error');
                const stats = await response.json();
                
                if (stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No hay estadísticas de bateo.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = stats.map(s => {
                    const jugador = jugadores.find(j => j.id === s.jugador_id);
                    return `
                        <tr>
                            <td>${jugador ? jugador.nombre : 'Desconocido'}</td>
                            <td>${jugador ? jugador.equipo_nombre : '-'}</td>
                            <td><input type="number" id="ab-${s.jugador_id}" value="${s.at_bats || 0}" style="width:60px;"></td>
                            <td><input type="number" id="h-${s.jugador_id}" value="${s.hits || 0}" style="width:60px;"></td>
                            <td><input type="number" id="hr-${s.jugador_id}" value="${s.home_runs || 0}" style="width:60px;"></td>
                            <td><input type="number" id="rbi-${s.jugador_id}" value="${s.rbi || 0}" style="width:60px;"></td>
                            <td><button class="btn-actualizar" onclick="actualizarEstadistica('bateo', ${s.jugador_id})">💾</button></td>
                        </tr>
                    `;
                }).join('');
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Error al cargar.</td></tr>';
            }
        }

        async function cargarTablaEditarPitcheo() {
            const tbody = document.querySelector('#tablaEditarPitcheo tbody');
            if (!tbody) return;
            
            try {
                const response = await fetch('/api/estadisticas-pitcheo');
                if (!response.ok) throw new Error('Error');
                const stats = await response.json();
                
                if (stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No hay estadísticas de pitcheo.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = stats.map(s => {
                    const jugador = jugadores.find(j => j.id === s.jugador_id);
                    return `
                        <tr>
                            <td>${jugador ? jugador.nombre : 'Desconocido'}</td>
                            <td>${jugador ? jugador.equipo_nombre : '-'}</td>
                            <td><input type="number" id="ip-${s.jugador_id}" value="${s.innings_pitched || 0}" style="width:60px;" step="0.1"></td>
                            <td><input type="number" id="er-${s.jugador_id}" value="${s.earned_runs || 0}" style="width:60px;"></td>
                            <td><input type="number" id="w-${s.jugador_id}" value="${s.wins || 0}" style="width:60px;"></td>
                            <td><input type="number" id="l-${s.jugador_id}" value="${s.losses || 0}" style="width:60px;"></td>
                            <td><input type="number" id="sv-${s.jugador_id}" value="${s.saves || 0}" style="width:60px;"></td>
                            <td><button class="btn-actualizar" onclick="actualizarEstadistica('pitcheo', ${s.jugador_id})">💾</button></td>
                        </tr>
                    `;
                }).join('');
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Error al cargar.</td></tr>';
            }
        }

        async function cargarTablaEditarDefensa() {
            const tbody = document.querySelector('#tablaEditarDefensa tbody');
            if (!tbody) return;
            
            try {
                const response = await fetch('/api/estadisticas-defensivas');
                if (!response.ok) throw new Error('Error');
                const stats = await response.json();
                
                if (stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No hay estadísticas defensivas.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = stats.map(s => {
                    const jugador = jugadores.find(j => j.id === s.jugador_id);
                    return `
                        <tr>
                            <td>${jugador ? jugador.nombre : 'Desconocido'}</td>
                            <td>${jugador ? jugador.equipo_nombre : '-'}</td>
                            <td><input type="number" id="po-${s.jugador_id}" value="${s.putouts || 0}" style="width:60px;"></td>
                            <td><input type="number" id="a-${s.jugador_id}" value="${s.assists || 0}" style="width:60px;"></td>
                            <td><input type="number" id="e-${s.jugador_id}" value="${s.errors || 0}" style="width:60px;"></td>
                            <td><input type="number" id="dp-${s.jugador_id}" value="${s.double_plays || 0}" style="width:60px;"></td>
                            <td><button class="btn-actualizar" onclick="actualizarEstadistica('defensiva', ${s.jugador_id})">💾</button></td>
                        </tr>
                    `;
                }).join('');
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Error al cargar.</td></tr>';
            }
        }

        function limpiarFormulario(tipo) {
            if (tipo === 'equipo') {
                document.getElementById('nombreEquipo').value = '';
                document.getElementById('managerEquipo').value = '';
                document.getElementById('ciudadEquipo').value = '';
            } else if (tipo === 'jugador') {
                document.getElementById('jugadorForm').reset();
            } else if (tipo === 'partido') {
                document.getElementById('equipoLocal').value = '';
                document.getElementById('equipoVisitante').value = '';
                document.getElementById('carrerasLocal').value = '';
                document.getElementById('carrerasVisitante').value = '';
            }
        }

        function resetearBoton(tipo) {
            if (tipo === 'equipo') {
                document.getElementById('btn-agregar-equipo').textContent = '🏆 Agregar Equipo';
                document.getElementById('btn-agregar-equipo').onclick = agregarEquipo;
            } else if (tipo === 'jugador') {
                document.getElementById('btn-agregar-jugador').textContent = '👤 Agregar Jugador';
                document.getElementById('btn-agregar-jugador').onclick = agregarJugador;
            } else if (tipo === 'partido') {
                document.getElementById('btn-registrar-partido').textContent = '🎯 Registrar Partido';
                document.getElementById('btn-registrar-partido').onclick = registrarPartido;
            }
        }

        async function cargarParaEditar(tipo, jugadorId) {
            // Esta función no se usa actualmente
            console.log('cargarParaEditar', tipo, jugadorId);
        }

        async function actualizarEstadistica(tipo, jugadorId) {
            let endpoint, data;
            
            if (tipo === 'bateo') {
                endpoint = '/api/estadisticas-ofensivas';
                data = {
                    jugador_id: jugadorId,
                    at_bats: parseInt(document.getElementById(`ab-${jugadorId}`).value) || 0,
                    hits: parseInt(document.getElementById(`h-${jugadorId}`).value) || 0,
                    home_runs: parseInt(document.getElementById(`hr-${jugadorId}`).value) || 0,
                    rbi: parseInt(document.getElementById(`rbi-${jugadorId}`).value) || 0
                };
            } else if (tipo === 'pitcheo') {
                endpoint = '/api/estadisticas-pitcheo';
                data = {
                    jugador_id: jugadorId,
                    innings_pitched: parseFloat(document.getElementById(`ip-${jugadorId}`).value) || 0,
                    earned_runs: parseInt(document.getElementById(`er-${jugadorId}`).value) || 0,
                    wins: parseInt(document.getElementById(`w-${jugadorId}`).value) || 0,
                    losses: parseInt(document.getElementById(`l-${jugadorId}`).value) || 0,
                    saves: parseInt(document.getElementById(`sv-${jugadorId}`).value) || 0
                };
            } else if (tipo === 'defensiva') {
                endpoint = '/api/estadisticas-defensivas';
                data = {
                    jugador_id: jugadorId,
                    putouts: parseInt(document.getElementById(`po-${jugadorId}`).value) || 0,
                    assists: parseInt(document.getElementById(`a-${jugadorId}`).value) || 0,
                    errors: parseInt(document.getElementById(`e-${jugadorId}`).value) || 0,
                    double_plays: parseInt(document.getElementById(`dp-${jugadorId}`).value) || 0
                };
            }
            
            try {
                const res = await fetch(`${endpoint}/${jugadorId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    alert('Estadística actualizada.');
                    await cargarEstadisticas();
                } else {
                    alert('Error al actualizar.');
                }
            } catch(e) {
                alert('Error de red.');
            }
        }

        let ordenJugadores = { campo: 'nombre', direccion: 'asc' };
        let ordenEquipos = { campo: 'nombre', direccion: 'asc' };
        let jugadoresFiltrados = [];
        let equiposFiltrados = [];

        function renderizarTablaEquipos() {
            const tbody = document.querySelector('#equiposTable tbody');
            if (!tbody) return;
            
            if (equiposFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No se encontraron equipos</td></tr>';
                return;
            }
            tbody.innerHTML = equiposFiltrados.map(equipo => `
                <tr>
                    <td>${equipo.id}</td>
                    <td><strong>${equipo.nombre}</strong></td>
                    <td>${equipo.manager}</td>
                    <td>${equipo.ciudad}</td>
                    <td>${new Date(equipo.fecha_creacion).toLocaleDateString('es-AR')}</td>
                    <td>
                        <button class="btn-secondary btn-edit" onclick="editarEquipo(${equipo.id})">✏️</button>
                        <button class="btn-secondary" onclick="eliminarEquipo(${equipo.id})" style="background: #dc143c;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        function ordenarTablaEquipos(campo) {
            if (ordenEquipos.campo === campo) {
                ordenEquipos.direccion = ordenEquipos.direccion === 'asc' ? 'desc' : 'asc';
            } else {
                ordenEquipos.campo = campo;
                ordenEquipos.direccion = 'asc';
            }
            document.querySelectorAll('#equiposTable .sort-indicator').forEach(el => {
                el.className = 'sort-indicator';
            });
            const indicator = document.querySelector(`#equiposTable th[onclick*="${campo}"] .sort-indicator`);
            if (indicator) indicator.className = `sort-indicator ${ordenEquipos.direccion}`;
            actualizarTablaEquipos();
        }

        function limpiarFiltrosEquipos() {
            document.getElementById('buscadorEquipos').value = '';
            ordenEquipos = { campo: 'nombre', direccion: 'asc' };
            document.querySelectorAll('#equiposTable .sort-indicator').forEach(el => {
                el.className = 'sort-indicator';
            });
            actualizarTablaEquipos();
        }

        function limpiarFiltrosPartidos() {
            document.getElementById('filtroEquipoPartidos').value = '';
            document.getElementById('filtroEstadoPartidos').value = '';
            document.getElementById('filtroFechaPartidos').value = '';
            actualizarTablaPartidos();
        }

        function renderizarTablaJugadores() {
            const tbody = document.querySelector('#jugadoresTable tbody');
            if (!tbody) return;
            if (jugadoresFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No se encontraron jugadores</td></tr>';
                return;
            }
            
            tbody.innerHTML = jugadoresFiltrados.map(jugador => `
                <tr>
                    <td>${jugador.numero || '-'}</td>
                    <td><strong>${jugador.nombre}</strong></td>
                    <td>${jugador.equipo_nombre || 'Sin equipo'}</td>
                    <td>${jugador.posicion || '-'}</td>
                    <td>
                        <button class="btn-secondary btn-edit" onclick="editarJugador(${jugador.id})">✏️</button>
                        <button class="btn-secondary" onclick="eliminarJugador(${jugador.id})" style="background: #dc143c;">🗑️</button>
                    </td>
                </tr>
            `).join('');
        }

        function limpiarFiltrosJugadores() {
            document.getElementById('buscadorJugadores').value = '';
            document.getElementById('filtroRosterEquipo').value = '';
            if (document.getElementById('filtroPosicion')) {
                document.getElementById('filtroPosicion').value = '';
            }
            ordenJugadores = { campo: 'nombre', direccion: 'asc' };
            document.querySelectorAll('#jugadoresTable .sort-indicator').forEach(el => {
                el.className = 'sort-indicator';
            });
            actualizarTablaJugadores();
        }

        // Clases UX
        class FormValidator {
            constructor() {
                this.rules = {};
            }
            addRule(field, rules) {
                this.rules[field] = rules;
            }
            validate(formId) {
                return true;
            }
            showError(field, message) {
                console.log(`Error en ${field}: ${message}`);
            }
            clearError(field) {
                console.log(`Limpiar error de ${field}`);
            }
        }

        class LoadingManager {
            show(buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.7';
                }
            }
            hide(buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            }
        }

        class ConfirmationManager {
            async confirm(message) {
                return confirm(message);
            }
        }

        class NotificationManager {
            success(msg, title = '') {
                alert(`${title ? title + ': ' : ''}${msg}`);
            }
            error(msg, title = '') {
                alert(`${title ? title + ': ' : ''}${msg}`);
            }
            warning(msg, title = '') {
                alert(`${title ? title + ': ' : ''}${msg}`);
            }
            info(msg, title = '') {
                alert(`${title ? title + ': ' : ''}${msg}`);
            }
        }

        class ShortcutManager {
            constructor() {
                this.init();
            }
            init() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        console.log('Guardar (Ctrl+S)');
                    }
                });
            }
        }

        class AutoSaveManager {
            constructor() {
                console.log('AutoSaveManager iniciado');
            }
        }

        function initializeUXSystems() {
            window.formValidator = new FormValidator();
            window.loadingManager = new LoadingManager();
            window.confirmationManager = new ConfirmationManager();
            window.notificationManager = new NotificationManager();
            window.shortcutManager = new ShortcutManager();
            window.autoSaveManager = new AutoSaveManager();
            console.log('Sistemas UX inicializados');
        }

        function exportarTabla(tabla, formato) {
            let datos, headers, filename;
            if (tabla === 'jugadores') {
                datos = jugadoresFiltrados;
                headers = ['Número', 'Nombre', 'Equipo', 'Posición'];
                filename = 'jugadores';
            } else if (tabla === 'equipos') {
                datos = equiposFiltrados;
                headers = ['ID', 'Nombre', 'Manager', 'Ciudad', 'Fecha'];
                filename = 'equipos';
            }
            if (formato === 'csv') {
                exportarCSV(datos, headers, filename, tabla);
            }
        }

        function exportarCSV(datos, headers, filename, tabla) {
            if (datos.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            let csv = headers.join(',') + '\n';
            datos.forEach(item => {
                let fila = [];
                if (tabla === 'jugadores') {
                    fila = [item.numero || '-', item.nombre, item.equipo_nombre || '-', item.posicion || '-'];
                } else if (tabla === 'equipos') {
                    fila = [item.id, item.nombre, item.manager, item.ciudad, new Date(item.fecha_creacion).toLocaleDateString('es-AR')];
                }
                csv += fila.map(campo => `"${String(campo).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert(`${filename}.csv descargado correctamente`);
        }

        if (document.readyState === 'loading') { 
            document.addEventListener('DOMContentLoaded', initializeUXSystems); 
        } else { 
            initializeUXSystems(); 
        }
    </script>
</body>
</html>
