<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Chogui League - Sistema de Gesti√≥n Profesional</title>
    <link rel="stylesheet" href="css/optimizations.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117;
            color: #ffffff;
            min-height: 100vh;
            position: relative;
        }

        /* Efectos de fuego/energ√≠a similares al logo */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: none;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: linear-gradient(135deg, #ff9800 0%, #ffb300 50%, #ffc107 100%);
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            overflow: hidden;
            transition: padding 0.3s ease, box-shadow 0.3s ease;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.1) 0%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        .header.scrolled {
            padding: 15px 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border-radius: 0 0 20px 20px;
        }

        .header.scrolled h1 {
            font-size: 1.5rem;
            margin: 5px 0 5px;
        }

        .header.scrolled p {
            font-size: 0.85rem;
            margin: 0;
        }

        .header h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            color: #1a1a1a;
            position: relative;
            z-index: 1;
            transition: font-size 0.3s ease, margin 0.3s ease;
        }

        .header p {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            opacity: 1;
            color: rgba(0, 0, 0, 0.8);
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
            position: relative;
            z-index: 1;
            transition: font-size 0.3s ease, margin 0.3s ease;
        }

        .admin-controls {
            position: fixed;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .admin-btn {
            background: #ffc107;
            color: #0d1117;
            padding: 8px 16px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            cursor: pointer;
            border: none;
        }

        .admin-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.6);
            color: #0d1117;
            text-decoration: none;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            gap: 10px;
        }

        .nav-tab {
            background: #161b22;
            color: #ffc107;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            min-width: 120px;
            text-align: center;
            border: 2px solid rgba(255, 193, 7, 0.2);
        }

        .nav-tab:hover {
            background: #ffc107;
            color: #0d1117;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.4);
        }

        .nav-tab.active {
            background: #ffc107;
            color: #0d1117;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.5);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: #161b22;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 2px solid rgba(255, 193, 7, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            display: none;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 193, 7, 0.3);
            border-color: rgba(255, 193, 7, 0.4);
        }

        .card h3 {
            color: #ffc107;
            margin-bottom: 20px;
            font-size: 1.4rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: relative;
            z-index: 1;
        }

        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ffc107;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            background: #21262d;
            color: #ffc107;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #ffc107;
            outline: none;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.3);
        }

        .btn-primary {
            background: #ffc107;
            color: #0d1117;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 193, 7, 0.6);
        }
        
        .btn-actualizar {
            background: linear-gradient(145deg, #007BFF, #0056b3);
            color: white;
        }
        .btn-actualizar:hover {
            background: linear-gradient(145deg, #0088ff, #0056b3);
            color: white;
            transform: translateY(-2px) scale(1.05);
        }
        .btn-actualizar[disabled] {
            background: #555;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-secondary {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin: 0 2px;
        }

        .btn-secondary:hover {
            background: #ffc107;
            color: #0d1117;
            transform: scale(1.1);
        }
        
        .btn-edit {
            background: linear-gradient(145deg, #007BFF, #0056b3);
            color: white;
        }
        .btn-edit:hover {
            background: linear-gradient(145deg, #0088ff, #0056b3);
            color: white;
        }
        
        .btn-activar {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            font-weight: bold;
        }
        .btn-activar[disabled] {
            background: #555;
            color: #999;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.4);
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid rgba(255, 193, 7, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #161b22;
            min-width: 600px;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 193, 7, 0.2);
            font-size: 0.9rem;
        }

        th {
            background: #ffc107;
            color: #0d1117;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #21262d;
            transition: all 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #ffc107;
            font-style: italic;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #4CAF50;
            display: none;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f44336;
            display: none;
        }

        .loading {
            color: #ffc107;
            font-style: italic;
        }

        /* Estilos espec√≠ficos para la pesta√±a de L√≠deres */
        .leaders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .leader-card {
            background: #161b22;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .leader-card::before {
            display: none;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .leader-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 193, 7, 0.4);
            border-color: #ffc107;
        }

        .leader-card h4 {
            color: #ffc107;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
            border-bottom: 2px solid #ffc107;
            padding-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: relative;
            z-index: 1;
        }

        .leader-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 193, 7, 0.2);
            position: relative;
            z-index: 1;
        }

        .leader-item:last-child {
            border-bottom: none;
        }

        .leader-name {
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .leader-team {
            color: #ffc107;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .leader-stat {
            color: #ff9800;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .stats-form-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .gold-medal {
            color: #ffc107;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .silver-medal {
            color: #C0C0C0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .bronze-medal {
            color: #CD7F32;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        /* Nuevos estilos para l√≠deres por posici√≥n espec√≠fica */
        .position-leaders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .position-card {
            background: #161b22;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .position-card:hover {
            border-color: #ffc107;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
        }

        .position-title {
            color: #ffc107;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .position-leader {
            text-align: left; /* CORREGIDO: para listas */
            padding: 0;
        }
        
        /* ESTILOS NUEVOS PARA LISTA TOP 5 */
        .position-leader-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.1);
        }
        .position-leader-item:last-child {
            border-bottom: none;
        }
        
        .position-player-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .position-player {
            color: #fff;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .position-team {
            color: #ffc107;
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .position-rating {
            color: #ff9800;
            font-weight: bold;
            font-size: 1.1rem;
        }
        /* FIN ESTILOS NUEVOS */

        /* Sistema WAR avanzado */
        .war-stats {
            background: rgba(255, 193, 7, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .war-title {
            color: #ffc107;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .war-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.8rem;
        }

        .war-component {
            text-align: center;
            padding: 8px;
            background: #161b22;
            border-radius: 6px;
        }

        .war-component-title {
            color: #ffc107;
            font-size: 0.7rem;
            margin-bottom: 3px;
        }

        .war-component-value {
            color: #fff;
            font-weight: bold;
        }
        
        /* A√ëADIDO: CSS para Mejoras UX */
        .form-group { position: relative; }
        .field-error {
            color: #f44336;
            font-size: 0.8rem;
            margin-top: 5px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        #main-content { position: relative; }

        /* PASO 5: Estilos para tablas mejoradas */
        .sortable {
            transition: background 0.3s ease;
            user-select: none;
        }
        .sortable:hover {
            background: rgba(255, 193, 7, 0.2) !important;
        }
        .sort-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.8rem;
            opacity: 0.5;
        }
        .sort-indicator.asc::after {
            content: '‚ñ≤';
            color: #0d1117;
            opacity: 1;
        }
        .sort-indicator.desc::after {
            content: '‚ñº';
            color: #0d1117;
            opacity: 1;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 17, 23, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            z-index: 100;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 193, 7, 0.3);
            border-top: 3px solid #ffc107;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alerta {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alerta-warning {
            background-color: rgba(255, 165, 0, 0.2);
            border-color: #ffa500;
            color: #ffa500;
        }
        .alerta-info {
            background-color: rgba(0, 191, 255, 0.2);
            border-color: #00bfff;
            color: #00bfff;
        }
        .alerta-success {
            background-color: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        /* ===== SISTEMA DE TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
            position: relative;
            overflow: hidden;
        }
        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
        }
        .toast-success {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.95), rgba(56, 142, 60, 0.95));
            border: 1px solid rgba(76, 175, 80, 0.5);
        }
        .toast-success::before {
            background: #4CAF50;
        }
        .toast-error {
            background: linear-gradient(135deg, rgba(220, 20, 60, 0.95), rgba(183, 28, 28, 0.95));
            border: 1px solid rgba(220, 20, 60, 0.5);
        }
        .toast-error::before {
            background: #f44336;
        }
        .toast-warning {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.95), rgba(230, 126, 34, 0.95));
            border: 1px solid rgba(255, 165, 0, 0.5);
        }
        .toast-warning::before {
            background: #ffa500;
        }
        .toast-info {
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.95), rgba(3, 155, 229, 0.95));
            border: 1px solid rgba(0, 191, 255, 0.5);
        }
        .toast-info::before {
            background: #00bfff;
        }
        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        .toast-content {
            flex: 1;
            color: #ffffff;
        }
        .toast-title {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 4px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .toast-message {
            font-size: 13px;
            opacity: 0.95;
            line-height: 1.4;
        }
        .toast-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #ffffff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .toast-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        .toast.hiding {
            animation: slideOut 0.3s ease-out forwards;
        }
        
        /* ===== CONTROLES DE TABLA ===== */
        .table-controls {
            background: rgba(22, 33, 62, 0.6);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        .table-controls h4 {
            color: #ffc107;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .search-box {
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            background: #21262d;
            color: #ffc107;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .search-box input:focus {
            border-color: #ffc107;
            outline: none;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.3);
        }
        .search-box::after {
            content: 'üîç';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }
        .filter-select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            background: #21262d;
            color: #ffc107;
            font-size: 14px;
            cursor: pointer;
        }
        .results-info {
            color: #ffc107;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .pagination-btn {
            background: #161b22;
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #ffc107;
            color: #0d1117;
            transform: translateY(-2px);
        }
        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background: #ffc107;
            color: #0d1117;
            font-weight: bold;
        }
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        .page-btn {
            background: #21262d;
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            min-width: 36px;
            text-align: center;
        }
        .page-btn:hover {
            background: rgba(255, 193, 7, 0.2);
        }
        .page-btn.active {
            background: #ffc107;
            color: #0d1117;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            /* Filtros en columna √∫nica */
            .filters-grid {
                grid-template-columns: 1fr;
            }
            /* Paginaci√≥n responsive */
            .pagination-controls {
                flex-direction: column;
                gap: 15px;
            }
            /* Formularios en columna √∫nica */
            .form-container {
                grid-template-columns: 1fr !important;
            }
            .stats-form-container {
                grid-template-columns: 1fr !important;
            }
            /* Headers de tablas con scroll horizontal */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            /* Reducir padding en mobile */
            .card {
                padding: 15px;
            }
            .container {
                padding: 15px;
                padding-top: 70px;
            }
            /* Botones m√°s grandes para touch */
            .btn-primary, .btn-secondary {
                min-height: 44px;
                padding: 12px 20px;
            }
            /* Header responsive */
            .header h1 {
                font-size: 1.5rem;
            }
            .header p {
                font-size: 0.85rem;
            }
            /* Tabs responsive */
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                justify-content: flex-start;
                padding-bottom: 10px;
            }
            .nav-tab {
                min-width: 100px;
                flex-shrink: 0;
            }
            /* Controles admin responsive */
            .admin-controls {
                top: 10px;
                right: 10px;
                flex-direction: column;
                gap: 5px;
            }
            .admin-btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
            /* Toast container mobile */
            .toast-container {
                top: 70px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            .toast {
                min-width: auto;
            }
        }
        /* Tablets (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .form-container {
                grid-template-columns: 1fr !important;
            }
            .container {
                padding: 20px;
            }
        }
        /* Indicador de b√∫squeda activa */
        .searching {
            position: relative;
        }
        .searching::after {
            content: 'üîç';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            animation: pulse 1s ease-in-out infinite;
            font-size: 16px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        /* Skeleton loaders para mejor UX */
        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 193, 7, 0.1) 0%,
                rgba(255, 193, 7, 0.2) 50%,
                rgba(255, 193, 7, 0.1) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        .skeleton-text {
            height: 16px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .skeleton-card {
            height: 120px;
            border-radius: 15px;
        }
        /* Loading state mejorado */
        .loading {
            color: #ffc107;
            font-style: normal;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* Mejoras de accesibilidad */
        :focus-visible {
            outline: 2px solid #ffc107;
            outline-offset: 2px;
        }
        /* Mejorar contraste en estados hover */
        .btn-primary:hover, .btn-secondary:hover, .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }
        /* Labels m√°s legibles */
        label {
            cursor: pointer;
            user-select: none;
        }
        /* Focus en inputs m√°s visible */
        input:focus,select:focus,textarea:focus {
            border-color: #ffc107 !important;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2) !important;
        }
        /* Skip to content para navegaci√≥n por teclado */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #ffc107;
            color: #0d1117;
            padding: 8px;
            text-decoration: none;
            z-index: 10000;
        }
        .skip-link:focus {
            top: 0;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    <div id="toast-container" class="toast-container"></div>
    <div class="admin-controls">
        <a href="/index.html" class="admin-btn">üëÅÔ∏è Vista P√∫blica</a> <button onclick="logout()" class="admin-btn">üö™ Salir</button>
    </div>
    
    <div id="main-content" class="container">
        <div class="header">
            <h1>üèÜ CHOGUI LEAGUE - ADMIN</h1>
            <p>Panel de Administraci√≥n - Sistema de Gesti√≥n Profesional</p>
            </div>

        <!-- Admin Tournament Bar -->
        <div class="admin-tournament-bar">
            <label>üèÜ Torneo activo:</label>
            <select id="adminTournamentDisplay">
                <option value="">Cargando...</option>
            </select>
            <div class="tournament-status" id="adminTournamentStatus">
                <div class="sse-dot" id="adminSseDot"></div>
                SSE Activo
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">üìà Dashboard</button>
            <button class="nav-tab" data-tab="equipos">üèÖ Equipos</button>
            <button class="nav-tab" data-tab="partidos">üéØ Partidos</button>
            <button class="nav-tab" data-tab="jugadores">üë§ Jugadores</button>
            <button class="nav-tab" data-tab="lideres">üèÜ L√≠deres</button>
            <button class="nav-tab" data-tab="posiciones">üìä Posiciones</button>
            <button class="nav-tab" data-tab="torneos">üóìÔ∏è Torneos</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="card">
                <h3>üìä Resumen Ejecutivo de la Liga</h3>
                <div class="leaders-grid">
                    <div class="leader-card">
                        <h4>üèÜ EQUIPOS TOTALES</h4>
                        <div class="leader-item">
                            <div class="leader-name">Equipos Registrados</div>
                            <div class="leader-stat" id="total-equipos">0</div>
                        </div>
                        <div class="leader-item">
                            <div class="leader-name">Con Partidos Jugados</div>
                            <div class="leader-stat" id="equipos-activos">0</div>
                        </div>
                    </div>
        
                    <div class="leader-card">
                        <h4>üë• JUGADORES TOTALES</h4>
                        <div class="leader-item">
                            <div class="leader-name">Jugadores Registrados</div>
                            <div class="leader-stat" id="total-jugadores">0</div>
                        </div>
                        <div class="leader-item">
                            <div class="leader-name">Con Estad√≠sticas</div>
                            <div class="leader-stat" id="jugadores-stats">0</div>
                        </div>
                    </div>
        
                    <div class="leader-card">
                        <h4>üéØ PARTIDOS TOTALES</h4>
                        <div class="leader-item">
                            <div class="leader-name">Partidos Registrados</div>
                            <div class="leader-stat" id="total-partidos">0</div>
                        </div>
                        <div class="leader-item">
                            <div class="leader-name">Partidos Finalizados</div>
                            <div class="leader-stat" id="partidos-finalizados">0</div>
                        </div>
                    </div>
        
                    <div class="leader-card">
                        <h4>üóìÔ∏è TORNEO ACTUAL</h4>
                        <div class="leader-item">
                            <div class="leader-name" id="torneo-nombre">Sin Torneo Activo</div>
                            <div class="leader-stat" id="torneo-status">‚ùå</div>
                        </div>
                        <div class="leader-item">
                            <div class="leader-name">√öltima Actualizaci√≥n</div>
                            <div class="leader-stat" id="ultima-actualizacion">--</div>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="card">
                <h3>üìà Estad√≠sticas de Rendimiento</h3>
                <div class="position-leaders-grid">
                    <div class="position-card">
                        <div class="position-title">‚öæ PROMEDIO GENERAL DE BATEO</div>
                        <div class="position-leader">
                            <div class="leader-stat" style="font-size: 2rem; color: #ffc107;" id="avg-general">.000</div>
                            <div class="leader-team">Liga completa</div>
                        </div>
                    </div>
        
                    <div class="position-card">
                        <div class="position-title">üèÉ CARRERAS POR PARTIDO</div>
                        <div class="position-leader">
                            <div class="leader-stat" style="font-size: 2rem; color: #ff9800;" id="carreras-promedio">0.0</div>
                            <div class="leader-team">Promedio por equipo</div>
                        </div>
                    </div>
        
                    <div class="position-card">
                        <div class="position-title">üéØ PORCENTAJE DE FINALIZACI√ìN</div>
                        <div class="position-leader">
                            <div class="leader-stat" style="font-size: 2rem; color: #4CAF50;" id="porcentaje-finalizacion">0%</div>
                            <div class="leader-team">Partidos completados</div>
                        </div>
                    </div>
        
                    <div class="position-card">
                        <div class="position-title">üèÜ EQUIPO L√çDER</div>
                        <div class="position-leader">
                            <div class="leader-stat" style="font-size: 1.5rem; color: #ffc107;" id="equipo-lider">Sin datos</div>
                            <div class="leader-team" id="record-lider">0-0</div>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="card">
                <h3>‚ö†Ô∏è Alertas y Estado del Sistema</h3>
                <div id="alertas-container">
                    <div class="leader-item">
                        <div class="leader-name">Estado de la Base de Datos</div>
                        <div class="leader-stat" style="color: #4CAF50;">‚úÖ Operativa</div>
                    </div>
                </div>
            </div>
        
            <div class="card">
                <h3>üìä Comparativas Temporales</h3>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label>üìÖ √öltimo Partido Registrado:</label>
                        <div id="ultimo-partido" style="color: #ffc107; font-weight: bold;">Sin partidos</div>
                    </div>
                    <div class="form-group">
                        <label>üë§ √öltimo Jugador Agregado:</label>
                        <div id="ultimo-jugador" style="color: #ffc107; font-weight: bold;">Sin jugadores</div>
                    </div>
                    <div class="form-group">
                        <label>üèÜ √öltimo Equipo Creado:</label>
                        <div id="ultimo-equipo" style="color: #ffc107; font-weight: bold;">Sin equipos</div>
                    </div>
                    <div class="form-group">
                        <label>üìà Actividad Reciente:</label>
                        <div id="actividad-reciente" style="color: #ff9800; font-weight: bold;">Sistema iniciado</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="equipos" class="tab-content">
            <div class="card">
                <h3>‚ûï Agregar Nuevo Equipo</h3>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="nombreEquipo">Nombre del Equipo:</label>
                            <input type="text" id="nombreEquipo" required>
                        </div>
                        <div class="form-group">
                            <label for="managerEquipo">Manager:</label>
                            <input type="text" id="managerEquipo" required>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="ciudadEquipo">Ciudad:</label>
                            <input type="text" id="ciudadEquipo" required>
                        </div>
                        <div class="form-group">
                            <button id="btn-agregar-equipo" class="btn-primary" onclick="agregarEquipo()">üèÜ Agregar Equipo</button>
                        </div>
                    </div>
                </div>
                <div id="equipoMessage" class="success-message"></div>
                <div id="equipoError" class="error-message"></div>
            </div>

            <div class="card" style="margin-bottom: 15px; padding: 15px;">
                <h4 style="color: #ffc107; margin-bottom: 15px;">Filtros de Equipos</h4>
                <div class="form-container">
                    <div class="form-group">
                        <label for="buscadorEquipos">üîç Buscar Equipo:</label>
                        <input type="text" id="buscadorEquipos" placeholder="Buscar por nombre, manager o ciudad..." style="border-radius: 20px;">
                    </div>
                     <div class="form-group" style="align-self: end;">
                        <button class="btn-secondary" onclick="limpiarFiltrosEquipos()" style="background: #ff9800; width: 100%; padding: 12px;">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn-secondary" onclick="exportarTabla('equipos', 'csv')" style="background: #4CAF50;">üìä Exportar a CSV</button>
                    <div style="margin-left: auto; color: #ffc107; font-size: 0.9rem; display: flex; align-items: center;">
                        <span id="equipos-count">Total: 0 equipos</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üèÜ Equipos Registrados</h3>
                <div class="table-container">
                    <table id="equiposTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="ordenarTablaEquipos('id')" style="cursor: pointer;">
                                    ID <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaEquipos('nombre')" style="cursor: pointer;">
                                    Equipo <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaEquipos('manager')" style="cursor: pointer;">
                                    Manager <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaEquipos('ciudad')" style="cursor: pointer;">
                                    Ciudad <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaEquipos('fecha_creacion')" style="cursor: pointer;">
                                    Fecha <span class="sort-indicator"></span>
                                </th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading">Cargando equipos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="partidos" class="tab-content">
            <div class="card">
                <h3>üìÖ PROGRAMAR PR√ìXIMO PARTIDO</h3>
                <p style="font-size: 0.9rem; color: #ffc107; margin-bottom: 15px;">
                    Para partidos que a√∫n NO se han jugado. Los resultados se registrar√°n despu√©s.
                </p>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="equipoLocalFuturo">Equipo Local:</label>
                            <select id="equipoLocalFuturo" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="equipoVisitanteFuturo">Equipo Visitante:</label>
                            <select id="equipoVisitanteFuturo" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fechaPartidoFuturo">üìÖ Fecha del Partido:</label>
                            <input type="date" id="fechaPartidoFuturo" required>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="horaPartidoFuturo">‚è∞ Hora del Partido:</label>
                            <input type="time" id="horaPartidoFuturo" required>
                        </div>
                        <div class="form-group">
                            <label for="lugarPartido">üèüÔ∏è Lugar/Estadio (Opcional):</label>
                            <input type="text" id="lugarPartido" placeholder="Ej: Estadio Municipal">
                        </div>
                        <div class="form-group">
                            <button class="btn-primary" onclick="programarPartido()">üìÖ Programar Partido</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>‚öæ REGISTRAR RESULTADO DE PARTIDO</h3>
                <p style="font-size: 0.9rem; color: #ffc107; margin-bottom: 15px;">
                    Para partidos que YA se jugaron. Ingresa las carreras de cada equipo.
                </p>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="equipoLocal">Equipo Local:</label>
                            <select id="equipoLocal" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="equipoVisitante">Equipo Visitante:</label>
                            <select id="equipoVisitante" required>
                                <option value="">Seleccionar equipo...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="carrerasLocal">Carreras Local:</label>
                            <input type="number" id="carrerasLocal" min="0">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="carrerasVisitante">Carreras Visitante:</label>
                            <input type="number" id="carrerasVisitante" min="0">
                        </div>
                        <div class="form-group">
                            <label for="inningsJugados">Innings Jugados:</label>
                            <input type="number" id="inningsJugados" min="1" max="15" value="9">
                        </div>
                        <div class="form-group">
                            <label for="fechaPartido">Fecha del Partido:</label>
                            <input type="date" id="fechaPartido" required>
                        </div>
                    </div>
                </div>
                <button id="btn-registrar-partido" class="btn-primary" onclick="registrarPartido()">üéØ Registrar Partido</button>
                <div id="partidoMessage" class="success-message"></div>
                <div id="partidoError" class="error-message"></div>
            </div>
            
            <div class="card" style="margin-bottom: 15px; padding: 15px;">
                <h4 style="color: #ffc107; margin-bottom: 15px;">Filtros de Partidos</h4>
                <div class="form-container">
                    <div class="form-group">
                        <label for="filtroEquipoPartidos">Filtrar por Equipo:</label>
                        <select id="filtroEquipoPartidos" style="border-radius: 20px;">
                            <option value="">-- Todos los Equipos --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroEstadoPartidos">Estado del Partido:</label>
                        <select id="filtroEstadoPartidos" style="border-radius: 20px;">
                            <option value="">-- Todos --</option>
                            <option value="programado">üìÖ Programados</option>
                            <option value="finalizado">‚úÖ Finalizados</option>
                            <option value="cancelado">‚ùå Cancelados</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroFechaPartidos">Filtrar por Fecha:</label>
                        <input type="date" id="filtroFechaPartidos" style="border-radius: 20px;">
                    </div>
                    <div class="form-group" style="align-self: end;">
                        <button class="btn-secondary" onclick="limpiarFiltrosPartidos()" style="background: #ff9800; width: 100%; padding: 12px;">üóëÔ∏è Limpiar Filtros</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <div style="margin-left: auto; color: #ffc107; font-size: 0.9rem; display: flex; align-items: center;">
                        <span id="partidos-count">Total: 0 partidos</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üéØ Partidos Registrados</h3>
                <div class="table-container">
                    <table id="partidosTable">
                        <thead>
                            <tr>
                                <th>Local</th>
                                <th>Visitante</th>
                                <th>Resultado</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="loading">Cargando partidos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="jugadores" class="tab-content">
            <div class="card">
                <h3>üë§ Agregar Nuevo Jugador</h3>
                <p style="font-size: 0.9rem; color: #ffc107; margin-bottom: 15px; opacity: 0.9;">
                    üí° Solo el nombre es obligatorio. Equipo, posici√≥n y n√∫mero son opcionales.
                </p>
                <form id="jugadorForm">
                    <div class="form-container">
                        <div>
                            <div class="form-group">
                                <label for="nombreJugador">üë§ Nombre Completo del Jugador:</label>
                                <input type="text" id="nombreJugador" required placeholder="Ejemplo: Miguel Calder√≥n">
                            </div>
                            <div class="form-group">
                                <label for="equipoJugador">üèÖ Equipo (Opcional):</label>
                                <select id="equipoJugador">
                                    <option value="">Sin equipo asignado</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label for="posicionJugador">‚öæ Posici√≥n (Opcional):</label>
                                <select id="posicionJugador">
                                    <option value="">-- Sin Posici√≥n --</option>
                                    <option value="UTIL">UTIL (Utilidad)</option>
                                    <option value="P">P (Pitcher)</option>
                                    <option value="C">C (Catcher)</option>
                                    <option value="1B">1B (Primera Base)</option>
                                    <option value="2B">2B (Segunda Base)</option>
                                    <option value="3B">3B (Tercera Base)</option>
                                    <option value="SS">SS (Shortstop)</option>
                                    <option value="LF">LF (Left Field)</option>
                                    <option value="CF">CF (Center Field)</option>
                                    <option value="RF">RF (Right Field)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="numeroJugador">üî¢ N√∫mero (Opcional):</label>
                                <input type="number" id="numeroJugador" min="0" max="99" placeholder="Ej: 24">
                            </div>
                        </div>
                    </div>
            
                    <button type="button" id="btn-agregar-jugador" class="btn-primary" onclick="agregarJugador()">üë§ Agregar Jugador</button>
                </form>
                <div id="jugadorMessage" class="success-message"></div>
                <div id="jugadorError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>üë• Jugadores Registrados</h3>
                <div class="card" style="margin-bottom: 15px; padding: 15px;">
                    <h4 style="color: #ffc107; margin-bottom: 15px;">üîç Filtros y B√∫squeda Avanzada</h4>
                    <div class="form-container">
                        <div class="form-group">
                            <label for="buscadorJugadores">üîç Buscar por Nombre:</label>
                            <input type="text" id="buscadorJugadores" placeholder="Buscar jugador..." style="border-radius: 20px;">
                        </div>
                        <div class="form-group">
                            <label for="filtroRosterEquipo">üèÖ Filtrar por Equipo:</label>
                            <select id="filtroRosterEquipo" style="border-radius: 20px;">
                                <option value="">-- Todos los Equipos --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filtroPosicion">‚öæ Filtrar por Posici√≥n:</label>
                            <select id="filtroPosicion" style="border-radius: 20px;">
                                <option value="">-- Todas las Posiciones --</option>
                                <option value="C">Catcher (C)</option>
                                <option value="1B">Primera Base (1B)</option>
                                <option value="2B">Segunda Base (2B)</option>
                                <option value="3B">Tercera Base (3B)</option>
                                <option value="SS">Shortstop (SS)</option>
                                <option value="LF">Left Field (LF)</option>
                                <option value="CF">Center Field (CF)</option>
                                <option value="RF">Right Field (RF)</option>
                                <option value="P">Pitcher (P)</option>
                            </select>
                        </div>
                        <div class="form-group" style="align-self: end;">
                            <button class="btn-secondary" onclick="limpiarFiltrosJugadores()" style="background: #ff9800; width: 100%; padding: 12px;">üóëÔ∏è Limpiar Filtros</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="exportarTabla('jugadores', 'csv')" style="background: #4CAF50;">üìä Exportar CSV</button>
                        <div style="margin-left: auto; color: #ffc107; font-size: 0.9rem; display: flex; align-items: center;">
                            <span id="jugadores-count">Total: 0 jugadores</span>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table id="jugadoresTable">
                          <thead>
                            <tr>
                                <th class="sortable" onclick="ordenarTablaJugadores('numero')" style="cursor: pointer;">
                                    # <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaJugadores('nombre')" style="cursor: pointer;">
                                    Jugador <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaJugadores('equipo_nombre')" style="cursor: pointer;">
                                    Equipo <span class="sort-indicator"></span>
                                </th>
                                <th class="sortable" onclick="ordenarTablaJugadores('posicion')" style="cursor: pointer;">
                                    Posici√≥n <span class="sort-indicator"></span>
                                </th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Cargando jugadores...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="lideres" class="tab-content">
            
            <div class="card">
                <h3>üìù Editar Estad√≠sticas de Bateo</h3>
                <div class="table-container">
                    <table id="tablaEditarBateo">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>PA</th>
                                <th>AB</th>
                                <th>H</th>
                                <th>2B</th>
                                <th>3B</th>
                                <th>HR</th>
                                <th>RBI</th>
                                <th>R</th>
                                <th>BB</th>
                                <th>SO</th>
                                <th>SB</th>
                                <th>CS</th>
                                <th>HBP</th>
                                <th>SF</th>
                                <th>SH</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="18" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3>üìù Editar Estad√≠sticas de Pitcheo</h3>
                <div class="table-container">
                    <table id="tablaEditarPitcheo">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>IP</th>
                                <th>H</th>
                                <th>ER</th>
                                <th>K</th>
                                <th>BB</th>
                                <th>HR</th>
                                <th>W</th>
                                <th>L</th>
                                <th>SV</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="12" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>üìù Editar Estad√≠sticas Defensivas</h3>
                <div class="table-container">
                    <table id="tablaEditarDefensa">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>PO</th>
                                <th>A</th>
                                <th>E</th>
                                <th>DP</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" class="loading">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3>üìä Registrar Estad√≠sticas Avanzadas (BATEO)</h3>
                <p style="font-size: 0.9rem; color: #ffc107; margin-bottom: 15px;">Use este formulario para **SUMAR** estad√≠sticas a un jugador (ej. despu√©s de un partido).</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorStats">Jugador:</label>
                        <select id="jugadorStats" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="plateAppearances">Apariciones (PA):</label>
                        <input type="number" id="plateAppearances" min="0" value="0">
                        <small style="color: #ffc107; font-size: 0.8rem;">PA = AB + BB + HBP + SF + SH</small>
                    </div>
                    <div class="form-group">
                        <label for="atBats">At Bats (AB):</label>
                        <input type="number" id="atBats" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="hits">Hits (H):</label>
                        <input type="number" id="hits" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="doubles">Dobles (2B):</label>
                        <input type="number" id="doubles" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="triples">Triples (3B):</label>
                        <input type="number" id="triples" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="homeRuns">Home Runs (HR):</label>
                        <input type="number" id="homeRuns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="rbi">RBI:</label>
                        <input type="number" id="rbi" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="runs">Carreras (R):</label>
                        <input type="number" id="runs" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="walks">Bases por Bolas (BB):</label>
                        <input type="number" id="walks" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="strikeouts">Ponches (SO):</label>
                        <input type="number" id="strikeouts" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="stolenBases">Bases Robadas (SB):</label>
                        <input type="number" id="stolenBases" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="caughtStealing">Atrapado Robando (CS):</label>
                        <input type="number" id="caughtStealing" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="hitByPitch">Golpeado (HBP):</label>
                        <input type="number" id="hitByPitch" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="sacrificeFlies">Sacrificio Fly (SF):</label>
                        <input type="number" id="sacrificeFlies" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="sacrificeHits">Sacrificio Hit (SH):</label>
                        <input type="number" id="sacrificeHits" min="0" value="0">
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarOfensiva" onclick="registrarEstadisticas()">üìä Registrar Estad√≠sticas (Sumar)</button>
                <div id="statsMessage" class="success-message"></div>
                <div id="statsError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>‚öæ Registrar Estad√≠sticas de Pitcheo</h3>
                 <p style="font-size: 0.9rem; color: #ffc107; margin-bottom: 15px;">Use este formulario para **SUMAR** estad√≠sticas a un pitcher.</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorPitcheo">Pitcher:</label>
                        <select id="jugadorPitcheo" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inningsPitched">Innings Pitched (IP):</label>
                        <input type="number" id="inningsPitched" step="0.1" min="0" value="0">
                        <small style="color: #ffc107; font-size: 0.8rem;">Ej: 5.2 = 5 innings y 2 outs</small>
                    </div>
                    <div class="form-group">
                        <label for="hitsAllowed">Hits Permitidos:</label>
                        <input type="number" id="hitsAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="earnedRuns">Carreras Limpias (ER):</label>
                        <input type="number" id="earnedRuns" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="strikeoutsP">Ponches (SO):</label>
                        <input type="number" id="strikeoutsP" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="walksAllowed">Bases por Bolas (BB):</label>
                        <input type="number" id="walksAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="homeRunsAllowed">Home Runs Permitidos:</label>
                        <input type="number" id="homeRunsAllowed" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="wins">Victorias (W):</label>
                        <input type="number" id="wins" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="losses">Derrotas (L):</label>
                        <input type="number" id="losses" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="saves">Salvamentos (SV):</label>
                        <input type="number" id="saves" min="0" value="0">
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarPitcheo" onclick="registrarEstadisticasPitcheo()">‚öæ Registrar Estad√≠sticas (Sumar)</button>
                <div id="pitcheoMessage" class="success-message"></div>
                <div id="pitcheoError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>üõ° Registrar Estad√≠sticas Defensivas</h3>
                 <p style="font-size: 0.9rem; color: #ffc107; margin-bottom: 15px;">Use este formulario para **SUMAR** estad√≠sticas a un jugador.</p>
                <div class="stats-form-container">
                    <div class="form-group">
                        <label for="jugadorDefensivo">Jugador:</label>
                        <select id="jugadorDefensivo" required>
                            <option value="">Seleccionar jugador...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="putouts">Eliminaciones (PO):</label>
                        <input type="number" id="putouts" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="assists">Asistencias (A):</label>
                        <input type="number" id="assists" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="defensiveErrors">Errores (E):</label>
                        <input type="number" id="defensiveErrors" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="doublePlays">Jugadas Dobles (DP):</label>
                        <input type="number" id="doublePlays" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="passedBalls">Pelotas Pasadas (PB):</label>
                        <input type="number" id="passedBalls" min="0" value="0">
                        <small style="color: #ffc107; font-size: 0.8rem;">Solo para catchers</small>
                    </div>
                </div>
                <button class="btn-primary" id="btnRegistrarDefensa" onclick="registrarEstadisticasDefensivas()">üõ° Registrar Estad√≠sticas (Sumar)</button>
                <div id="defensivaMessage" class="success-message"></div>
                <div id="defensivaError" class="error-message"></div>
                </div>

            <div class="card">
                <h3>ü•á MEJORES POR POSICI√ìN - DEFENSIVA</h3>
                <div class="position-leaders-grid" id="positionLeadersGrid">
                    <div class="loading">Cargando l√≠deres defensivos...</div>
                </div>
            </div>

            <div class="card">
                <h3>üèÜ L√≠deres Generales de la Liga - BATEO</h3>
                <div class="leaders-grid">
                    <div class="leader-card">
                        <h4>ü•á MEJOR PROMEDIO (AVG)</h4>
                        <div id="avgLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">ü•á Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.---</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>‚öæ L√çDERES EN HOME RUNS</h4>
                        <div id="hrLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">ü•á Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>üéØ L√çDERES EN RBI</h4>
                        <div id="rbiLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">ü•á Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>üìà L√çDERES EN OPS</h4>
                        <div id="opsLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">ü•á Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.---</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>‚≠ê MEJOR WAR TOTAL</h4>
                        <div id="warLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">ü•á Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">-.--</div>
                            </div>
                        </div>
                    </div>

                    <div class="leader-card">
                        <h4>üèÉ BASES ROBADAS</h4>
                        <div id="sbLeaders">
                            <div class="leader-item">
                                <div>
                                    <div class="leader-name gold-medal">ü•á Calculando...</div>
                                    <div class="leader-team">-</div>
                                </div>
                                <div class="leader-stat">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üìà Estad√≠sticas Completas de Bateo</h3>
                <div class="table-container">
                    <table id="statsTable">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Equipo</th>
                                <th>Pos</th>
                                <th>AB</th>
                                <th>H</th>
                                <th>AVG</th>
                                <th>OBP</th>
                                <th>OPS</th>
                                <th>HR</th>
                                <th>RBI</th>
                                <th>WAR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="11" class="loading">Cargando estad√≠sticas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: #ffc107; font-size: 0.8rem;">
                    <strong>Leyenda:</strong> AB=At Bats, H=Hits, AVG=Average, OBP=On-Base %, OPS=On-Base+Slugging, HR=Home Runs, RBI=Runs Batted In, WAR=Wins Above Replacement
                </p>
            </div>
        </div>

        <div id="posiciones" class="tab-content">
            <div class="card">
                <h3>üèÜ Tabla de Posiciones en Tiempo Real</h3>
                <div class="table-container">
                    <table id="posicionesTable">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Equipo</th>
                                <th>PJ</th>
                                <th>PG</th>
                                <th>PP</th>
                                <th>%</th>
                                <th>CF</th>
                                <th>CE</th>
                                <th>DIF</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="10" class="loading">Calculando posiciones...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: #ffc107; font-size: 0.8rem;">
                    <strong>Leyenda:</strong> PJ=Partidos Jugados, PG=Partidos Ganados, PP=Partidos Perdidos, %=Porcentaje, CF=Carreras a Favor, CE=Carreras en Contra, DIF=Diferencia
                </p>
            </div>
        </div>
        
        <div id="torneos" class="tab-content">
            <div class="card">
                <h3>‚ûï Crear Nuevo Torneo</h3>
                <div class="form-container">
                    <div>
                        <div class="form-group">
                            <label for="nombreTorneo">Nombre del Torneo:</label>
                            <input type="text" id="nombreTorneo" required placeholder="Ej: Torneo Verano 2026">
                        </div>
                        <div class="form-group">
                            <button class="btn-primary" onclick="crearTorneo()">üóìÔ∏è Crear Torneo</button>
                        </div>
                    </div>
                </div>
                <div id="torneoMessage" class="success-message"></div>
                <div id="torneoError" class="error-message"></div>
            </div>

            <div class="card">
                <h3>üóìÔ∏è Torneos Existentes</h3>
                <p style="font-size: 0.9rem; color: #ffc107; margin-bottom: 15px;">Selecciona el torneo que estar√° **activo**. Todas las nuevas estad√≠sticas se guardar√°n en este torneo.</p>
                <button class="btn-secondary" onclick="desactivarTodosLosTorneos()" style="background: #ff9800; margin-bottom: 15px; font-weight: bold;">‚ö™ Desactivar Todos</button>
                <div class="table-container">
                    <table id="torneosTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre del Torneo</th>
                                <th>Fecha de Creaci√≥n</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="loading">Cargando torneos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ‚úÖ INICIO CORRECCI√ìN: Script de navegaci√≥n para el Dashboard
        function irATab(tabName, panelId) {
            // Activa la pesta√±a correcta usando el atributo data-tab
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.nav-tab[data-tab="${tabName.toLowerCase()}"]`);
            if (btn) btn.classList.add('active');

            // Muestra el panel de contenido correspondiente
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.add('active');
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        // ‚úÖ FIN CORRECCI√ìN

        // Variables globales
        let equipos = [];
        let partidos = [];
        let jugadores = [];
        let estadisticas = [];
        let torneoActivo = { id: null, nombre: 'NINGUNO' };
        
        // Sistema de debounce para optimizar b√∫squedas
        let debounceTimers = {};
        function debounce(func, delay, key) {
            return function(...args) {
                if (debounceTimers[key]) {
                    clearTimeout(debounceTimers[key]);
                }
                debounceTimers[key] = setTimeout(() => {
                    func.apply(this, args);
                    delete debounceTimers[key];
                }, delay);
            };
        }
        
        // Versiones con debounce de las funciones de actualizaci√≥n
        const actualizarTablaJugadoresDebounced = debounce(actualizarTablaJugadores, 300, 'jugadores');
        const actualizarTablaEquiposDebounced = debounce(actualizarTablaEquipos, 300, 'equipos');
        const actualizarTablaPartidosDebounced = debounce(actualizarTablaPartidos, 300, 'partidos');
        
        // ===== SISTEMA DE TOAST NOTIFICATIONS =====
        class ToastManager {
            constructor() {
                this.container = document.getElementById('toast-container');
                if (!this.container) {
                    this.container = document.createElement('div');
                    this.container.id = 'toast-container';
                    this.container.className = 'toast-container';
                    document.body.insertBefore(this.container, document.body.firstChild);
                }
            }
            show(message, type = 'info', duration = 4000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                        const icons = {
                    success: '‚úì',
                    error: '‚úó',
                    warning: '‚ö†',
                    info: '‚Ñπ'
                };
                        const titles = {
                    success: '√âxito',
                    error: 'Error',
                    warning: 'Advertencia',
                    info: 'Informaci√≥n'
                };
                        toast.innerHTML = `
                    <div class="toast-icon">${icons[type]}</div>
                    <div class="toast-content">
                        <div class="toast-title">${titles[type]}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
                `;
                        this.container.appendChild(toast);
                        // Auto-remove
                setTimeout(() => {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
                        return toast;
            }
                success(message, duration) {
                return this.show(message, 'success', duration || 3000);
            }
                error(message, duration) {
                return this.show(message, 'error', duration || 5000);
            }
                warning(message, duration) {
                return this.show(message, 'warning', duration || 4000);
            }
                info(message, duration) {
                return this.show(message, 'info', duration || 4000);
            }
        }
        // Instancia global
        const toast = new ToastManager();

        // ===== SISTEMA DE PAGINACI√ìN PARA TABLAS DE ESTAD√çSTICAS =====
        class TablePagination {
            constructor(tableId, itemsPerPage = 20) {
                this.tableId = tableId;
                this.itemsPerPage = itemsPerPage;
                this.currentPage = 1;
                this.allData = [];
                this.filteredData = [];
                this.searchTerm = '';
                this.selectedTeam = '';
            }
                setData(data) {
                this.allData = data;
                this.applyFilters();
            }
                applyFilters() {
                this.filteredData = this.allData.filter(item => {
                    const matchesSearch = !this.searchTerm || 
                        item.nombre.toLowerCase().includes(this.searchTerm.toLowerCase());
                    const matchesTeam = !this.selectedTeam || 
                        item.equipo_id == this.selectedTeam;
                    return matchesSearch && matchesTeam;
                });
                this.currentPage = 1; // Reset to first page
                this.render();
            }
                setSearch(term) {
                this.searchTerm = term;
                this.applyFilters();
            }
                setTeamFilter(teamId) {
                this.selectedTeam = teamId;
                this.applyFilters();
            }
                getTotalPages() {
                return Math.ceil(this.filteredData.length / this.itemsPerPage);
            }
                getCurrentPageData() {
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                return this.filteredData.slice(start, end);
            }
                goToPage(page) {
                const totalPages = this.getTotalPages();
                if (page < 1 || (totalPages > 0 && page > totalPages)) return;
                this.currentPage = page;
                this.render();
            }
                nextPage() {
                this.goToPage(this.currentPage + 1);
            }
                prevPage() {
                this.goToPage(this.currentPage - 1);
            }
                render() {
                // Implementado espec√≠ficamente para cada tabla
            }
        }
        // Instancias globales
        let paginationBateo, paginationPitcheo, paginationDefensa;

        const AJUSTES_POSICIONALES = {
            'C': 12.5, 'SS': 7.5, 'CF': 2.5, '2B': 3.0, '3B': 2.0,
            'RF': -7.5, 'LF': -7.0, '1B': -12.5, 'P': 0.0
        };
        
        let ordenJugadores = { campo: 'nombre', direccion: 'asc' };
        let ordenEquipos = { campo: 'nombre', direccion: 'asc' };
        let jugadoresFiltrados = [];
        let equiposFiltrados = [];

        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacion();
            configurarEventListeners();
            cargarTodosLosDatos();
            establecerFechaActual();
        });

        function verificarAutenticacion() {
            const userRole = localStorage.getItem('userRole');
            if (!userRole || userRole !== 'admin') {
                toast.error('Acceso denegado. Solo administradores pueden acceder.');
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.clear();
            toast.success('Sesi√≥n cerrada correctamente');
            window.location.href = 'login.html';
        }

        function establecerFechaActual() {
            const fechaInput = document.getElementById('fechaPartido');
            if (fechaInput) {
                fechaInput.value = new Date().toISOString().split('T')[0];
            }
        }

        function configurarEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => mostrarPestana(tab.dataset.tab));
            });
        }
        
        function mostrarPestana(nombrePestana) {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.style.opacity = '0';
                mainContent.style.transition = 'opacity 0.2s ease-out';
            }
            setTimeout(() => {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
                const pestanaActiva = document.getElementById(nombrePestana);
                if (pestanaActiva) pestanaActiva.classList.add('active');
                const botonActivo = document.querySelector(`[data-tab="${nombrePestana}"]`);
                // CORRECCI√ìN CR√çTICA: Cambiar 'botonActiva' a 'botonActivo'
                if (botonActivo) botonActivo.classList.add('active'); 
                if (nombrePestana === 'lideres') {
                    actualizarLideres();
                    actualizarLideresPorPosicion();
                    cargarTablaEditarBateo();
                    cargarTablaEditarPitcheo();
                    cargarTablaEditarDefensa();
                }
                if (nombrePestana === 'torneos') {
                    cargarTorneos();
                }
                if (nombrePestana === 'dashboard') {
                    cargarDashboard();
                }
                if(mainContent) mainContent.style.opacity = '1';
            }, 200);
        }

        async function cargarTodosLosDatos() {
            try {
                // Mostrar indicador de carga global
                console.log('üöÄ Iniciando carga de datos del sistema...');
                const startTime = performance.now();
        
                // Cargar torneo activo primero (cr√≠tico)
                await cargarTorneoActivo();
        
                // Cargar datos principales en paralelo (optimizaci√≥n)
                await Promise.all([
                    cargarEquipos(),
                    cargarJugadores(),
                    cargarPartidos()
                ]);
        
                // Cargar estad√≠sticas despu√©s (no bloqueante)
                await cargarEstadisticas();
        
                // Actualizar UI
                actualizarSelectores();
                calcularPosiciones();
                actualizarLideres();
                actualizarLideresPorPosicion();
        
                // Configurar filtros y validaciones
                setTimeout(() => {
                    if (typeof configurarFiltrosEnTiempoReal === 'function') {
                        configurarFiltrosEnTiempoReal();
                    }
                    if (typeof configurarValidacionJugador === 'function') {
                        configurarValidacionJugador();
                    }
                    console.log('‚úÖ Validaciones en tiempo real activadas');
                }, 500);
        
                // Log de performance
                const endTime = performance.now();
                const loadTime = ((endTime - startTime) / 1000).toFixed(2);
                console.log(`‚úÖ Sistema cargado en ${loadTime} segundos`);
        
            } catch (error) {
                console.error('Error cargando datos:', error);
                toast.error('Error de conexi√≥n con el servidor');
            }
        }

        async function agregarJugador() {
            const nombre = document.getElementById('nombreJugador')?.value?.trim();
            const equipoId = document.getElementById('equipoJugador')?.value;
            const posicion = document.getElementById('posicionJugador')?.value || null;
            const numeroInput = document.getElementById('numeroJugador')?.value;
            const numero = numeroInput ? parseInt(numeroInput) : null;
        
            // Validaciones
            if (!nombre) {
                toast.warning('El nombre del jugador es obligatorio');
                return;
            }
            if (nombre.length < 3) {
                toast.warning('El nombre debe tener al menos 3 caracteres');
                return;
            }
        
            const jugadorData = {
                nombre: nombre,
                equipo_id: equipoId ? parseInt(equipoId) : null,
                posicion: posicion,
                numero: numero
            };
        
            console.log('üì§ Enviando jugador:', jugadorData);
        
            try {
                const response = await fetch('/api/jugadores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jugadorData)
                });
        
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Error ${response.status}: ${errorData}`);
                }
        
                const resultado = await response.json();
                console.log('‚úÖ Jugador creado:', resultado);
        
                toast.success('Jugador agregado exitosamente');
                document.getElementById('jugadorForm').reset();
        
                // Limpiar validaci√≥n visual
                const nombreInput = document.getElementById('nombreJugador');
                const errorDiv = document.getElementById('nombreJugador-error');
                if (nombreInput) nombreInput.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                if (errorDiv) errorDiv.style.display = 'none';
        
                await cargarJugadores();
        
            } catch (error) {
                console.error('‚ùå Error agregando jugador:', error);
                toast.error(`Error: ${error.message}`);
            }
        }
        
        // Validaci√≥n en tiempo real para el formulario de jugadores
        function configurarValidacionJugador() {
            const nombreInput = document.getElementById('nombreJugador');
            if (!nombreInput) return;
        
            // Crear contenedor de error si no existe
            if (!document.getElementById('nombreJugador-error')) {
                const errorDiv = document.createElement('div');
                errorDiv.id = 'nombreJugador-error';
                errorDiv.className = 'field-error';
                errorDiv.style.display = 'none';
                nombreInput.parentElement.appendChild(errorDiv);
            }
        
            nombreInput.addEventListener('input', debounce(function() {
                const valor = this.value.trim();
                const errorDiv = document.getElementById('nombreJugador-error');
                const btnAgregar = document.getElementById('btn-agregar-jugador');
        
                if (valor.length === 0) {
                    errorDiv.textContent = '';
                    errorDiv.style.display = 'none';
                    nombreInput.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                    btnAgregar.disabled = false;
                } else if (valor.length < 3) {
                    errorDiv.textContent = '‚ö†Ô∏è El nombre debe tener al menos 3 caracteres';
                    errorDiv.style.display = 'block';
                    errorDiv.style.color = '#ffa500';
                    nombreInput.style.borderColor = '#ffa500';
                    btnAgregar.disabled = true;
                } else if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(valor)) {
                    errorDiv.textContent = '‚ö†Ô∏è Solo se permiten letras y espacios';
                    errorDiv.style.display = 'block';
                    errorDiv.style.color = '#ffa500';
                    nombreInput.style.borderColor = '#ffa500';
                    btnAgregar.disabled = true;
                } else {
                    errorDiv.textContent = '‚úì Nombre v√°lido';
                    errorDiv.style.display = 'block';
                    errorDiv.style.color = '#4CAF50';
                    nombreInput.style.borderColor = '#4CAF50';
                    btnAgregar.disabled = false;
                }
            }, 300, 'validacion-jugador'));
        }

        function calcularOBP(h, bb, ab) {
            if (ab + bb === 0) return 0;
            return (h + bb) / (ab + bb);
        }

        function calcularSLG(h, hr, ab) {
            if (ab === 0) return 0;
            return (h + hr * 3) / ab;
        }

        async function cargarEquipos() {
            try {
                console.log('üîÑ Cargando equipos...');
                const response = await fetch('/api/equipos');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Datos recibidos de /api/equipos:', data);
                
                // Asegurar que sea un array
                equipos = Array.isArray(data) ? data : [];
                
                console.log(`‚úÖ Equipos cargados correctamente: ${equipos.length} registros`);
                equiposFiltrados = [...equipos];
                actualizarTablaEquipos();
                actualizarSelectores();
                
            } catch (error) {
                console.error('‚ùå Error cargando equipos:', error);
                equipos = [];
                equiposFiltrados = [];
                
                const errorContainer = document.getElementById('equipoError');
                if (errorContainer) {
                    errorContainer.textContent = 'Error al cargar equipos. Intenta recargar la p√°gina.';
                    errorContainer.style.display = 'block';
                }
            }
        }

        async function cargarPartidos() {
            try {
                console.log('üîÑ Cargando partidos...');
                const response = await fetch('/api/partidos?limit=1000');
                        
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                        
                const data = await response.json();
                console.log('üì¶ Datos recibidos de /api/partidos:', data);
                        
                // CORRECCI√ìN: Manejo robusto de diferentes formatos de respuesta
                if (!data) {
                    partidos = [];
                } else if (Array.isArray(data)) {
                    partidos = data;
                } else if (data.partidos && Array.isArray(data.partidos)) {
                    partidos = data.partidos;
                } else if (data.data && Array.isArray(data.data)) {
                    partidos = data.data;
                } else {
                    console.warn('‚ö†Ô∏è Formato inesperado de partidos:', data);
                    partidos = [];
                }
                
                console.log(`‚úÖ Partidos cargados correctamente: ${partidos.length} registros`);
                actualizarTablaPartidos();
                
            } catch (error) {
                console.error('‚ùå Error cargando partidos:', error);
                partidos = [];
                
                const errorContainer = document.getElementById('partidoError');
                if (errorContainer) {
                    errorContainer.textContent = 'Error al cargar partidos. Intenta recargar la p√°gina.';
                    errorContainer.style.display = 'block';
                }
            }
        }

        async function cargarJugadores() {
            try {
                console.log('üîÑ Cargando jugadores...');
                const response = await fetch('/api/jugadores?limit=1000');
                        
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                        
                const data = await response.json();
                console.log('üì¶ Datos recibidos de /api/jugadores:', data);
                        
                // CORRECCI√ìN: Manejo robusto de diferentes formatos de respuesta
                if (!data) {
                    jugadores = [];
                } else if (Array.isArray(data)) {
                    jugadores = data;
                } else if (data.jugadores && Array.isArray(data.jugadores)) {
                    jugadores = data.jugadores;
                } else if (data.data && Array.isArray(data.data)) {
                    jugadores = data.data;
                } else {
                    console.warn('‚ö†Ô∏è Formato inesperado de jugadores:', data);
                    jugadores = [];
                }
                
                console.log(`‚úÖ Jugadores cargados correctamente: ${jugadores.length} registros`);
                jugadoresFiltrados = [...jugadores];
                
                setTimeout(() => {
                    configurarFiltrosEnTiempoReal();
                    actualizarTablaJugadores();
                }, 100);
                
                actualizarSelectores();
                
            } catch (error) {
                console.error('‚ùå Error cargando jugadores:', error);
                jugadores = [];
                jugadoresFiltrados = [];
                
                const errorContainer = document.getElementById('jugadorError');
                if (errorContainer) {
                    errorContainer.textContent = 'Error al cargar jugadores. Intenta recargar la p√°gina.';
                    errorContainer.style.display = 'block';
                }
            }
        }

        function actualizarTablaJugadores() {
            const buscador = document.getElementById('buscadorJugadores').value.toLowerCase().trim();
            const filtroEquipo = document.getElementById('filtroRosterEquipo').value;
            const filtroPosicion = document.getElementById('filtroPosicion')?.value || '';

            // Filtrar jugadores
            jugadoresFiltrados = jugadores.filter(jugador => {
                const coincideNombre = jugador.nombre.toLowerCase().includes(buscador);
                const coincideEquipo = !filtroEquipo || jugador.equipo_id == filtroEquipo;
                const coincidePosicion = !filtroPosicion || jugador.posicion === filtroPosicion;
                return coincideNombre && coincideEquipo && coincidePosicion;
            });

            // Aplicar ordenamiento si existe
            if (ordenJugadores.campo) {
                jugadoresFiltrados.sort((a, b) => {
                    let valorA = a[ordenJugadores.campo] || '';
                    let valorB = b[ordenJugadores.campo] || '';

                    if (ordenJugadores.campo === 'equipo_nombre') {
                        valorA = a.equipo_nombre || '';
                        valorB = b.equipo_nombre || '';
                    }

                    if (typeof valorA === 'string') {
                        valorA = valorA.toLowerCase();
                        valorB = valorB.toLowerCase();
                    }

                    let comparacion = valorA < valorB ? -1 : valorA > valorB ? 1 : 0;
                    return ordenJugadores.direccion === 'desc' ? -comparacion : comparacion;
                });
            }

            // Actualizar contador
            const counter = document.getElementById('jugadores-count');
            if (counter) {
                counter.textContent = `Total: ${jugadoresFiltrados.length} jugadores`;
            }

            // Renderizar tabla
            renderizarTablaJugadores();
        }

        function ordenarTablaJugadores(campo) {
            console.log('Ordenando por campo:', campo);

            // Cambiar direcci√≥n si es el mismo campo
            if (ordenJugadores.campo === campo) {
                ordenJugadores.direccion = ordenJugadores.direccion === 'asc' ? 'desc' : 'asc';
            } else {
                ordenJugadores.campo = campo;
                ordenJugadores.direccion = 'asc';
            }

            // Limpiar todos los indicadores
            document.querySelectorAll('#jugadoresTable .sort-indicator').forEach(el => {
                el.className = 'sort-indicator';
            });

            // Agregar indicador al campo activo
            const targetHeader = document.querySelector(`#jugadoresTable th[onclick*="${campo}"] .sort-indicator`);
            if (targetHeader) {
                targetHeader.className = `sort-indicator ${ordenJugadores.direccion}`;
            }

            // Actualizar tabla
            actualizarTablaJugadores();
            console.log(`Ordenado por ${campo} ${ordenJugadores.direccion}`);
        }

        function actualizarTablaEquipos() {
            const buscador = document.getElementById('buscadorEquipos')?.value?.toLowerCase().trim() || '';

            equiposFiltrados = equipos.filter(equipo => {
                return equipo.nombre.toLowerCase().includes(buscador) ||
                    equipo.manager.toLowerCase().includes(buscador) ||
                    equipo.ciudad.toLowerCase().includes(buscador);
            });

            // Aplicar ordenamiento
            if (ordenEquipos.campo) {
                equiposFiltrados.sort((a, b) => {
                    let valorA = a[ordenEquipos.campo] || '';
                    let valorB = b[ordenEquipos.campo] || '';

                    if (typeof valorA === 'string') {
                        valorA = valorA.toLowerCase();
                        valorB = valorB.toLowerCase();
                    }

                    let comparacion = valorA < valorB ? -1 : valorA > valorB ? 1 : 0;
                    return ordenEquipos.direccion === 'desc' ? -comparacion : comparacion;
                });
            }

            // Actualizar contador
            if (document.getElementById('equipos-count')) {
                document.getElementById('equipos-count').textContent = `Total: ${equiposFiltrados.length} equipos`;
            }

            renderizarTablaEquipos();
        }

        function actualizarTablaPartidos() {
            const filtroEquipo = document.getElementById('filtroEquipoPartidos')?.value || '';
            const filtroEstado = document.getElementById('filtroEstadoPartidos')?.value || '';
            const filtroFecha = document.getElementById('filtroFechaPartidos')?.value || '';

            let partidosFiltrados = partidos.filter(partido => {
                const coincideEquipo = !filtroEquipo || 
                    partido.equipo_local_id == filtroEquipo || 
                    partido.equipo_visitante_id == filtroEquipo;
                
                const coincideEstado = !filtroEstado || 
                    (filtroEstado === 'programado' && partido.estado === 'programado') ||
                    (filtroEstado === 'finalizado' && partido.estado === 'finalizado') ||
                    (filtroEstado === 'cancelado' && partido.estado === 'cancelado');
                
                const coincideFecha = !filtroFecha || 
                    partido.fecha_partido?.startsWith(filtroFecha);

                return coincideEquipo && coincideEstado && coincideFecha;
            });

            // Actualizar contador
            if (document.getElementById('partidos-count')) {
                document.getElementById('partidos-count').textContent = `Total: ${partidosFiltrados.length} partidos`;
            }

            // Renderizar tabla
            const tbody = document.querySelector('#partidosTable tbody');
            if (!tbody) return;

            if (partidosFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state" style="padding: 40px 20px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üéØ</div>
                            <h3 style="color: #ffc107; margin-bottom: 10px;">No se encontraron partidos</h3>
                            <p style="color: #fff; opacity: 0.7; font-size: 0.9rem;">
                                Intenta ajustar los filtros o programa un nuevo partido usando los formularios de arriba
                            </p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = partidosFiltrados.map(partido => {
                const resultado = partido.carreras_local !== null 
                    ? `${partido.carreras_local} - ${partido.carreras_visitante}`
                    : '---';
                
                const fecha = partido.fecha_partido 
                    ? new Date(partido.fecha_partido).toLocaleDateString('es-AR')
                    : '-';
                
                const hora = partido.hora || '---';

                const estadoBadge = 
                    partido.estado === 'programado' ? '<span style="color: #ffc107;">üìÖ Programado</span>' :
                    partido.estado === 'finalizado' ? '<span style="color: #4CAF50;">‚úÖ Finalizado</span>' :
                    partido.estado === 'cancelado' ? '<span style="color: #f44336;">‚ùå Cancelado</span>' :
                    (partido.carreras_local !== null ? '<span style="color: #4CAF50;">‚úÖ Finalizado</span>' : '---');


                return `
                    <tr>
                        <td>${partido.equipo_local_nombre}</td>
                        <td>${partido.equipo_visitante_nombre}</td>
                        <td>${resultado}</td>
                        <td>${fecha}</td>
                        <td>${hora}</td>
                        <td>${estadoBadge}</td>
                        <td>
                            <button class="btn-secondary btn-edit" onclick="editarPartido(${partido.id})">‚úèÔ∏è</button>
                            <button class="btn-secondary" onclick="eliminarPartido(${partido.id})" style="background: #f44336;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function configurarFiltrosEnTiempoReal() {
            console.log('Configurando filtros en tiempo real...');

            // Jugadores
            const buscadorJugadores = document.getElementById('buscadorJugadores');
            if (buscadorJugadores) {
                buscadorJugadores.removeEventListener('input', actualizarTablaJugadoresDebounced);
                buscadorJugadores.addEventListener('input', actualizarTablaJugadoresDebounced);
                console.log('‚úÖ Buscador de jugadores configurado con debounce (300ms)');
            }

            const filtroEquipo = document.getElementById('filtroRosterEquipo');
            if (filtroEquipo) {
                filtroEquipo.removeEventListener('change', actualizarTablaJugadores);
                filtroEquipo.addEventListener('change', actualizarTablaJugadores);
                console.log('‚úÖ Filtro de equipo configurado');
            }

            const filtroPosicion = document.getElementById('filtroPosicion');
            if (filtroPosicion) {
                filtroPosicion.removeEventListener('change', actualizarTablaJugadores);
                filtroPosicion.addEventListener('change', actualizarTablaJugadores);
                console.log('‚úÖ Filtro de posici√≥n configurado');
            }

            // Equipos
            const buscadorEquipos = document.getElementById('buscadorEquipos');
            if (buscadorEquipos) {
                buscadorEquipos.removeEventListener('input', actualizarTablaEquiposDebounced);
                buscadorEquipos.addEventListener('input', actualizarTablaEquiposDebounced);
                console.log('‚úÖ Buscador de equipos configurado con debounce (300ms)');
            }

            // Partidos
            const filtroEquipoPartidos = document.getElementById('filtroEquipoPartidos');
            const filtroEstadoPartidos = document.getElementById('filtroEstadoPartidos');
            const filtroFechaPartidos = document.getElementById('filtroFechaPartidos');

            if (filtroEquipoPartidos) {
                filtroEquipoPartidos.removeEventListener('change', actualizarTablaPartidos);
                filtroEquipoPartidos.addEventListener('change', actualizarTablaPartidos);
            }

            if (filtroEstadoPartidos) {
                filtroEstadoPartidos.removeEventListener('change', actualizarTablaPartidos);
                filtroEstadoPartidos.addEventListener('change', actualizarTablaPartidos);
            }

            if (filtroFechaPartidos) {
                filtroFechaPartidos.removeEventListener('change', actualizarTablaPartidos);
                filtroFechaPartidos.addEventListener('change', actualizarTablaPartidos);
            }

            console.log('Filtros configurados correctamente');
        }

        async function cargarDashboard() {
            try {
                // KPIs principales
                document.getElementById('total-equipos').textContent = equipos.length;
                document.getElementById('total-jugadores').textContent = jugadores.length;
                document.getElementById('total-partidos').textContent = partidos.length;

                // Equipos activos (con partidos jugados)
                const equiposActivos = new Set();
                partidos.forEach(p => {
                    if (p.carreras_local !== null) {
                        equiposActivos.add(p.equipo_local_id);
                        equiposActivos.add(p.equipo_visitante_id);
                    }
                });
                document.getElementById('equipos-activos').textContent = equiposActivos.size;

                // Partidos finalizados
                const partidosFinalizados = partidos.filter(p => p.carreras_local !== null).length;
                document.getElementById('partidos-finalizados').textContent = partidosFinalizados;

                // Porcentaje de finalizaci√≥n
                const porcentaje = partidos.length > 0 
                    ? Math.round((partidosFinalizados / partidos.length) * 100)
                    : 0;
                document.getElementById('porcentaje-finalizacion').textContent = `${porcentaje}%`;

                // Jugadores con estad√≠sticas
                document.getElementById('jugadores-stats').textContent = estadisticas.length;

                // Torneo activo
                document.getElementById('torneo-nombre').textContent = torneoActivo.nombre || 'NINGUNO';
                document.getElementById('torneo-status').textContent = torneoActivo.id ? '‚úÖ Activo' : '‚ö†Ô∏è Inactivo';

                // √öltima actualizaci√≥n
                const ahora = new Date();
                document.getElementById('ultima-actualizacion').textContent = 
                    ahora.toLocaleTimeString('es-AR');

                // Promedio general de bateo
                const avgGeneral = estadisticas.length > 0
                    ? (estadisticas.reduce((sum, e) => sum + (e.promedio_bateo || 0), 0) / estadisticas.length).toFixed(3)
                    : '0.000';
                document.getElementById('avg-general').textContent = avgGeneral;

                // Carreras promedio por partido
                const carrerasPromedio = partidosFinalizados > 0
                    ? Math.round(
                        partidos
                            .filter(p => p.carreras_local !== null)
                            .reduce((sum, p) => sum + p.carreras_local + p.carreras_visitante, 0) 
                        / partidosFinalizados
                    )
                    : 0;
                document.getElementById('carreras-promedio').textContent = carrerasPromedio;

                // Equipo l√≠der
                if (equipos.length > 0) {
                    const posiciones = calcularPosiciones();
                    if (posiciones && posiciones.length > 0) {
                        const lider = posiciones[0];
                        document.getElementById('equipo-lider').textContent = lider.nombre;
                        document.getElementById('record-lider').textContent = 
                            `${lider.victorias}-${lider.derrotas} (${lider.porcentaje}%)`;
                    } else {
                        document.getElementById('equipo-lider').textContent = 'N/A';
                        document.getElementById('record-lider').textContent = '0-0';
                    }
                }

                // √öltimos registros
                if (partidos.length > 0) {
                    const ultimoPartido = partidos[partidos.length - 1];
                    document.getElementById('ultimo-partido').textContent = 
                        `${ultimoPartido.equipo_local_nombre} vs ${ultimoPartido.equipo_visitante_nombre}`;
                }

                if (jugadores.length > 0) {
                    const ultimoJugador = jugadores[jugadores.length - 1];
                    document.getElementById('ultimo-jugador').textContent = ultimoJugador.nombre;
                }

                if (equipos.length > 0) {
                    const ultimoEquipo = equipos[equipos.length - 1];
                    document.getElementById('ultimo-equipo').textContent = ultimoEquipo.nombre;
                }

                // Generar alertas
                generarAlertas();

            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }
        
        function generarAlertas() {
            const alertasContainer = document.getElementById('alertas-container');
            if (!alertasContainer) return;

            const alertas = [];

            // Alerta de torneo activo
            if (!torneoActivo.id) {
                alertas.push({
                    tipo: 'warning',
                    mensaje: '‚ö†Ô∏è No hay torneo activo. Activa un torneo para comenzar a registrar partidos.',
                    accion: 'Activar Torneo'
                });
            }

            // Partidos pendientes
            const partidosPendientes = partidos.filter(p => p.carreras_local === null).length;
            if (partidosPendientes > 0) {
                alertas.push({
                    tipo: 'info',
                    mensaje: `üìÖ Hay ${partidosPendientes} partido(s) pendiente(s) de completar.`,
                    accion: 'Ver Partidos'
                });
            }

            // Jugadores sin estad√≠sticas
            const jugadoresSinStats = jugadores.length - estadisticas.length;
            if (jugadoresSinStats > 0) {
                alertas.push({
                    tipo: 'info',
                    mensaje: `üìä ${jugadoresSinStats} jugador(es) sin estad√≠sticas registradas.`,
                    accion: 'Registrar Estad√≠sticas'
                });
            }

            // Renderizar alertas
            if (alertas.length === 0) {
                alertasContainer.innerHTML = `
                    <div class="alerta alerta-success">
                        <strong>‚úÖ Sistema funcionando correctamente</strong>
                        <p>No hay alertas pendientes</p>
                    </div>
                `;
            } else {
                // ‚úÖ INICIO CORRECCI√ìN: A√±adir IDs a los botones
                alertasContainer.innerHTML = alertas.map(alerta => {
                    let buttonHtml = '';
                    if (alerta.accion) {
                        let buttonId = '';
                        if (alerta.accion === 'Ver Partidos') {
                            buttonId = 'id="btnVerPartidos"';
                        } else if (alerta.accion === 'Registrar Estad√≠sticas') {
                            buttonId = 'id="btnRegistrarStats"';
                        }
                        buttonHtml = `<button ${buttonId} class="btn-secondary">${alerta.accion}</button>`;
                    }
                    return `
                        <div class="alerta alerta-${alerta.tipo}">
                            <strong>${alerta.mensaje}</strong>
                            ${buttonHtml}
                        </div>
                    `;
                }).join('');
            }
            
            // ‚úÖ CORRECCI√ìN: Asignar eventos a los botones reci√©n creados
            document.getElementById('btnVerPartidos')?.addEventListener('click', () => irATab('partidos', 'partidos'));
            document.getElementById('btnRegistrarStats')?.addEventListener('click', () => irATab('lideres', 'lideres'));
            // ‚úÖ FIN CORRECCI√ìN
        }
        
        async function cargarTorneoActivo() {
            try {
                const response = await fetch('/api/torneos/activo');
                if (response.ok) {
                    const data = await response.json();
                    torneoActivo = (data && data.id) ? data : { id: null, nombre: 'NINGUNO' };
                } else {
                    torneoActivo = { id: null, nombre: 'NINGUNO' };
                }
            } catch (error) {
                console.error('Error al cargar torneo activo:', error);
                torneoActivo = { id: null, nombre: 'NINGUNO' };
            }
        }

        async function cargarTorneos() {
            try {
                const response = await fetch('/api/torneos');
                const torneosList = await response.json();
                const tbody = document.querySelector('#torneosTable tbody');
                if (!tbody) return;

                if (torneosList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No se han creado torneos.</td></tr>';
                    return;
                }

                tbody.innerHTML = torneosList.map(torneo => `
                    <tr>
                        <td>${torneo.id}</td>
                        <td><strong>${torneo.nombre}</strong></td>
                        <td>${new Date(torneo.fecha_creacion).toLocaleDateString('es-AR')}</td>
                        <td>
                            <span style="color: ${torneo.activo ? '#4CAF50' : '#ff9800'}; font-weight: bold;">
                                ${torneo.activo ? '‚úÖ ACTIVO' : '‚ö™ Inactivo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-activar" onclick="activarTorneo(${torneo.id})" ${torneo.activo ? 'disabled' : ''}>
                                Activar
                            </button>
                            <button class="btn-edit" onclick="editarTorneo(${torneo.id}, '${torneo.nombre.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                            <button class="btn-secondary" onclick="eliminarTorneo(${torneo.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error al cargar torneos:', error);
                const tbody = document.querySelector('#torneosTable tbody');
                if(tbody) tbody.innerHTML = '<tr><td colspan="5" class="empty-state" style="color:#f44336;">Error al cargar torneos.</td></tr>';
            }
        }

        async function crearTorneo() {
            const nombreInput = document.getElementById('nombreTorneo');
            const nombre = nombreInput.value.trim();
            if (!nombre) {
                toast.warning('El nombre del torneo es obligatorio.');
                return;
            }
            try {
                const response = await fetch('/api/torneos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre })
                });
                if (response.ok) {
                    toast.success('Torneo creado exitosamente.');
                    nombreInput.value = '';
                    await cargarTorneos();
                } else {
                    const error = await response.json();
                    toast.error(error.message || 'No se pudo crear el torneo.');
                }
            } catch (error) {
                toast.error('Error de conexi√≥n al crear torneo.');
            }
        }

        async function editarTorneo(id, nombreActual) {
            const nuevoNombre = prompt("Editar nombre del torneo:", nombreActual);
            if (nuevoNombre && nuevoNombre.trim() && nuevoNombre.trim() !== nombreActual) {
                try {
                    const response = await fetch(`/api/torneos/${id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ nombre: nuevoNombre.trim() })
                    });
                    if (response.ok) {
                        toast.success('Torneo actualizado correctamente.');
                        await cargarTorneos();
                        if (torneoActivo.id === id) {
                            await cargarTorneoActivo();
                        }
                    } else {
                        toast.error('No se pudo actualizar el torneo.');
                    }
                } catch (e) {
                    toast.error('Error de conexi√≥n.');
                }
            }
        }

        async function activarTorneo(id) {
            try {
                const response = await fetch(`/api/torneos/${id}/activar`, { method: 'PUT' });
                if (response.ok) {
                    toast.success('Torneo activado.');
                    await cargarTorneoActivo();
                    await cargarTorneos();
                } else {
                    toast.error('Error al activar el torneo.');
                }
            } catch(e) {
                toast.error('Error de conexi√≥n.');
            }
        }

        async function desactivarTodosLosTorneos() {
            if (!confirm('¬øDesactivar todos los torneos? Ninguno quedar√° como activo.')) return;
            try {
                const response = await fetch(`/api/torneos/desactivar-todos`, { method: 'PUT' });
                if (response.ok) {
                    toast.info('Todos los torneos han sido desactivados.');
                    await cargarTorneoActivo();
                    await cargarTorneos();
                } else {
                    toast.error('Error al desactivar torneos.');
                }
            } catch(e) {
                toast.error('Error de conexi√≥n.');
            }
        }

        async function eliminarTorneo(id) {
            if (!confirm('¬øSeguro que quieres eliminar este torneo? Se borrar√°n todas sus estad√≠sticas asociadas.')) return;
            try {
                const response = await fetch(`/api/torneos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    toast.success('Torneo eliminado correctamente.');
                    await cargarTorneos();
                    if(torneoActivo.id === id) {
                        await cargarTorneoActivo();
                    }
                } else {
                    toast.error('Error al eliminar el torneo.');
                }
            } catch(e) {
                toast.error('Error de conexi√≥n.');
            }
        }

        async function cargarEstadisticas() {
            try {
                const [ofensivasRes, defensivasRes, pitcheoRes] = await Promise.all([
                    fetch('/api/estadisticas-ofensivas'),
                    fetch('/api/estadisticas-defensivas'),
                    fetch('/api/estadisticas-pitcheo')
                ]);

                const ofensivas = ofensivasRes.ok ? await ofensivasRes.json() : [];
                const defensivas = defensivasRes.ok ? await defensivasRes.json() : [];
                const pitcheo = pitcheoRes.ok ? await pitcheoRes.json() : [];

                const statsMap = new Map();

                const mergeStats = (statList) => {
                    statList.forEach(stat => {
                        const existing = statsMap.get(stat.jugador_id) || { jugador_id: stat.jugador_id };
                        statsMap.set(stat.jugador_id, { ...existing, ...stat });
                    });
                };

                mergeStats(ofensivas);
                mergeStats(defensivas);
                mergeStats(pitcheo);

                estadisticas = Array.from(statsMap.values());
                actualizarTablaEstadisticas();
            } catch (error) {
                console.error("Error cargando todas las estad√≠sticas:", error);
                estadisticas = [];
            }
        }

        function calcularWAR(jugador, stats) {
            const { at_bats = 0, hits = 0, home_runs = 0, walks = 0 } = stats;
            const pa = at_bats + walks;
            if (pa === 0) return 0;

            const wOBA = (0.69 * walks + 0.89 * (hits - home_runs) + 2.1 * home_runs) / pa;
            const leagueWOBA = 0.320;
            const wRAA = ((wOBA - leagueWOBA) / 1.25) * pa;

            const positionalAdjustment = AJUSTES_POSICIONALES[jugador.posicion] || 0;
            const replacementRuns = (pa / 600) * 20;
            
            const totalRuns = wRAA + positionalAdjustment - replacementRuns;
            const war = totalRuns / 10;
            return isNaN(war) ? 0.0 : war;
        }

        function actualizarTablaEstadisticas() {
            const tbody = document.querySelector('#statsTable tbody');
            if (!tbody) return;

            const statsConJugador = estadisticas.map(stat => {
                const jugador = jugadores.find(j => j.id === stat.jugador_id);
                if (!jugador) return null;
                return { ...stat, ...jugador, jugador_nombre: jugador.nombre, equipo_nombre: jugador.equipo_nombre };
            }).filter(Boolean);

            if (statsConJugador.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">No hay estad√≠sticas para mostrar.</td></tr>';
                return;
            }
            
            tbody.innerHTML = statsConJugador.map(s => {
                const ab = s.at_bats || 0;
                const h = s.hits || 0;
                const hr = s.home_runs || 0;
                const bb = s.walks || 0;
                const avg = ab > 0 ? (h / ab).toFixed(3) : '.000';
                const obp = calcularOBP(h, bb, ab);
                const slg = calcularSLG(h, hr, ab);
                const ops = (obp + slg).toFixed(3);
                const war = calcularWAR(s, s).toFixed(2);

                return `
                    <tr>
                        <td><strong>${s.jugador_nombre}</strong></td>
                        <td>${s.equipo_nombre}</td>
                        <td>${s.posicion || 'N/A'}</td>
                        <td>${ab}</td>
                        <td>${h}</td>
                        <td style="font-weight: bold; color: #ffc107;">${avg}</td>
                        <td>${obp.toFixed(3)}</td>
                        <td style="font-weight: bold; color: #ff9800;">${ops}</td>
                        <td>${hr || 0}</td>
                        <td>${s.rbi || 0}</td>
                        <td style="font-weight: bold; color: #4CAF50;">${war}</td>
                    </tr>
                `;
            }).join('');
        }

        async function actualizarLideresPorPosicion() {
            try {
                const response = await fetch('/api/estadisticas-defensivas');
                if (!response.ok) throw new Error('Failed to fetch defensive stats');
                const defensivas = await response.json();
                
                const grid = document.getElementById('positionLeadersGrid');
                if (!grid) return;
                grid.innerHTML = '';
                
                const posGroups = {};
                defensivas.forEach(stat => {
                    const player = jugadores.find(j => j.id === stat.jugador_id);
                    if (!player || !player.posicion) return;
                    
                    if (!posGroups[player.posicion]) posGroups[player.posicion] = [];
                    const po = stat.putouts || 0;
                    const a = stat.assists || 0;
                    const e = stat.errors || 0;
                    const chances = po + a + e;
                    const rating = chances > 0 ? ((po + a) / chances) : 1;
                    posGroups[player.posicion].push({ ...player, rating: rating.toFixed(3) });
                });
                
                Object.keys(AJUSTES_POSICIONALES).forEach(pos => {
                    const leaders = (posGroups[pos] || []).sort((a,b) => b.rating - a.rating).slice(0,3);
                    
                    let leaderHtml = `<div class="position-leader empty-state" style="padding: 10px 0;">Sin datos</div>`;
                    if (leaders.length > 0) {
                        leaderHtml = leaders.map(l => `
                            <div class="position-leader-item">
                                <div class="position-player-container">
                                    <div>
                                        <div class="position-player">${l.nombre}</div>
                                        <div class="position-team">${l.equipo_nombre}</div>
                                    </div>
                                    <div class="position-rating">${l.rating}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    grid.innerHTML += `
                        <div class="position-card">
                            <div class="position-title">üõ°Ô∏è MEJORES ${pos} (FLD%)</div>
                            <div class="position-leader">${leaderHtml}</div>
                        </div>`;
                });
                if(grid.innerHTML === '') grid.innerHTML = `<p class="empty-state">No hay suficientes datos defensivos.</p>`;
            } catch (error) {
                console.error(error);
            }
        }

        function calcularPosiciones() {
            const tbody = document.querySelector('#posicionesTable tbody');
            if (!tbody) return []; // Retornar array vac√≠o para el dashboard
            if (equipos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="empty-state">No hay equipos registrados.</td></tr>`;
                return [];
            }

            const standings = new Map(equipos.map(e => [e.id, { id: e.id, nombre: e.nombre, PJ: 0, PG: 0, PP: 0, CF: 0, CE: 0 }]));
            
            partidos.forEach(p => {
                if (p.carreras_local !== null && p.carreras_visitante !== null) {
                    const local = standings.get(p.equipo_local_id);
                    const visitante = standings.get(p.equipo_visitante_id);
                    
                    if (!local || !visitante) return;
                    
                    local.PJ++; visitante.PJ++;
                    local.CF += p.carreras_local; visitante.CF += p.carreras_visitante;
                    local.CE += p.carreras_visitante; visitante.CE += p.carreras_local;

                    if (p.carreras_local > p.carreras_visitante) {
                        local.PG++; visitante.PP++;
                    } else if (p.carreras_visitante > p.carreras_local) {
                        visitante.PG++; local.PP++;
                    }
                }
            });

            const sorted = [...standings.values()].sort((a, b) => {
                const pctA = a.PJ > 0 ? a.PG / a.PJ : 0;
                const pctB = b.PJ > 0 ? b.PG / b.PJ : 0;
                if (pctB > pctA) return 1;
                if (pctA > pctB) return -1;
                const diffA = a.CF - a.CE;
                const diffB = b.CF - b.CE;
                return diffB - diffA;
            });
            
            if (sorted.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="empty-state">No hay partidos jugados.</td></tr>`;
                return [];
            }

            tbody.innerHTML = sorted.map((team, index) => {
                const pct = team.PJ > 0 ? (team.PG / team.PJ).toFixed(3) : '.000';
                const diff = team.CF - team.CE;
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${team.nombre}</strong></td>
                        <td>${team.PJ}</td>
                        <td style="color:#4CAF50;">${team.PG}</td>
                        <td style="color:#f44336;">${team.PP}</td>
                        <td>${pct}</td>
                        <td>${team.CF}</td>
                        <td>${team.CE}</td>
                        <td>${diff > 0 ? `+${diff}` : diff}</td>
                        <td>-</td>
                    </tr>
                `;
            }).join('');

            // Devolver para el dashboard
            return sorted.map(t => ({
                nombre: t.nombre,
                victorias: t.PG,
                derrotas: t.PP,
                porcentaje: t.PJ > 0 ? ((t.PG / t.PJ) * 100).toFixed(1) : '0.0'
            }));
        }


        async function actualizarLideres() {
            if (estadisticas.length === 0 || jugadores.length === 0) {
                ['avgLeaders', 'hrLeaders', 'rbiLeaders', 'opsLeaders', 'warLeaders', 'sbLeaders'].forEach(mostrarLideresVacios);
                return;
            }
            const minAB = 10;
            const enrichedStats = estadisticas
                .map(stat => {
                    const jugador = jugadores.find(j => j.id === stat.jugador_id);
                    return jugador ? { ...stat, ...jugador, jugador_nombre: jugador.nombre, equipo_nombre: jugador.equipo_nombre } : null;
                })
                .filter(s => s && s.at_bats > 0);

            const qualified = enrichedStats.filter(s => s.at_bats >= minAB);

            actualizarLideresHTML('avgLeaders', [...qualified].sort((a,b) => (b.hits/b.at_bats) - (a.hits/a.at_bats)).slice(0,3), 'avg', true);
            actualizarLideresHTML('hrLeaders', [...enrichedStats].sort((a,b) => (b.home_runs || 0) - (a.home_runs || 0)).slice(0,3), 'home_runs');
            actualizarLideresHTML('rbiLeaders', [...enrichedStats].sort((a,b) => (b.rbi || 0) - (a.rbi || 0)).slice(0,3), 'rbi');
            actualizarLideresHTML('sbLeaders', [...enrichedStats].sort((a,b) => (b.stolen_bases || 0) - (a.stolen_bases || 0)).slice(0,3), 'stolen_bases');

            const opsLeaders = qualified.map(s => {
                const obp = calcularOBP(s.hits || 0, s.walks || 0, s.at_bats);
                const slg = calcularSLG(s.hits || 0, s.home_runs || 0, s.at_bats);
                s.ops = obp + slg;
                return s;
            }).sort((a,b) => b.ops - a.ops).slice(0,3);
            actualizarLideresHTML('opsLeaders', opsLeaders, 'ops', true);

            const warLeaders = enrichedStats.map(s => {
                s.war = calcularWAR(s, s);
                return s;
            }).sort((a,b) => b.war - a.war).slice(0,3);
            actualizarLideresHTML('warLeaders', warLeaders, 'war', true);
        }

        function mostrarLideresVacios(containerId) {
            const container = document.getElementById(containerId);
            if(container) container.innerHTML = `<div class="leader-item"><div class="leader-name" style="font-style: italic; color: #aaa;">Sin datos suficientes</div></div>`;
        }

        function actualizarLideresHTML(containerId, lideres, stat, isDecimal = false) {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (!lideres || lideres.length === 0) {
                mostrarLideresVacios(containerId);
                return;
            }
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const medalClasses = ['gold-medal', 'silver-medal', 'bronze-medal'];

            container.innerHTML = lideres.map((l, index) => {
                let statValue;
                if (stat === 'avg') statValue = (l.hits / l.at_bats).toFixed(3);
                else if (stat === 'ops') statValue = l.ops.toFixed(3);
                else if (stat === 'war') statValue = l.war.toFixed(2);
                else statValue = l[stat] || 0;
                
                return `
                <div class="leader-item">
                    <div>
                        <div class="leader-name ${medalClasses[index]}">${medals[index]} ${l.jugador_nombre}</div>
                        <div class="leader-team">${l.equipo_nombre || 'Sin equipo'}</div>
                    </div>
                    <div class="leader-stat">${statValue}</div>
                </div>`;
            }).join('');
        }

        function actualizarSelectores() {
            const equipoOptions = equipos.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
            // Selectores existentes
            ['equipoLocal', 'equipoVisitante', 'equipoJugador', 'filtroEquipoPartidos', 'filtroRosterEquipo'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const first = select.options[0].outerHTML;
                    select.innerHTML = first + equipoOptions;
                }
            });
            // NUEVO: Selectores para programar partido
            ['equipoLocalFuturo', 'equipoVisitanteFuturo'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const first = select.options[0].outerHTML;
                    select.innerHTML = first + equipoOptions;
                }
            });
            const jugadorOptions = jugadores.map(j => `<option value="${j.id}">${j.nombre} (${j.equipo_nombre || 'N/A'})</option>`).join('');
            ['jugadorStats', 'jugadorPitcheo', 'jugadorDefensivo'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    const first = select.options[0].outerHTML;
                    select.innerHTML = first + jugadorOptions;
                }
            });
        }

        async function agregarEquipo() {
            const nombre = document.getElementById('nombreEquipo').value.trim();
            const manager = document.getElementById('managerEquipo').value.trim();
            const ciudad = document.getElementById('ciudadEquipo').value.trim();
            if(!nombre || !manager || !ciudad) {
                toast.warning('Todos los campos son obligatorios');
                return;
            }
            
            try {
                const res = await fetch('/api/equipos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nombre, manager, ciudad })
                });
                if(res.ok) {
                    toast.success('Equipo agregado exitosamente.');
                    document.getElementById('nombreEquipo').value = '';
                    document.getElementById('managerEquipo').value = '';
                    document.getElementById('ciudadEquipo').value = '';
                    await cargarEquipos();
                    actualizarSelectores();
                } else {
                    toast.error('No se pudo agregar el equipo');
                }
            } catch(e) {
                toast.error('Error de red.');
            }
        }

        async function programarPartido() {
            const equipo_local_id = document.getElementById('equipoLocalFuturo').value;
            const equipo_visitante_id = document.getElementById('equipoVisitanteFuturo').value;
            const fecha_partido = document.getElementById('fechaPartidoFuturo').value;
            const hora = document.getElementById('horaPartidoFuturo').value;
            const lugar = document.getElementById('lugarPartido').value.trim();
            // Validaciones
            if (!equipo_local_id || !equipo_visitante_id) {
                toast.warning('Debes seleccionar ambos equipos');
                return;
            }
            if (equipo_local_id === equipo_visitante_id) {
                toast.warning('Un equipo no puede jugar contra s√≠ mismo');
                return;
            }
            if (!fecha_partido) {
                toast.warning('La fecha del partido es obligatoria');
                return;
            }
            if (!hora) {
                toast.warning('La hora del partido es obligatoria');
                return;
            }
            const body = {
                equipo_local_id: parseInt(equipo_local_id),
                equipo_visitante_id: parseInt(equipo_visitante_id),
                fecha_partido,
                hora,
                estado: 'programado',
                lugar: lugar || null,
                carreras_local: null,
                carreras_visitante: null,
                innings: null
            };
            console.log('üì§ Programando partido:', body);
            try {
                const res = await fetch('/api/partidos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                        
                if (res.ok) {
                    toast.success('Partido programado exitosamente');
                    // Limpiar formulario
                    document.getElementById('equipoLocalFuturo').value = '';
                    document.getElementById('equipoVisitanteFuturo').value = '';
                    document.getElementById('fechaPartidoFuturo').value = '';
                    document.getElementById('horaPartidoFuturo').value = '';
                    document.getElementById('lugarPartido').value = '';
                    // Recargar tabla
                    await cargarPartidos();
                } else {
                    const error = await res.text();
                    toast.error('Error al programar partido: ' + error);
                }
            } catch (e) {
                console.error('Error:', e);
                toast.error('Error de conexi√≥n con el servidor');
            }
        }

        async function registrarPartido() {
            const equipo_local_id = document.getElementById('equipoLocal').value;
            const equipo_visitante_id = document.getElementById('equipoVisitante').value;
            const carreras_local = document.getElementById('carrerasLocal').value;
            const carreras_visitante = document.getElementById('carrerasVisitante').value;
            const fecha_partido = document.getElementById('fechaPartido').value;

            if (!equipo_local_id || !equipo_visitante_id || !fecha_partido) {
                toast.warning('Equipos y fecha son obligatorios.');
                return;
            }
            if (equipo_local_id === equipo_visitante_id) {
                toast.warning('Un equipo no puede jugar contra s√≠ mismo.');
                return;
            }

            const body = {
                equipo_local_id,
                equipo_visitante_id,
                fecha_partido,
                carreras_local: carreras_local !== "" ? parseInt(carreras_local) : null,
                carreras_visitante: carreras_visitante !== "" ? parseInt(carreras_visitante) : null,
                estado: 'finalizado'
            };

            try {
                const res = await fetch('/api/partidos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    toast.success('Partido registrado exitosamente.');
                    await cargarPartidos();
                    calcularPosiciones();
                    document.getElementById('equipoLocal').value = '';
                    document.getElementById('equipoVisitante').value = '';
                    document.getElementById('carrerasLocal').value = '';
                    document.getElementById('carrerasVisitante').value = '';
                } else {
                    toast.error('No se pudo registrar el partido');
                }
            } catch (e) {
                toast.error('Error de red.');
            }
        }

        async function registrarEstadisticas() {
            const jugador_id = document.getElementById('jugadorStats').value;
            if (!jugador_id) {
                toast.warning('Selecciona un jugador.');
                return;
            }
            
            const data = {
                jugador_id: parseInt(jugador_id),
                at_bats: parseInt(document.getElementById('atBats').value) || 0,
                hits: parseInt(document.getElementById('hits').value) || 0,
                doubles: parseInt(document.getElementById('doubles').value) || 0,
                triples: parseInt(document.getElementById('triples').value) || 0,
                home_runs: parseInt(document.getElementById('homeRuns').value) || 0,
                rbi: parseInt(document.getElementById('rbi').value) || 0,
                runs: parseInt(document.getElementById('runs').value) || 0,
                walks: parseInt(document.getElementById('walks').value) || 0,
                strikeouts: parseInt(document.getElementById('strikeouts').value) || 0,
                stolen_bases: parseInt(document.getElementById('stolenBases').value) || 0,
                caught_stealing: parseInt(document.getElementById('caughtStealing').value) || 0,
                hit_by_pitch: parseInt(document.getElementById('hitByPitch').value) || 0,
                sacrifice_flies: parseInt(document.getElementById('sacrificeFlies').value) || 0,
                sacrifice_hits: parseInt(document.getElementById('sacrificeHits').value) || 0
            };
            
            try {
                const res = await fetch('/api/estadisticas-ofensivas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    toast.success('Estad√≠sticas registradas exitosamente.');
                    await cargarEstadisticas();
                    document.querySelectorAll('#plateAppearances, #atBats, #hits, #doubles, #triples, #homeRuns, #rbi, #runs, #walks, #strikeouts, #stolenBases, #caughtStealing, #hitByPitch, #sacrificeFlies, #sacrificeHits').forEach(el => el.value = 0);
                } else {
                    toast.error('Error al registrar estad√≠sticas.');
                }
            } catch(e) {
                toast.error('Error de red.');
            }
        }

        async function eliminarEquipo(id) {
            const equipo = equipos.find(e => e.id === id);
            const nombreEquipo = equipo ? equipo.nombre : 'este equipo';
        
            // Confirmaci√≥n mejorada
            const confirmacion = confirm(
                `‚ö†Ô∏è ELIMINAR EQUIPO\n\n` +
                `¬øEst√°s seguro de eliminar al equipo "${nombreEquipo}"?\n\n` +
                `Esta acci√≥n NO se puede deshacer y se eliminar√°n:\n` +
                `‚Ä¢ Todos los jugadores asociados\n` +
                `‚Ä¢ Historial de partidos\n` +
                `‚Ä¢ Estad√≠sticas del equipo\n\n` +
                `Presiona OK para confirmar o Cancelar para abortar.`
            );
        
            if (!confirmacion) {
                toast.info('Eliminaci√≥n cancelada');
                return;
            }
        
            try {
                const res = await fetch(`/api/equipos/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    toast.success(`Equipo "${nombreEquipo}" eliminado correctamente.`);
                    await cargarEquipos();
                } else {
                    toast.error('Error al eliminar el equipo.');
                }
            } catch(e) {
                toast.error('Error de conexi√≥n con el servidor.');
            }
        }

        async function editarEquipo(id) {
            const equipo = equipos.find(e => e.id === id);
            if (!equipo) return;
            document.getElementById('nombreEquipo').value = equipo.nombre;
            document.getElementById('managerEquipo').value = equipo.manager;
            document.getElementById('ciudadEquipo').value = equipo.ciudad;
            document.getElementById('btn-agregar-equipo').textContent = '‚úÖ Actualizar';
            document.getElementById('btn-agregar-equipo').onclick = () => actualizarEquipo(id);
        }

        async function actualizarEquipo(id) {
            const nombre = document.getElementById('nombreEquipo').value.trim();
            const manager = document.getElementById('managerEquipo').value.trim();
            const ciudad = document.getElementById('ciudadEquipo').value.trim();
            if(!nombre || !manager || !ciudad) {
                toast.warning('Todos los campos son obligatorios');
                return;
            }
            
            try {
                const res = await fetch(`/api/equipos/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nombre, manager, ciudad })
                });
                if(res.ok) {
                    toast.success('Equipo actualizado correctamente.');
                    document.getElementById('nombreEquipo').value = '';
                    document.getElementById('managerEquipo').value = '';
                    document.getElementById('ciudadEquipo').value = '';
                    document.getElementById('btn-agregar-equipo').textContent = 'üèÜ Agregar Equipo';
                    document.getElementById('btn-agregar-equipo').onclick = agregarEquipo;
                    await cargarEquipos();
                } else {
                    toast.error('Error al actualizar equipo.');
                }
            } catch(e) {
                toast.error('Error de red.');
            }
        }

        async function editarJugador(id) {
            const jugador = jugadores.find(j => j.id === id);
            if (!jugador) return;
            document.getElementById('nombreJugador').value = jugador.nombre;
            document.getElementById('equipoJugador').value = jugador.equipo_id || '';
            document.getElementById('posicionJugador').value = jugador.posicion || '';
            document.getElementById('numeroJugador').value = jugador.numero || '';
            document.getElementById('btn-agregar-jugador').textContent = '‚úÖ Actualizar';
            document.getElementById('btn-agregar-jugador').onclick = () => actualizarJugador(id);
        }

        async function actualizarJugador(id) {
            const nombre = document.getElementById('nombreJugador').value.trim();
            const equipo_id = document.getElementById('equipoJugador').value || null;
            const posicion = document.getElementById('posicionJugador').value || null;
            const numero = document.getElementById('numeroJugador').value || null;
            
            if (!nombre || nombre.length < 3) {
                toast.warning('El nombre debe tener al menos 3 caracteres.');
                return;
            }
            
            try {
                const response = await fetch(`/api/jugadores/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, equipo_id, posicion, numero: numero ? parseInt(numero) : null })
                });
                
                if (response.ok) {
                    toast.success('Jugador actualizado correctamente.');
                    document.getElementById('jugadorForm').reset();
                    document.getElementById('btn-agregar-jugador').textContent = 'üë§ Agregar Jugador';
                    document.getElementById('btn-agregar-jugador').onclick = agregarJugador;
                    await cargarJugadores();
                } else {
                    toast.error('Error al actualizar jugador.');
                }
            } catch (error) {
                toast.error('Error de conexi√≥n.');
                }
        }

        async function eliminarJugador(id) {
            const jugador = jugadores.find(j => j.id === id);
            const nombreJugador = jugador ? jugador.nombre : 'este jugador';
        
            // Confirmaci√≥n mejorada
            const confirmacion = confirm(
                `‚ö†Ô∏è ELIMINAR JUGADOR\n\n` +
                `¬øEst√°s seguro de eliminar a "${nombreJugador}"?\n\n` +
                `Esta acci√≥n NO se puede deshacer y se eliminar√°n:\n` +
                `‚Ä¢ Todas sus estad√≠sticas\n` +
                `‚Ä¢ Su historial de partidos\n` +
                `‚Ä¢ Datos asociados\n\n` +
                `Presiona OK para confirmar o Cancelar para abortar.`
            );
        
            if (!confirmacion) {
                toast.info('Eliminaci√≥n cancelada');
                return;
            }
        
            try {
                const res = await fetch(`/api/jugadores/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    toast.success(`Jugador "${nombreJugador}" eliminado correctamente.`);
                    await cargarJugadores();
                } else {
                    toast.error('Error al eliminar el jugador.');
                }
            } catch(e) {
                toast.error('Error de conexi√≥n con el servidor.');
            }
        }

        async function editarPartido(id) {
            const partido = partidos.find(p => p.id === id);
            if (!partido) return;

            // Decide qu√© formulario usar
            if (partido.estado === 'programado' || (partido.carreras_local === null && partido.estado !== 'finalizado')) {
                // Rellena el formulario de programar
                document.getElementById('equipoLocalFuturo').value = partido.equipo_local_id;
                document.getElementById('equipoVisitanteFuturo').value = partido.equipo_visitante_id;
                document.getElementById('fechaPartidoFuturo').value = partido.fecha_partido.split('T')[0];
                document.getElementById('horaPartidoFuturo').value = partido.hora || '';
                document.getElementById('lugarPartido').value = partido.lugar || '';
                
                // Cambia el bot√≥n para actualizar
                const btn = document.querySelector('#partidos .card:first-child .btn-primary');
                btn.textContent = '‚úÖ Actualizar Partido Programado';
                btn.onclick = () => actualizarPartido(id);

                toast.info('Editando partido programado. Puede a√±adir los resultados en el formulario de abajo.');

            } else {
                 // Rellena el formulario de resultados
                document.getElementById('equipoLocal').value = partido.equipo_local_id;
                document.getElementById('equipoVisitante').value = partido.equipo_visitante_id;
                document.getElementById('carrerasLocal').value = partido.carreras_local || '';
                document.getElementById('carrerasVisitante').value = partido.carreras_visitante || '';
                document.getElementById('fechaPartido').value = partido.fecha_partido.split('T')[0];
                document.getElementById('btn-registrar-partido').textContent = '‚úÖ Actualizar Resultado';
                document.getElementById('btn-registrar-partido').onclick = () => actualizarPartido(id);
            }
        }

        async function actualizarPartido(id) {
            // Unificar l√≥gica de actualizaci√≥n
            const equipo_local_id = document.getElementById('equipoLocal').value || document.getElementById('equipoLocalFuturo').value;
            const equipo_visitante_id = document.getElementById('equipoVisitante').value || document.getElementById('equipoVisitanteFuturo').value;
            const carreras_local = document.getElementById('carrerasLocal').value;
            const carreras_visitante = document.getElementById('carrerasVisitante').value;
            const fecha_partido = document.getElementById('fechaPartido').value || document.getElementById('fechaPartidoFuturo').value;
            const hora = document.getElementById('horaPartidoFuturo').value;
            const lugar = document.getElementById('lugarPartido').value;

            if (!equipo_local_id || !equipo_visitante_id || !fecha_partido) {
                toast.warning('Equipos y fecha son obligatorios.');
                return;
            }

            const body = {
                equipo_local_id,
                equipo_visitante_id,
                fecha_partido,
                hora: hora || null,
                lugar: lugar || null,
                carreras_local: carreras_local !== "" ? parseInt(carreras_local) : null,
                carreras_visitante: carreras_visitante !== "" ? parseInt(carreras_visitante) : null,
                estado: (carreras_local !== "" && carreras_visitante !== "") ? 'finalizado' : 'programado'
            };

            try {
                const res = await fetch(`/api/partidos/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    toast.success('Partido actualizado correctamente.');
                    // Resetear ambos formularios y botones
                    document.getElementById('equipoLocal').value = '';
                    document.getElementById('equipoVisitante').value = '';
                    document.getElementById('carrerasLocal').value = '';
                    document.getElementById('carrerasVisitante').value = '';
                    document.getElementById('btn-registrar-partido').textContent = 'üéØ Registrar Partido';
                    document.getElementById('btn-registrar-partido').onclick = registrarPartido;
                    
                    document.getElementById('equipoLocalFuturo').value = '';
                    document.getElementById('equipoVisitanteFuturo').value = '';
                    document.getElementById('fechaPartidoFuturo').value = '';
                    document.getElementById('horaPartidoFuturo').value = '';
                    document.getElementById('lugarPartido').value = '';
                    const btnProg = document.querySelector('#partidos .card:first-child .btn-primary');
                    btnProg.textContent = 'üìÖ Programar Partido';
                    btnProg.onclick = programarPartido;

                    await cargarPartidos();
                    calcularPosiciones();
                } else {
                    toast.error('Error al actualizar partido.');
                }
            } catch (e) {
                toast.error('Error de red.');
            }
        }

        async function eliminarPartido(id) {
            if (!confirm('¬øEliminar este partido?')) return;
            try {
                const res = await fetch(`/api/partidos/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    toast.success('Partido eliminado correctamente.');
                    await cargarPartidos();
                    calcularPosiciones();
                } else {
                    toast.error('Error al eliminar.');
                }
            } catch(e) {
                toast.error('Error de red.');
            }
        }

        async function registrarEstadisticasPitcheo() {
            const jugador_id = document.getElementById('jugadorPitcheo').value;
            if (!jugador_id) {
                toast.warning('Selecciona un pitcher.');
                return;
            }
            
            const data = {
                jugador_id: parseInt(jugador_id),
                innings_pitched: parseFloat(document.getElementById('inningsPitched').value) || 0,
                hits_allowed: parseInt(document.getElementById('hitsAllowed').value) || 0,
                earned_runs: parseInt(document.getElementById('earnedRuns').value) || 0,
                strikeouts: parseInt(document.getElementById('strikeoutsP').value) || 0,
                walks_allowed: parseInt(document.getElementById('walksAllowed').value) || 0,
                home_runs_allowed: parseInt(document.getElementById('homeRunsAllowed').value) || 0,
                wins: parseInt(document.getElementById('wins').value) || 0,
                losses: parseInt(document.getElementById('losses').value) || 0,
                saves: parseInt(document.getElementById('saves').value) || 0
            };
            
            try {
                const res = await fetch('/api/estadisticas-pitcheo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    toast.success('Estad√≠sticas de pitcheo registradas.');
                    await cargarEstadisticas();
                    document.querySelectorAll('#inningsPitched, #hitsAllowed, #earnedRuns, #strikeoutsP, #walksAllowed, #homeRunsAllowed, #wins, #losses, #saves').forEach(el => el.value = 0);
                } else {
                    toast.error('Error al registrar estad√≠sticas.');
                }
            } catch(e) {
                toast.error('Error de red.');
            }
        }

        async function registrarEstadisticasDefensivas() {
            const jugador_id = document.getElementById('jugadorDefensivo').value;
            if (!jugador_id) {
                toast.warning('Selecciona un jugador.');
                return;
            }
            
            const data = {
                jugador_id: parseInt(jugador_id),
                putouts: parseInt(document.getElementById('putouts').value) || 0,
                assists: parseInt(document.getElementById('assists').value) || 0,
                errors: parseInt(document.getElementById('defensiveErrors').value) || 0,
                double_plays: parseInt(document.getElementById('doublePlays').value) || 0,
                passed_balls: parseInt(document.getElementById('passedBalls').value) || 0
            };
            
            try {
                const res = await fetch('/api/estadisticas-defensivas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    toast.success('Estad√≠sticas defensivas registradas.');
                    await cargarEstadisticas();
                    document.querySelectorAll('#putouts, #assists, #defensiveErrors, #doublePlays, #passedBalls').forEach(el => el.value = 0);
                } else {
                    toast.error('Error al registrar estad√≠sticas.');
                }
            } catch(e) {
                toast.error('Error de red.');
            }
        }

        async function cargarTablaEditarBateo() {
            const tbody = document.querySelector('#tablaEditarBateo tbody');
            if (!tbody) return;
            // Crear controles si no existen
            const table = document.getElementById('tablaEditarBateo');
            if (!document.getElementById('controls-bateo')) {
                const controls = document.createElement('div');
                controls.id = 'controls-bateo';
                controls.className = 'table-controls';
                controls.innerHTML = `
                    <h4>üîç Filtros de B√∫squeda</h4>
                    <div class="filters-grid">
                        <div class="search-box">
                            <input type="text" id="search-bateo" placeholder="Buscar jugador por nombre...">
                        </div>
                        <select id="filter-team-bateo" class="filter-select">
                            <option value="">-- Todos los Equipos --</option>
                        </select>
                    </div>
                    <div class="results-info">
                        <span id="count-bateo">Total: 0 jugadores</span>
                        <button class="btn-secondary" onclick="limpiarFiltrosBateo()" style="background: #ff9800; padding: 8px 16px;">üóëÔ∏è Limpiar</button>
                    </div>
                `;
                table.parentElement.insertBefore(controls, table);
                // Poblar select de equipos
                const teamSelect = document.getElementById('filter-team-bateo');
                equipos.forEach(e => {
                    const option = document.createElement('option');
                    option.value = e.id;
                    option.textContent = e.nombre;
                    teamSelect.appendChild(option);
                });
                // Event listeners
                document.getElementById('search-bateo').addEventListener('input', (e) => {
                    if (paginationBateo) paginationBateo.setSearch(e.target.value);
                });
                document.getElementById('filter-team-bateo').addEventListener('change', (e) => {
                    if (paginationBateo) paginationBateo.setTeamFilter(e.target.value);
                });
            }
            try {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Cargando estad√≠sticas...</td></tr>';
                const response = await fetch('/api/estadisticas-ofensivas');
                if (!response.ok) throw new Error('Error');
                const stats = await response.json();
                
                // Enriquecer con datos de jugador (esto es clave)
                const enrichedStats = stats.map(s => {
                    const jugador = jugadores.find(j => j.id === s.jugador_id);
                    return jugador ? { ...s, nombre: jugador.nombre, equipo_nombre: jugador.equipo_nombre, equipo_id: jugador.equipo_id } : null;
                }).filter(Boolean); // Filtrar nulos si un jugador no se encontr√≥
                
                // Inicializar paginaci√≥n
                paginationBateo = new TablePagination('tablaEditarBateo', 20);
                paginationBateo.render = function() {
                    const data = this.getCurrentPageData();
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No se encontraron jugadores con los filtros aplicados.</td></tr>';
                    } else {
                        tbody.innerHTML = data.map(s => `
                            <tr>
                                <td>${s.nombre}</td>
                                <td>${s.equipo_nombre || '-'}</td>
                                <td><input type="number" id="pa-${s.jugador_id}" value="${s.plate_appearances || 0}" style="width:50px;"></td>
                                <td><input type="number" id="ab-${s.jugador_id}" value="${s.at_bats || 0}" style="width:50px;"></td>
                                <td><input type="number" id="h-${s.jugador_id}" value="${s.hits || 0}" style="width:50px;"></td>
                                <td><input type="number" id="doubles-${s.jugador_id}" value="${s.doubles || 0}" style="width:50px;"></td>
                                <td><input type="number" id="triples-${s.jugador_id}" value="${s.triples || 0}" style="width:50px;"></td>
                                <td><input type="number" id="hr-${s.jugador_id}" value="${s.home_runs || 0}" style="width:50px;"></td>
                                <td><input type="number" id="rbi-${s.jugador_id}" value="${s.rbi || 0}" style="width:50px;"></td>
                                <td><input type="number" id="r-${s.jugador_id}" value="${s.runs || 0}" style="width:50px;"></td>
                                <td><input type="number" id="bb-${s.jugador_id}" value="${s.walks || 0}" style="width:50px;"></td>
                                <td><input type="number" id="so-${s.jugador_id}" value="${s.strikeouts || 0}" style="width:50px;"></td>
                                <td><input type="number" id="sb-${s.jugador_id}" value="${s.stolen_bases || 0}" style="width:50px;"></td>
                                <td><input type="number" id="cs-${s.jugador_id}" value="${s.caught_stealing || 0}" style="width:50px;"></td>
                                <td><input type="number" id="hbp-${s.jugador_id}" value="${s.hit_by_pitch || 0}" style="width:50px;"></td>
                                <td><input type="number" id="sf-${s.jugador_id}" value="${s.sacrifice_flies || 0}" style="width:50px;"></td>
                                <td><input type="number" id="sh-${s.jugador_id}" value="${s.sacrifice_hits || 0}" style="width:50px;"></td>
                                <td><button class="btn-actualizar" onclick="actualizarEstadistica('bateo', ${s.jugador_id})">üíæ</button></td>
                            </tr>
                        `).join('');
                    }
                    // Actualizar contador
                    document.getElementById('count-bateo').textContent = `Mostrando ${data.length} de ${this.filteredData.length} jugadores`;
                    // Renderizar paginaci√≥n
                    renderPagination('bateo', this);
                };
                paginationBateo.setData(enrichedStats);
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Error al cargar.</td></tr>';
                console.error(e);
            }
        }

        function renderPagination(type, pagination) {
            const totalPages = pagination.getTotalPages();
            const currentPage = pagination.currentPage;
            const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);

            let container = document.getElementById(`pagination-${type}`);
            if (!container) {
                container = document.createElement('div');
                container.id = `pagination-${type}`;
                container.className = 'pagination-controls';
                const table = document.getElementById(`tablaEditar${typeCapitalized}`);
                table.parentElement.appendChild(container);
            }
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            let html = `
                <button class="pagination-btn" onclick="pagination${typeCapitalized}.prevPage()" ${currentPage === 1 ? 'disabled' : ''}>
                    ‚Üê Anterior
                </button>
                <div class="page-numbers">
            `;
            // Mostrar p√°ginas (m√°ximo 5 botones)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, 5);
                } else if (endPage === totalPages) {
                    startPage = Math.max(1, totalPages - 4);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="pagination${typeCapitalized}.goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            html += `
                </div>
                <button class="pagination-btn" onclick="pagination${typeCapitalized}.nextPage()" ${currentPage === totalPages ? 'disabled' : ''}>
                    Siguiente ‚Üí
                </button>
            `;
            container.innerHTML = html;
        }

        function limpiarFiltrosBateo() {
            document.getElementById('search-bateo').value = '';
            document.getElementById('filter-team-bateo').value = '';
            if (paginationBateo) {
                paginationBateo.setSearch('');
                paginationBateo.setTeamFilter('');
            }
        }

        async function cargarTablaEditarPitcheo() {
            const tbody = document.querySelector('#tablaEditarPitcheo tbody');
            if (!tbody) return;
            const table = document.getElementById('tablaEditarPitcheo');
            if (!document.getElementById('controls-pitcheo')) {
                const controls = document.createElement('div');
                controls.id = 'controls-pitcheo';
                controls.className = 'table-controls';
                controls.innerHTML = `
                    <h4>üîç Filtros de B√∫squeda</h4>
                    <div class="filters-grid">
                        <div class="search-box">
                            <input type="text" id="search-pitcheo" placeholder="Buscar pitcher por nombre...">
                        </div>
                        <select id="filter-team-pitcheo" class="filter-select">
                            <option value="">-- Todos los Equipos --</option>
                        </select>
                    </div>
                    <div class="results-info">
                        <span id="count-pitcheo">Total: 0 jugadores</span>
                        <button class="btn-secondary" onclick="limpiarFiltrosPitcheo()" style="background: #ff9800; padding: 8px 16px;">üóëÔ∏è Limpiar</button>
                    </div>
                `;
                table.parentElement.insertBefore(controls, table);
                const teamSelect = document.getElementById('filter-team-pitcheo');
                equipos.forEach(e => {
                    const option = document.createElement('option');
                    option.value = e.id;
                    option.textContent = e.nombre;
                    teamSelect.appendChild(option);
                });
                document.getElementById('search-pitcheo').addEventListener('input', (e) => {
                    if (paginationPitcheo) paginationPitcheo.setSearch(e.target.value);
                });
                document.getElementById('filter-team-pitcheo').addEventListener('change', (e) => {
                    if (paginationPitcheo) paginationPitcheo.setTeamFilter(e.target.value);
                });
            }
            try {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Cargando estad√≠sticas...</td></tr>';
                const response = await fetch('/api/estadisticas-pitcheo');
                if (!response.ok) throw new Error('Error');
                const stats = await response.json();
                
                const enrichedStats = stats.map(s => {
                    const jugador = jugadores.find(j => j.id === s.jugador_id);
                    return jugador ? { ...s, nombre: jugador.nombre, equipo_nombre: jugador.equipo_nombre, equipo_id: jugador.equipo_id } : null;
                }).filter(Boolean);
                
                paginationPitcheo = new TablePagination('tablaEditarPitcheo', 20);
                paginationPitcheo.render = function() {
                    const data = this.getCurrentPageData();
                    if (data.length === 0) {
                         tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No se encontraron jugadores.</td></tr>';
                    } else {
                        tbody.innerHTML = data.map(s => `
                            <tr>
                                <td>${s.nombre}</td>
                                <td>${s.equipo_nombre || '-'}</td>
                                <td><input type="number" id="ip-${s.jugador_id}" value="${s.innings_pitched || 0}" style="width:60px;" step="0.1"></td>
                                <td><input type="number" id="ha-${s.jugador_id}" value="${s.hits_allowed || 0}" style="width:60px;"></td>
                                <td><input type="number" id="er-${s.jugador_id}" value="${s.earned_runs || 0}" style="width:60px;"></td>
                                <td><input type="number" id="k-${s.jugador_id}" value="${s.strikeouts || 0}" style="width:60px;"></td>
                                <td><input type="number" id="bba-${s.jugador_id}" value="${s.walks_allowed || 0}" style="width:60px;"></td>
                                <td><input type="number" id="hra-${s.jugador_id}" value="${s.home_runs_allowed || 0}" style="width:60px;"></td>
                                <td><input type="number" id="w-${s.jugador_id}" value="${s.wins || 0}" style="width:60px;"></td>
                                <td><input type="number" id="l-${s.jugador_id}" value="${s.losses || 0}" style="width:60px;"></td>
                                <td><input type="number" id="sv-${s.jugador_id}" value="${s.saves || 0}" style="width:60px;"></td>
                                <td><button class="btn-actualizar" onclick="actualizarEstadistica('pitcheo', ${s.jugador_id})">üíæ</button></td>
                            </tr>
                        `).join('');
                    }
                    document.getElementById('count-pitcheo').textContent = `Mostrando ${data.length} de ${this.filteredData.length} jugadores`;
                    renderPagination('pitcheo', this);
                };
                paginationPitcheo.setData(enrichedStats);
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Error al cargar.</td></tr>';
                console.error(e);
            }
        }

        function limpiarFiltrosPitcheo() {
            document.getElementById('search-pitcheo').value = '';
            document.getElementById('filter-team-pitcheo').value = '';
            if (paginationPitcheo) {
                paginationPitcheo.setSearch('');
                paginationPitcheo.setTeamFilter('');
            }
        }

        async function cargarTablaEditarDefensa() {
            const tbody = document.querySelector('#tablaEditarDefensa tbody');
            if (!tbody) return;
            const table = document.getElementById('tablaEditarDefensa');
            if (!document.getElementById('controls-defensa')) {
                const controls = document.createElement('div');
                controls.id = 'controls-defensa';
                controls.className = 'table-controls';
                controls.innerHTML = `
                    <h4>üîç Filtros de B√∫squeda</h4>
                    <div class="filters-grid">
                        <div class="search-box">
                            <input type="text" id="search-defensa" placeholder="Buscar jugador por nombre...">
                        </div>
                        <select id="filter-team-defensa" class="filter-select">
                            <option value="">-- Todos los Equipos --</option>
                        </select>
                    </div>
                    <div class="results-info">
                        <span id="count-defensa">Total: 0 jugadores</span>
                        <button class="btn-secondary" onclick="limpiarFiltrosDefensa()" style="background: #ff9800; padding: 8px 16px;">üóëÔ∏è Limpiar</button>
                    </div>
                `;
                table.parentElement.insertBefore(controls, table);
                const teamSelect = document.getElementById('filter-team-defensa');
                equipos.forEach(e => {
                    const option = document.createElement('option');
                    option.value = e.id;
                    option.textContent = e.nombre;
                    teamSelect.appendChild(option);
                });
                document.getElementById('search-defensa').addEventListener('input', (e) => {
                    if (paginationDefensa) paginationDefensa.setSearch(e.target.value);
                });
                document.getElementById('filter-team-defensa').addEventListener('change', (e) => {
                    if (paginationDefensa) paginationDefensa.setTeamFilter(e.target.value);
                });
            }
            try {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Cargando estad√≠sticas...</td></tr>';
                const response = await fetch('/api/estadisticas-defensivas');
                if (!response.ok) throw new Error('Error');
                const stats = await response.json();
                
                const enrichedStats = stats.map(s => {
                    const jugador = jugadores.find(j => j.id === s.jugador_id);
                    return jugador ? { ...s, nombre: jugador.nombre, equipo_nombre: jugador.equipo_nombre, equipo_id: jugador.equipo_id } : null;
                }).filter(Boolean);
                
                paginationDefensa = new TablePagination('tablaEditarDefensa', 20);
                paginationDefensa.render = function() {
                    const data = this.getCurrentPageData();
                     if (data.length === 0) {
                         tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No se encontraron jugadores.</td></tr>';
                    } else {
                        tbody.innerHTML = data.map(s => `
                            <tr>
                                <td>${s.nombre}</td>
                                <td>${s.equipo_nombre || '-'}</td>
                                <td><input type="number" id="po-${s.jugador_id}" value="${s.putouts || 0}" style="width:60px;"></td>
                                <td><input type="number" id="a-${s.jugador_id}" value="${s.assists || 0}" style="width:60px;"></td>
                                <td><input type="number" id="e-${s.jugador_id}" value="${s.errors || 0}" style="width:60px;"></td>
                                <td><input type="number" id="dp-${s.jugador_id}" value="${s.double_plays || 0}" style="width:60px;"></td>
                                <td><button class="btn-actualizar" onclick="actualizarEstadistica('defensiva', ${s.jugador_id})">üíæ</button></td>
                            </tr>
                        `).join('');
                    }
                    document.getElementById('count-defensa').textContent = `Mostrando ${data.length} de ${this.filteredData.length} jugadores`;
                    renderPagination('defensa', this);
                };
                paginationDefensa.setData(enrichedStats);
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Error al cargar.</td></tr>';
                console.error(e);
            }
        }

        function limpiarFiltrosDefensa() {
            document.getElementById('search-defensa').value = '';
            document.getElementById('filter-team-defensa').value = '';
            if (paginationDefensa) {
                paginationDefensa.setSearch('');
                paginationDefensa.setTeamFilter('');
            }
        }

        function limpiarFormulario(tipo) {
            if (tipo === 'equipo') {
                document.getElementById('nombreEquipo').value = '';
                document.getElementById('managerEquipo').value = '';
                document.getElementById('ciudadEquipo').value = '';
            } else if (tipo === 'jugador') {
                document.getElementById('jugadorForm').reset();
            } else if (tipo === 'partido') {
                document.getElementById('equipoLocal').value = '';
                document.getElementById('equipoVisitante').value = '';
                document.getElementById('carrerasLocal').value = '';
                document.getElementById('carrerasVisitante').value = '';
            }
        }

        function resetearBoton(tipo) {
            if (tipo === 'equipo') {
                document.getElementById('btn-agregar-equipo').textContent = 'üèÜ Agregar Equipo';
                document.getElementById('btn-agregar-equipo').onclick = agregarEquipo;
            } else if (tipo === 'jugador') {
                document.getElementById('btn-agregar-jugador').textContent = 'üë§ Agregar Jugador';
                document.getElementById('btn-agregar-jugador').onclick = agregarJugador;
            } else if (tipo === 'partido') {
                document.getElementById('btn-registrar-partido').textContent = 'üéØ Registrar Partido';
                document.getElementById('btn-registrar-partido').onclick = registrarPartido;
            }
        }

        async function cargarParaEditar(tipo, jugadorId) {
            // Esta funci√≥n no se usa actualmente
            console.log('cargarParaEditar', tipo, jugadorId);
        }

        // ==================================================================
        // ‚úÖ INICIO CORRECCI√ìN BUG #1: DUPLICACI√ìN DE JUGADORES
        // Se reemplaza la funci√≥n original por esta versi√≥n m√°s robusta.
        // Esta funci√≥n env√≠a los datos de las tablas de edici√≥n al backend.
        // La l√≥gica del backend (en server.js) debe estar corregida para
        // usar UPSERT con REEMPLAZO (SET field = EXCLUDED.field) en lugar de
        // SUMA (SET field = table.field + EXCLUDED.field).
        // ==================================================================
        function getSeasonFromUrl() {
            const qsTemporada = new URLSearchParams(window.location.search).get('temporada');
            if (qsTemporada && qsTemporada.trim() !== '') {
                return qsTemporada.trim();
            }
            if (torneoActivo && typeof torneoActivo.temporada === 'string' && torneoActivo.temporada.trim() !== '') {
                return torneoActivo.temporada.trim();
            }
            return null;
        }

        function obtenerEquipoDelJugador(jugadorId) {
            const jugador = jugadores.find(j => Number(j.id) === Number(jugadorId));
            return jugador && jugador.equipo_id ? jugador.equipo_id : null;
        }

        async function actualizarEstadistica(tipo, jugadorId) {
            const saveButton = event.target;
            let endpoint = '';
            let payload = { jugador_id: jugadorId };
            const temporada = getSeasonFromUrl();
            const equipoId = obtenerEquipoDelJugador(jugadorId);
            payload.temporada = temporada || null;
            payload.equipo_id = equipoId !== undefined && equipoId !== null ? equipoId : null;

            try {
                saveButton.disabled = true;
                saveButton.textContent = '‚è≥';

                switch (tipo) {
                    case 'bateo':
                        endpoint = `/api/estadisticas-ofensivas`;
                        payload.at_bats = parseInt(document.getElementById(`ab-${jugadorId}`).value) || 0;
                        payload.hits = parseInt(document.getElementById(`h-${jugadorId}`).value) || 0;
                        payload.doubles = parseInt(document.getElementById(`doubles-${jugadorId}`).value) || 0;
                        payload.triples = parseInt(document.getElementById(`triples-${jugadorId}`).value) || 0;
                        payload.home_runs = parseInt(document.getElementById(`hr-${jugadorId}`).value) || 0;
                        payload.rbi = parseInt(document.getElementById(`rbi-${jugadorId}`).value) || 0;
                        payload.runs = parseInt(document.getElementById(`r-${jugadorId}`).value) || 0;
                        payload.walks = parseInt(document.getElementById(`bb-${jugadorId}`).value) || 0;
                        payload.strikeouts = parseInt(document.getElementById(`so-${jugadorId}`).value) || 0;
                        payload.stolen_bases = parseInt(document.getElementById(`sb-${jugadorId}`).value) || 0;
                        payload.caught_stealing = parseInt(document.getElementById(`cs-${jugadorId}`).value) || 0;
                        payload.hit_by_pitch = parseInt(document.getElementById(`hbp-${jugadorId}`).value) || 0;
                        payload.sacrifice_flies = parseInt(document.getElementById(`sf-${jugadorId}`).value) || 0;
                        payload.sacrifice_hits = parseInt(document.getElementById(`sh-${jugadorId}`).value) || 0;
                        break;
                    
                    case 'pitcheo':
                        endpoint = `/api/estadisticas-pitcheo`;
                        payload.innings_pitched = parseFloat(document.getElementById(`ip-${jugadorId}`).value) || 0;
                        payload.hits_allowed = parseInt(document.getElementById(`ha-${jugadorId}`).value) || 0;
                        payload.earned_runs = parseInt(document.getElementById(`er-${jugadorId}`).value) || 0;
                        payload.strikeouts = parseInt(document.getElementById(`k-${jugadorId}`).value) || 0;
                        payload.walks_allowed = parseInt(document.getElementById(`bba-${jugadorId}`).value) || 0;
                        payload.home_runs_allowed = parseInt(document.getElementById(`hra-${jugadorId}`).value) || 0;
                        payload.wins = parseInt(document.getElementById(`w-${jugadorId}`).value) || 0;
                        payload.losses = parseInt(document.getElementById(`l-${jugadorId}`).value) || 0;
                        payload.saves = parseInt(document.getElementById(`sv-${jugadorId}`).value) || 0;
                        break;
                    
                    case 'defensiva':
                        endpoint = `/api/estadisticas-defensivas`;
                        payload.putouts = parseInt(document.getElementById(`po-${jugadorId}`).value) || 0;
                        payload.assists = parseInt(document.getElementById(`a-${jugadorId}`).value) || 0;
                        payload.errors = parseInt(document.getElementById(`e-${jugadorId}`).value) || 0;
                        payload.double_plays = parseInt(document.getElementById(`dp-${jugadorId}`).value) || 0;
                        payload.chances = payload.putouts + payload.assists + payload.errors;
                        break;
                    
                    default:
                        throw new Error('Tipo de estad√≠stica no v√°lido');
                }

                console.log(`üì§ [CORRECCI√ìN BUG #1] Enviando actualizaci√≥n (${tipo}) para jugador ${jugadorId}:`, payload);
                
                // Usamos POST para la l√≥gica de UPSERT (INSERT ... ON CONFLICT) como se sugiere
                // en la soluci√≥n. Si el backend usa PUT para reemplazo, se puede cambiar el m√©todo.
                const response = await fetch(endpoint, {
                    method: 'POST', // Usamos POST para que coincida con la l√≥gica de UPSERT.
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ...payload, mode: 'replace' })
                });

                if (response.ok) {
                    toast.success('Estad√≠stica actualizada correctamente.');
                    await cargarEstadisticas(); // Recargar todas las estad√≠sticas para consistencia
                    actualizarLideres(); // Actualizar los l√≠deres que pudieron cambiar
                } else {
                    const error = await response.json();
                    throw new Error(error.message || `Error ${response.status} del servidor.`);
                }

            } catch(error) {
                console.error(`‚ùå Error actualizando estad√≠stica de ${tipo}:`, error);
                toast.error(`No se pudo actualizar: ${error.message}`);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'üíæ';
            }
        }
        // ‚úÖ FIN CORRECCI√ìN BUG #1
        // ==================================================================

        function renderizarTablaEquipos() {
            const tbody = document.querySelector('#equiposTable tbody');
            if (!tbody) return;
            
            if (equiposFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state" style="padding: 40px 20px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üèÜ</div>
                            <h3 style="color: #ffc107; margin-bottom: 10px;">No se encontraron equipos</h3>
                            <p style="color: #fff; opacity: 0.7; font-size: 0.9rem;">
                                Intenta ajustar los filtros o agrega un nuevo equipo usando el formulario de arriba
                            </p>
                        </td>
                    </tr>
                `;
                return;
            }
            tbody.innerHTML = equiposFiltrados.map(equipo => `
                <tr>
                    <td>${equipo.id}</td>
                    <td><strong>${equipo.nombre}</strong></td>
                    <td>${equipo.manager}</td>
                    <td>${equipo.ciudad}</td>
                    <td>${new Date(equipo.fecha_creacion).toLocaleDateString('es-AR')}</td>
                    <td>
                        <button class="btn-secondary btn-edit" onclick="editarEquipo(${equipo.id})">‚úèÔ∏è</button>
                        <button class="btn-secondary" onclick="eliminarEquipo(${equipo.id})" style="background: #f44336;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function ordenarTablaEquipos(campo) {
            if (ordenEquipos.campo === campo) {
                ordenEquipos.direccion = ordenEquipos.direccion === 'asc' ? 'desc' : 'asc';
            } else {
                ordenEquipos.campo = campo;
                ordenEquipos.direccion = 'asc';
            }
            document.querySelectorAll('#equiposTable .sort-indicator').forEach(el => {
                el.className = 'sort-indicator';
            });
            const indicator = document.querySelector(`#equiposTable th[onclick*="${campo}"] .sort-indicator`);
            if (indicator) indicator.className = `sort-indicator ${ordenEquipos.direccion}`;
            actualizarTablaEquipos();
        }

        function limpiarFiltrosEquipos() {
            document.getElementById('buscadorEquipos').value = '';
            ordenEquipos = { campo: 'nombre', direccion: 'asc' };
            document.querySelectorAll('#equiposTable .sort-indicator').forEach(el => {
                el.className = 'sort-indicator';
            });
            actualizarTablaEquipos();
        }

        function limpiarFiltrosPartidos() {
            document.getElementById('filtroEquipoPartidos').value = '';
            document.getElementById('filtroEstadoPartidos').value = '';
            document.getElementById('filtroFechaPartidos').value = '';
            actualizarTablaPartidos();
        }

        function renderizarTablaJugadores() {
            const tbody = document.querySelector('#jugadoresTable tbody');
            if (!tbody) return;
            if (jugadoresFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state" style="padding: 40px 20px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üë§</div>
                            <h3 style="color: #ffc107; margin-bottom: 10px;">No se encontraron jugadores</h3>
                            <p style="color: #fff; opacity: 0.7; font-size: 0.9rem;">
                                Intenta ajustar los filtros o agrega un nuevo jugador usando el formulario de arriba
                            </p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = jugadoresFiltrados.map(jugador => `
                <tr>
                    <td>${jugador.numero || '-'}</td>
                    <td><strong>${jugador.nombre}</strong></td>
                    <td>${jugador.equipo_nombre || 'Sin equipo'}</td>
                    <td>${jugador.posicion || '-'}</td>
                    <td>
                        <button class="btn-secondary btn-edit" onclick="editarJugador(${jugador.id})">‚úèÔ∏è</button>
                        <button class="btn-secondary" onclick="eliminarJugador(${jugador.id})" style="background: #f44336;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function limpiarFiltrosJugadores() {
            document.getElementById('buscadorJugadores').value = '';
            document.getElementById('filtroRosterEquipo').value = '';
            if (document.getElementById('filtroPosicion')) {
                document.getElementById('filtroPosicion').value = '';
            }
            ordenJugadores = { campo: 'nombre', direccion: 'asc' };
            document.querySelectorAll('#jugadoresTable .sort-indicator').forEach(el => {
                el.className = 'sort-indicator';
            });
            actualizarTablaJugadores();
        }

        // Clases UX
        class FormValidator {
            constructor() {
                this.rules = {};
            }
            addRule(field, rules) {
                this.rules[field] = rules;
            }
            validate(formId) {
                return true;
            }
            showError(field, message) {
                console.log(`Error en ${field}: ${message}`);
            }
            clearError(field) {
                console.log(`Limpiar error de ${field}`);
            }
        }

        class LoadingManager {
            show(buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.7';
                }
            }
            hide(buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            }
        }

        class ConfirmationManager {
            async confirm(message) {
                return confirm(message);
            }
        }

        class NotificationManager {
            success(msg, title = '') {
                toast.success(`${title ? title + ': ' : ''}${msg}`);
            }
            error(msg, title = '') {
                toast.error(`${title ? title + ': ' : ''}${msg}`);
            }
            warning(msg, title = '') {
                toast.warning(`${title ? title + ': ' : ''}${msg}`);
            }
            info(msg, title = '') {
                toast.info(`${title ? title + ': ' : ''}${msg}`);
            }
        }

        class ShortcutManager {
            constructor() {
                this.init();
            }
            init() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        console.log('Guardar (Ctrl+S)');
                    }
                });
            }
        }

        class AutoSaveManager {
            constructor() {
                console.log('AutoSaveManager iniciado');
            }
        }

        function initializeUXSystems() {
            window.formValidator = new FormValidator();
            window.loadingManager = new LoadingManager();
            window.confirmationManager = new ConfirmationManager();
            window.notificationManager = new NotificationManager();
            window.shortcutManager = new ShortcutManager();
            window.autoSaveManager = new AutoSaveManager();
            console.log('Sistemas UX inicializados');
        }

        function exportarTabla(tabla, formato) {
            let datos, headers, filename;
            if (tabla === 'jugadores') {
                datos = jugadoresFiltrados;
                headers = ['N√∫mero', 'Nombre', 'Equipo', 'Posici√≥n'];
                filename = 'jugadores';
            } else if (tabla === 'equipos') {
                datos = equiposFiltrados;
                headers = ['ID', 'Nombre', 'Manager', 'Ciudad', 'Fecha'];
                filename = 'equipos';
            }
            if (formato === 'csv') {
                exportarCSV(datos, headers, filename, tabla);
            }
        }

        function exportarCSV(datos, headers, filename, tabla) {
            if (datos.length === 0) {
                toast.warning('No hay datos para exportar');
                return;
            }
            let csv = headers.join(',') + '\n';
            datos.forEach(item => {
                let fila = [];
                if (tabla === 'jugadores') {
                    fila = [item.numero || '-', item.nombre, item.equipo_nombre || '-', item.posicion || '-'];
                } else if (tabla === 'equipos') {
                    fila = [item.id, item.nombre, item.manager, item.ciudad, new Date(item.fecha_creacion).toLocaleDateString('es-AR')];
                }
                csv += fila.map(campo => `"${String(campo).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            toast.success(`${filename}.csv descargado correctamente`);
        }

        if (document.readyState === 'loading') { 
            document.addEventListener('DOMContentLoaded', initializeUXSystems); 
        } else { 
            initializeUXSystems(); 
        }
    </script>
    
    <script src="js/admin_modules.min.js" defer></script>
    <script>
    window.addEventListener('scroll', function() {
        var header = document.querySelector('.header');
        if (header) {
            if (window.scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        }
    });
    </script>
</body>
</html>
