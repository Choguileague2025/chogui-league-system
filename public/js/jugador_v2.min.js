const urlParams=new URLSearchParams(window.location.search),jugadorId=urlParams.get("id");let currentTournamentId=null,playerData=null,offensiveChart=null,radarChart=null;function toNum(t){return Number(t)||0}function showError(t){const e=document.querySelector(".container");e&&(e.innerHTML=`\n            <div style="text-align: center; padding: 50px; color: #ff8c00;">\n                <h2>‚ö†Ô∏è Error</h2>\n                <p>${t}</p>\n                <a href="index.html" style="color: #ffd700;">Volver al Inicio</a>\n            </div>\n        `)}async function fetchSafe(t){try{const e=await fetch(t);return e.ok?await e.json():null}catch(e){return console.error(`Error fetching ${t}:`,e),null}}function formatPos(t){return{P:"Pitcher",C:"Catcher","1B":"Primera Base","2B":"Segunda Base","3B":"Tercera Base",SS:"Shortstop",LF:"Left Field",CF:"Center Field",RF:"Right Field",UTIL:"Utility"}[t]||t||"N/A"}function getTeamLogo(t){return`https://ui-avatars.com/api/?name=${encodeURIComponent(t)}&background=ffd700&color=1a1a2e&size=120`}function getInitials(t){if(!t)return"JG";const e=t.trim().split(/\s+/);return 1===e.length?e[0].substring(0,2).toUpperCase():e.slice(0,2).map(t=>t.charAt(0).toUpperCase()).join("")}function setupTabs(){const t=document.querySelectorAll(".player-tab"),e=document.querySelectorAll(".player-tab-panel");t.forEach(n=>{n.addEventListener("click",()=>{const o=n.dataset.tab;t.forEach(t=>t.classList.remove("active")),e.forEach(t=>t.classList.remove("active")),n.classList.add("active"),document.getElementById(`tab-${o}`).classList.add("active")})})}async function loadTournaments(){try{const t=await fetchSafe("/api/torneos");if(!t)return;const e=document.getElementById("tournamentSelect");e.innerHTML='<option value="todos">Todos los torneos</option>',t.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.nombre+(t.activo?" (Activo)":""),t.activo&&(n.selected=!0,currentTournamentId=t.id),e.appendChild(n)}),e.addEventListener("change",t=>{currentTournamentId="todos"===t.target.value?"todos":parseInt(t.target.value),loadAllStats()})}catch(t){console.error("Error cargando torneos:",t)}}async function loadPlayerInfo(){try{const t=await fetchSafe(`/api/jugadores/${jugadorId}`);if(!t)return void showError("Jugador no encontrado");playerData=t,document.title=`${t.nombre} - Chogui League`,document.getElementById("playerName").textContent=t.nombre,document.getElementById("playerNumber").textContent=t.numero?`#${t.numero}`:"#--",document.getElementById("playerPosition").textContent=formatPos(t.posicion),document.getElementById("playerTeamName").textContent=t.equipo_nombre||"Sin Equipo";const e=document.getElementById("teamBreadcrumbLink");t.equipo_id?e.innerHTML=`<a href="equipo.html?id=${t.equipo_id}">${t.equipo_nombre}</a>`:e.textContent="Sin Equipo",document.getElementById("playerBreadcrumb").textContent=t.nombre;const n=document.getElementById("teamLogo");if(n&&t.equipo_nombre){const e=new Image;e.onload=()=>{n.style.backgroundImage=`url('${getTeamLogo(t.equipo_nombre)}')`,n.style.backgroundSize="cover",n.style.backgroundPosition="center",n.innerHTML=""},e.onerror=()=>{n.style.backgroundImage="linear-gradient(45deg, #ffd700, #ff8c00)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontSize="1.4rem",n.style.fontWeight="bold",n.style.color="#1a1a2e",n.innerHTML=getInitials(t.nombre)},e.src=getTeamLogo(t.equipo_nombre)}const o=document.getElementById("backToTeamButton");o&&(o.href=t.equipo_id?`equipo.html?id=${t.equipo_id}`:"#",o.style.display=t.equipo_id?"inline-block":"none"),await loadAllStats()}catch(t){console.error("Error cargando jugador:",t),showError("Error al cargar datos del jugador")}}async function loadAllStats(){const t=currentTournamentId?`&torneo_id=${currentTournamentId}`:"";await Promise.all([loadOffensiveStats(t),loadPitchingStats(t),loadDefensiveStats(t),loadComparison(t)])}async function loadOffensiveStats(t){const e=await fetchSafe(`/api/estadisticas-ofensivas?jugador_id=${jugadorId}${t}`),n=Array.isArray(e)?e.find(t=>String(t.jugador_id)===String(jugadorId))||e[0]:e;if(!n)return document.getElementById("statAVG").textContent=".000",document.getElementById("statOBP").textContent=".000",document.getElementById("statSLG").textContent=".000",document.getElementById("statOPS").textContent=".000",document.getElementById("headerAVG").textContent="---",document.getElementById("headerHR").textContent="0",document.getElementById("headerRBI").textContent="0",document.getElementById("headerOPS").textContent="---",void(document.getElementById("offensiveTableBody").innerHTML='<tr><td colspan="12" class="empty-state-v2">Sin estad√≠sticas ofensivas</td></tr>');const o=toNum(n.at_bats),a=toNum(n.hits),r=toNum(n.doubles),d=toNum(n.triples),s=toNum(n.home_runs),i=toNum(n.rbi),l=toNum(n.runs),c=toNum(n.walks),u=toNum(n.strikeouts),m=toNum(n.stolen_bases),g=toNum(n.hit_by_pitch),y=toNum(n.sacrifice_flies),f=o>0?a/o:0,p=o+c+g+y>0?(a+c+g)/(o+c+g+y):0,h=o>0?(a-r-d-s+2*r+3*d+4*s)/o:0,b=p+h;document.getElementById("statAVG").textContent=f.toFixed(3),document.getElementById("statOBP").textContent=p.toFixed(3),document.getElementById("statSLG").textContent=h.toFixed(3),document.getElementById("statOPS").textContent=b.toFixed(3),document.getElementById("headerAVG").textContent=f.toFixed(3),document.getElementById("headerHR").textContent=s,document.getElementById("headerRBI").textContent=i,document.getElementById("headerOPS").textContent=b.toFixed(3),document.getElementById("offensiveTableBody").innerHTML=`\n        <tr>\n            <td>${o}</td><td>${a}</td><td>${r}</td><td>${d}</td><td>${s}</td>\n            <td>${i}</td><td>${l}</td><td>${c}</td><td>${u}</td><td>${m}</td>\n            <td>${g}</td><td>${y}</td>\n        </tr>\n    `,createOffensiveChart({h:a,d:r,t:d,hr:s,bb:c,so:u,sb:m})}async function loadPitchingStats(t){const e=await fetchSafe(`/api/estadisticas-pitcheo?jugador_id=${jugadorId}${t}`),n=Array.isArray(e)?e.find(t=>String(t.jugador_id)===String(jugadorId))||e[0]:e;if(!n)return document.getElementById("statERA").textContent="0.00",document.getElementById("statWL").textContent="0-0",document.getElementById("statPitchSO").textContent="0",document.getElementById("statWHIP").textContent="0.00",void(document.getElementById("pitchingTableBody").innerHTML='<tr><td colspan="11" class="empty-state-v2">Sin estad√≠sticas de pitcheo</td></tr>');const o=parseFloat(n.innings_pitched)||0,a=toNum(n.hits_allowed),r=toNum(n.earned_runs),d=toNum(n.walks_allowed),s=toNum(n.strikeouts),i=toNum(n.home_runs_allowed),l=toNum(n.wins),c=toNum(n.losses),u=toNum(n.saves),m=o>0?9*r/o:0,g=o>0?(a+d)/o:0;document.getElementById("statERA").textContent=m.toFixed(2),document.getElementById("statWL").textContent=`${l}-${c}`,document.getElementById("statPitchSO").textContent=s,document.getElementById("statWHIP").textContent=g.toFixed(2),document.getElementById("pitchingTableBody").innerHTML=`\n        <tr>\n            <td>${o}</td><td>${a}</td><td>${r}</td><td>${d}</td>\n            <td>${s}</td><td>${i}</td><td>${l}</td><td>${c}</td>\n            <td>${u}</td><td>${m.toFixed(2)}</td><td>${g.toFixed(2)}</td>\n        </tr>\n    `}async function loadDefensiveStats(t){const e=await fetchSafe(`/api/estadisticas-defensivas?jugador_id=${jugadorId}${t}`),n=Array.isArray(e)?e.find(t=>String(t.jugador_id)===String(jugadorId))||e[0]:e;if(!n)return document.getElementById("statFPCT").textContent=".000",document.getElementById("statPO").textContent="0",document.getElementById("statA").textContent="0",document.getElementById("statE").textContent="0",void(document.getElementById("defensiveTableBody").innerHTML='<tr><td colspan="7" class="empty-state-v2">Sin estad√≠sticas defensivas</td></tr>');const o=toNum(n.putouts),a=toNum(n.assists),r=toNum(n.errors),d=toNum(n.double_plays),s=toNum(n.passed_balls),i=toNum(n.chances),l=i>0?(o+a)/i:0;document.getElementById("statFPCT").textContent=l.toFixed(3),document.getElementById("statPO").textContent=o,document.getElementById("statA").textContent=a,document.getElementById("statE").textContent=r,document.getElementById("defensiveTableBody").innerHTML=`\n        <tr>\n            <td>${o}</td><td>${a}</td><td>${r}</td><td>${d}</td>\n            <td>${s}</td><td>${i}</td><td>${l.toFixed(3)}</td>\n        </tr>\n    `}async function loadComparison(t){const e=document.getElementById("comparisonContainer"),n=await fetchSafe(`/api/estadisticas-ofensivas?min_at_bats=1${t}`);if(!n||!Array.isArray(n)||0===n.length)return void(e.innerHTML='<div class="empty-state-v2">No hay datos para comparar</div>');const o=n.find(t=>String(t.jugador_id)===String(jugadorId));if(!o)return void(e.innerHTML='<div class="empty-state-v2">No hay estad√≠sticas del jugador para comparar</div>');let a="";[{key:"avg",label:"AVG (Promedio)",format:t=>parseFloat(t).toFixed(3),higher:!0},{key:"home_runs",label:"HR (Jonrones)",format:t=>toNum(t),higher:!0},{key:"rbi",label:"RBI (Carreras Impulsadas)",format:t=>toNum(t),higher:!0},{key:"hits",label:"H (Hits)",format:t=>toNum(t),higher:!0},{key:"stolen_bases",label:"SB (Bases Robadas)",format:t=>toNum(t),higher:!0}].forEach(t=>{const e=[...n].sort((e,n)=>{const o=parseFloat(e[t.key])||0,a=parseFloat(n[t.key])||0;return t.higher?a-o:o-a})[0],r=parseFloat(e[t.key])||0,d=parseFloat(o[t.key])||0,s=r>0?Math.min(d/r*100,100):0;a+=`\n            <div class="comparison-card">\n                <h4>${t.label}</h4>\n                <div class="comparison-bar-bg">\n                    <div class="comparison-bar-fill" style="width: ${s.toFixed(1)}%">${t.format(d)}</div>\n                </div>\n                <div class="comparison-labels">\n                    <span class="player-value">T√∫: ${t.format(d)}</span>\n                    <span class="leader-value">L√≠der: ${t.format(r)} (${e.jugador_nombre||"N/A"})</span>\n                </div>\n            </div>\n        `}),e.innerHTML=a,createRadarChart(o,n)}function createOffensiveChart(t){const e=document.getElementById("offensiveChart");e&&(offensiveChart&&offensiveChart.destroy(),offensiveChart=new Chart(e,{type:"bar",data:{labels:["H","2B","3B","HR","BB","SO","SB"],datasets:[{label:"Estad√≠sticas",data:[t.h,t.d,t.t,t.hr,t.bb,t.so,t.sb],backgroundColor:["rgba(255, 215, 0, 0.8)","rgba(255, 140, 0, 0.8)","rgba(255, 107, 53, 0.8)","rgba(220, 20, 60, 0.8)","rgba(102, 126, 234, 0.8)","rgba(255, 99, 132, 0.5)","rgba(75, 192, 192, 0.8)"],borderColor:"rgba(255, 215, 0, 0.3)",borderWidth:1,borderRadius:6}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{color:"rgba(255, 255, 255, 0.5)"},grid:{color:"rgba(255, 255, 255, 0.05)"}},x:{ticks:{color:"#ffd700",font:{weight:"bold"}},grid:{display:!1}}}}}))}function createRadarChart(t,e){const n=document.getElementById("radarChart");if(!n)return;radarChart&&radarChart.destroy();const o=["avg","hits","home_runs","rbi","stolen_bases"],a=o.map(t=>Math.max(...e.map(e=>parseFloat(e[t])||0),1)),r=o.map((e,n)=>{const o=parseFloat(t[e])||0;return Math.round(o/a[n]*100)});radarChart=new Chart(n,{type:"radar",data:{labels:["AVG","H","HR","RBI","SB"],datasets:[{label:t.jugador_nombre||"Jugador",data:r,backgroundColor:"rgba(255, 215, 0, 0.2)",borderColor:"#ffd700",borderWidth:2,pointBackgroundColor:"#ffd700",pointBorderColor:"#ff8c00",pointRadius:4}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{labels:{color:"#ffd700"}}},scales:{r:{beginAtZero:!0,max:100,ticks:{color:"rgba(255, 255, 255, 0.4)",backdropColor:"transparent"},grid:{color:"rgba(255, 215, 0, 0.15)"},angleLines:{color:"rgba(255, 215, 0, 0.15)"},pointLabels:{color:"#ff8c00",font:{size:12,weight:"bold"}}}}}})}function setupSSE(){const t=new EventSource("/api/sse/updates");t.addEventListener("stats-update",t=>{const e=JSON.parse(t.data);String(e.jugador_id)===String(jugadorId)&&(console.log("[SSE] Stats del jugador actualizadas, recargando..."),loadAllStats())}),t.addEventListener("tournament-change",()=>{console.log("[SSE] Torneo cambiado, recargando..."),loadTournaments().then(()=>loadAllStats())}),t.onerror=()=>{console.warn("[SSE] Error de conexi√≥n, reconectando autom√°ticamente...")}}document.addEventListener("DOMContentLoaded",async()=>{jugadorId&&!isNaN(parseInt(jugadorId))?(setupTabs(),await loadTournaments(),await loadPlayerInfo(),setupSSE()):showError("ID de jugador inv√°lido o no encontrado en la URL.")}),console.log("üìÑ jugador_v2.js cargado correctamente");