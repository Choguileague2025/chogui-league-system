let currentTeamId=null,teamData=null,rosterData=[],filteredRoster=[],recentGames=[],currentFilter="all",standingsData=[],currentTorneoId=null,allTorneos=[],sseConnection=null;function getTeamIdFromUrl(){return new URLSearchParams(window.location.search).get("id")}function configurarEventListeners(){document.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),currentFilter=this.dataset.position,filtrarRoster()})});const e=document.getElementById("tournamentSelect");e&&e.addEventListener("change",function(){currentTorneoId=this.value||null,cargarTodosLosDatos()})}async function cargarTorneos(){const e=document.getElementById("tournamentSelect");try{const t=await fetch("/api/torneos");if(!t.ok)throw new Error("Error cargando torneos");const r=await t.json();allTorneos=Array.isArray(r)?r:r.torneos||[],e.innerHTML='<option value="">Todos los torneos</option>';const n=allTorneos.find(e=>e.activo);allTorneos.forEach(t=>{const r=document.createElement("option");r.value=t.id,r.textContent=t.nombre+(t.activo?" (Activo)":""),e.appendChild(r)}),n&&(e.value=n.id,currentTorneoId=String(n.id)),cargarTodosLosDatos()}catch(t){console.error("Error cargando torneos:",t),e.innerHTML='<option value="">Sin torneos</option>',cargarTodosLosDatos()}}async function cargarTodosLosDatos(){try{await Promise.all([cargarInformacionEquipo(),cargarRosterEquipo(),cargarPartidosRecientes(),cargarStandings()]),await Promise.all([cargarEstadisticasColectivas(),cargarTopBateadores(),cargarTopLanzadores()])}catch(e){console.error("Error cargando datos del equipo:",e)}}async function cargarInformacionEquipo(){try{const e=await fetch(`/api/equipos/${currentTeamId}`);if(!e.ok){if(404===e.status)throw new Error(`Equipo con ID ${currentTeamId} no encontrado`);throw new Error(`Error del servidor: ${e.status}`)}if(teamData=await e.json(),!teamData.nombre)throw new Error("Datos del equipo incompletos");renderizarInformacionEquipo()}catch(e){throw console.error("Error cargando info equipo:",e),mostrarErrorEquipo(e.message),e}}function renderizarInformacionEquipo(){if(!teamData)return;document.title=`${teamData.nombre} - Chogui League`;const e=teamData.nombre.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");window.history.replaceState(null,document.title,`equipo.html?id=${currentTeamId}&nombre=${e}`);const t=document.getElementById("teamBreadcrumb");t&&(t.innerHTML=`<strong style="color: #ffd700;">${teamData.nombre}</strong>`);if(mostrarLogoEquipo(getTeamLogo(teamData.nombre),teamData.nombre),setTextContent("teamName",teamData.nombre),setTextContent("teamLocation",teamData.ciudad||"Ubicaci√≥n no especificada"),setTextContent("teamManager",teamData.manager||"Manager no asignado"),teamData.fecha_creacion){const e=new Date(teamData.fecha_creacion).getFullYear();setTextContent("teamFounded",isNaN(e)?"N/A":e)}else setTextContent("teamFounded","N/A")}function getTeamLogo(e){if(!e)return"/public/images/logos/default-logo.png";const t=e.toLowerCase().trim(),r={"guerreros del norte":"guerreros-del-norte.png","la guaira":"la-guaira.png","furia del caribe":"furia-del-caribe.png","tigres unidos":"tigres-unidos.png","leones dorados":"leones-dorados.png","aguilas negras":"aguilas-negras.png",venearstone:"venearstone.png",desss:"desss.png","caribes rd":"caribes-rd.png","dragones fc":"dragones-fc.png","los del sur":"los-del-sur.png"}[t];if(r)return`/public/images/logos/${r}`;return`/public/images/logos/${t.replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"")+".png"}`}function mostrarLogoEquipo(e,t){const r=document.querySelector(".team-logo");if(!r)return;const n=new Image;n.onload=function(){r.style.backgroundImage=`url('${e}')`,r.style.backgroundSize="contain",r.style.backgroundRepeat="no-repeat",r.style.backgroundPosition="center",r.innerHTML=""},n.onerror=function(){const e=generarIniciales(t);r.style.backgroundImage="none",r.innerHTML=`\n            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;\n                background:linear-gradient(145deg,#ffd700,#ff8c00);border-radius:50%;\n                font-size:2.5rem;font-weight:bold;color:#1a1a2e;text-shadow:2px 2px 4px rgba(0,0,0,0.2);">\n                ${e}\n            </div>`},n.src=e}function generarIniciales(e){if(!e)return"?";const t=e.trim().split(/\s+/);return 1===t.length?t[0].substring(0,2).toUpperCase():t.slice(0,3).map(e=>e.charAt(0).toUpperCase()).join("")}async function cargarStandings(){try{const e=currentTorneoId?`?torneo_id=${currentTorneoId}`:"",t=await fetch(`/api/standings${e}`);if(!t.ok)return standingsData=[],void calcularEstadisticasEquipo(null);standingsData=await t.json(),Array.isArray(standingsData)||(standingsData=[]);calcularEstadisticasEquipo(standingsData.find(e=>Number(e.id||e.equipo_id)===Number(currentTeamId)))}catch(e){console.warn("Error cargando standings:",e),standingsData=[],calcularEstadisticasEquipo(null)}}function calcularEstadisticasEquipo(e){if(e){const t=toNumber(e.pj),r=toNumber(e.pg),n=toNumber(e.pp),o=toNumber(e.cf),a=toNumber(e.ce),s=Number(e.porcentaje)||0,i=e.ranking?`#${e.ranking}`:"--",c=calcularRacha(recentGames);return setTextContent("teamRecord",`${r}-${n}${c?` (${c})`:""}`),setTextContent("teamPositionStat",i),setTextContent("teamWinPct",s.toFixed(3)),setTextContent("teamRuns",o),setTextContent("winPercentage",s.toFixed(3)),setTextContent("gamesPlayed",t),setTextContent("wins",r),setTextContent("losses",n),setTextContent("runsScored",o),void setTextContent("runsAllowed",a)}let t=0,r=0,n=0,o=0;recentGames.filter(e=>null!==e.carreras_local&&null!==e.carreras_visitante).forEach(e=>{const a=e.equipo_local_id==currentTeamId,s=a?e.carreras_local:e.carreras_visitante,i=a?e.carreras_visitante:e.carreras_local;n+=s||0,o+=i||0,s>i?t++:r++});const a=t+r,s=a>0?t/a:0,i=calcularRacha(recentGames);setTextContent("teamRecord",`${t}-${r}${i?` (${i})`:""}`),setTextContent("teamPositionStat","--"),setTextContent("teamWinPct",s.toFixed(3)),setTextContent("teamRuns",n),setTextContent("winPercentage",s.toFixed(3)),setTextContent("gamesPlayed",a),setTextContent("wins",t),setTextContent("losses",r),setTextContent("runsScored",n),setTextContent("runsAllowed",o)}async function cargarEstadisticasColectivas(){try{const e=currentTorneoId?`&torneo_id=${currentTorneoId}`:"";if(0===rosterData.length)return void resetCollectiveStats();const t=await fetch(`/api/estadisticas-ofensivas?equipo_id=${currentTeamId}${e}`),r=t.ok?await t.json():[];let n=0,o=0,a=0,s=0,i=0,c=0,d=0,l=0,u=0,m=0;(Array.isArray(r)?r:[]).forEach(e=>{n+=toNumber(e.at_bats),o+=toNumber(e.hits),u+=toNumber(e.doubles),m+=toNumber(e.triples),a+=toNumber(e.home_runs),s+=toNumber(e.rbi),i+=toNumber(e.walks),c+=toNumber(e.hit_by_pitch),d+=toNumber(e.sacrifice_flies),l+=toNumber(e.stolen_bases)});const g=(n+i+c+d>0?(o+i+c)/(n+i+c+d):0)+(n>0?(o-u-m-a+2*u+3*m+4*a)/n:0);setTextContent("teamAvg",(n>0?o/n:0).toFixed(3)),setTextContent("teamHr",a),setTextContent("teamRbi",s),setTextContent("teamOps",g.toFixed(3)),setTextContent("teamHits",o),setTextContent("teamSb",l)}catch(e){console.error("Error cargando estad√≠sticas colectivas:",e),resetCollectiveStats()}}function resetCollectiveStats(){setTextContent("teamAvg",".000"),setTextContent("teamHr","0"),setTextContent("teamRbi","0"),setTextContent("teamOps",".000"),setTextContent("teamHits","0"),setTextContent("teamSb","0")}async function cargarTopBateadores(){const e=document.getElementById("topBattersBody");try{const t=currentTorneoId?`&torneo_id=${currentTorneoId}`:"";if(0===rosterData.length)return void(e.innerHTML='<tr><td colspan="7" class="empty-cell">No hay jugadores</td></tr>');const r=await fetch(`/api/estadisticas-ofensivas?equipo_id=${currentTeamId}${t}`),n=r.ok?await r.json():[],o=Array.isArray(n)?n:[],a=[];o.forEach(e=>{const t=toNumber(e.at_bats);if(0===t)return;const r=toNumber(e.hits),n=toNumber(e.doubles),o=toNumber(e.triples),s=toNumber(e.home_runs),i=toNumber(e.rbi),c=toNumber(e.walks),d=toNumber(e.hit_by_pitch),l=toNumber(e.sacrifice_flies),u=r/t,m=(t+c+d+l>0?(r+c+d)/(t+c+d+l):0)+(r-n-o-s+2*n+3*o+4*s)/t;a.push({id:e.jugador_id||e.id,nombre:e.jugador_nombre||"N/A",avg:u,hr:s,rbi:i,h:r,ops:m})}),a.sort((e,t)=>t.avg-e.avg);const s=a.slice(0,5);if(0===s.length)return void(e.innerHTML='<tr><td colspan="7" class="empty-cell">Sin estad√≠sticas disponibles</td></tr>');e.innerHTML=s.map((e,t)=>`\n            <tr onclick="verJugador(${e.id})">\n                <td class="rank-cell">${t+1}</td>\n                <td class="player-name-cell"><a href="jugador.html?id=${e.id}&equipo=${currentTeamId}">${e.nombre}</a></td>\n                <td>${e.avg.toFixed(3)}</td>\n                <td>${e.hr}</td>\n                <td>${e.rbi}</td>\n                <td>${e.h}</td>\n                <td>${e.ops.toFixed(3)}</td>\n            </tr>\n        `).join("")}catch(t){console.error("Error cargando top bateadores:",t),e.innerHTML='<tr><td colspan="7" class="empty-cell">Error cargando datos</td></tr>'}}async function cargarTopLanzadores(){const e=document.getElementById("topPitchersBody");try{const t=currentTorneoId?`&torneo_id=${currentTorneoId}`:"";if(0===rosterData.length)return void(e.innerHTML='<tr><td colspan="7" class="empty-cell">No hay jugadores</td></tr>');const r=await fetch(`/api/estadisticas-pitcheo?equipo_id=${currentTeamId}${t}`),n=r.ok?await r.json():[],o=Array.isArray(n)?n:[],a=[];o.forEach(e=>{const t=parseFloat(e.innings_pitched)||0;if(0===t)return;const r=toNumber(e.earned_runs),n=toNumber(e.hits_allowed),o=toNumber(e.strikeouts),s=toNumber(e.walks_allowed),i=toNumber(e.wins),c=toNumber(e.losses),d=r/t*9,l=(s+n)/t;a.push({id:e.jugador_id||e.id,nombre:e.jugador_nombre||"N/A",era:d,wl:`${i}-${c}`,so:o,ip:t.toFixed(1),whip:l})}),a.sort((e,t)=>e.era-t.era);const s=a.slice(0,5);if(0===s.length)return void(e.innerHTML='<tr><td colspan="7" class="empty-cell">Sin estad√≠sticas disponibles</td></tr>');e.innerHTML=s.map((e,t)=>`\n            <tr onclick="verJugador(${e.id})">\n                <td class="rank-cell">${t+1}</td>\n                <td class="player-name-cell"><a href="jugador.html?id=${e.id}&equipo=${currentTeamId}">${e.nombre}</a></td>\n                <td>${e.era.toFixed(2)}</td>\n                <td>${e.wl}</td>\n                <td>${e.so}</td>\n                <td>${e.ip}</td>\n                <td>${e.whip.toFixed(2)}</td>\n            </tr>\n        `).join("")}catch(t){console.error("Error cargando top lanzadores:",t),e.innerHTML='<tr><td colspan="7" class="empty-cell">Error cargando datos</td></tr>'}}async function cargarRosterEquipo(){const e=document.getElementById("rosterContainer");try{const e=await fetch(`/api/jugadores?equipo_id=${currentTeamId}`);if(!e.ok)throw new Error(`Error cargando roster: ${e.status}`);const t=await e.json();rosterData=Array.isArray(t.jugadores)?t.jugadores:[],filteredRoster=[...rosterData],renderizarRoster()}catch(t){console.error("Error cargando roster:",t),e.innerHTML='\n            <div class="empty-state">\n                <h4>‚ö†Ô∏è Error cargando roster</h4>\n                <p>No se pudo cargar la informaci√≥n de los jugadores.<br>\n                <button onclick="cargarRosterEquipo()" class="btn-secondary" style="margin-top: 10px;">üîÑ Reintentar</button></p>\n            </div>'}}function filtrarRoster(){filteredRoster="all"===currentFilter?[...rosterData]:"IF"===currentFilter?rosterData.filter(e=>["1B","2B","3B","SS"].includes(e.posicion)):"OF"===currentFilter?rosterData.filter(e=>["LF","CF","RF"].includes(e.posicion)):rosterData.filter(e=>e.posicion===currentFilter),renderizarRoster()}function renderizarRoster(){const e=document.getElementById("rosterContainer"),t=new URLSearchParams(window.location.search).get("jugador");filteredRoster&&0!==filteredRoster.length?(e.innerHTML=filteredRoster.map(e=>`\n            <div class="roster-player-card"${t&&e.nombre.toLowerCase().includes(t.toLowerCase())?' style="border: 2px solid #ffd700; background: rgba(255,215,0,0.15);"':""} onclick="verJugador(${e.id})">\n                <div class="roster-player-number"${e.numero||0===e.numero?"":' style="opacity:0.5"'}>#${e.numero??"0"}</div>\n                <div class="roster-player-info">\n                    <div class="roster-player-name">${e.nombre}</div>\n                    <div class="roster-player-pos">${formatearPosicion(e.posicion)}</div>\n                </div>\n            </div>`).join(""),t&&setTimeout(()=>{const t=e.querySelector('[style*="rgba(255,215,0,0.15)"]');t&&t.scrollIntoView({behavior:"smooth",block:"center"})},500)):e.innerHTML='<div class="empty-state">No hay jugadores en este filtro</div>'}async function cargarPartidosRecientes(){const e=document.getElementById("recentGamesContainer");try{const e=currentTorneoId?`&torneo_id=${currentTorneoId}`:"",t=await fetch(`/api/partidos?equipo_id=${currentTeamId}&limit=10${e}`);if(!t.ok)throw new Error(`Error cargando partidos: ${t.status}`);const r=await t.json();recentGames=r.partidos||[],renderizarPartidosRecientes()}catch(t){console.error("Error cargando partidos:",t),e.innerHTML='\n            <div class="empty-state">\n                <h4>‚ö†Ô∏è Error cargando partidos</h4>\n                <button onclick="cargarPartidosRecientes()" class="btn-secondary" style="margin-top: 10px;">üîÑ Reintentar</button>\n            </div>'}}function renderizarPartidosRecientes(){const e=document.getElementById("recentGamesContainer");recentGames&&0!==recentGames.length?e.innerHTML=recentGames.map(e=>{const t=e.equipo_local_id==currentTeamId;return`\n            <div class="game-item">\n                <div class="game-teams">vs ${t?e.equipo_visitante_nombre:e.equipo_local_nombre}</div>\n                <div class="game-score">${obtenerResultadoPartido(e,t)}</div>\n                <div class="game-date">${formatearFecha(e.fecha_partido)}</div>\n            </div>`}).join(""):e.innerHTML='<div class="empty-state">No hay partidos recientes para este equipo.</div>'}function conectarSSE(){if("undefined"!=typeof EventSource)try{sseConnection=new EventSource("/api/sse/updates"),sseConnection.addEventListener("stats-update",function(e){console.log("[SSE] Stats update recibido"),cargarEstadisticasColectivas(),cargarTopBateadores(),cargarTopLanzadores()}),sseConnection.addEventListener("tournament-change",function(e){console.log("[SSE] Tournament change recibido"),cargarTorneos()}),sseConnection.addEventListener("general-update",function(e){console.log("[SSE] General update recibido"),cargarTodosLosDatos()}),sseConnection.onerror=function(){console.warn("[SSE] Error de conexi√≥n, reintentando...")}}catch(e){console.warn("[SSE] No se pudo conectar:",e)}}function formatearPosicion(e){return{P:"Pitcher",C:"Catcher","1B":"Primera Base","2B":"Segunda Base","3B":"Tercera Base",SS:"Shortstop",LF:"Left Field",CF:"Center Field",RF:"Right Field"}[e]||e||"N/A"}function formatearFecha(e){if(!e)return"Fecha no disp.";return new Date(e+"T00:00:00Z").toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",timeZone:"UTC"})}function calcularRacha(e){const t=Array.isArray(e)?e.filter(e=>null!==e.carreras_local&&null!==e.carreras_visitante):[];if(0===t.length)return null;t.sort((e,t)=>new Date(`${t.fecha_partido}T00:00:00Z`).getTime()-new Date(`${e.fecha_partido}T00:00:00Z`).getTime());const r=e=>{const t=e.equipo_local_id==currentTeamId;return(t?e.carreras_local:e.carreras_visitante)>(t?e.carreras_visitante:e.carreras_local)?"W":"L"};let n=0,o=null;for(const e of t){const t=r(e);if(o){if(t!==o)break;n++}else o=t,n=1}return o?`${o}${n}`:null}function obtenerResultadoPartido(e,t){if(null===e.carreras_local||null===e.carreras_visitante)return"Pendiente";const r=t?e.carreras_local:e.carreras_visitante,n=t?e.carreras_visitante:e.carreras_local;return`${r>n?"G":"P"} ${r}-${n}`}function toNumber(e){const t=Number(e);return Number.isFinite(t)?t:0}function setTextContent(e,t){const r=document.getElementById(e);r&&(r.textContent=t)}function verJugador(e){const t=rosterData.find(t=>t.id===e);if(!t)return void alert("Informaci√≥n del jugador no disponible");const r=t.nombre.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");window.location.href=`jugador.html?id=${e}&nombre=${r}&equipo=${currentTeamId}`}function mostrarErrorEquipo(e){const t=document.querySelector(".team-main-card");if(!t)return;t.innerHTML=`\n        <div style="text-align:center;padding:40px 20px;">\n            <h2 style="color:#dc143c;margin-bottom:20px;">‚ö†Ô∏è Error</h2>\n            <p style="color:#fff;margin-bottom:20px;">${e}</p>\n            <div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;">\n                <button onclick="location.reload()" class="btn-primary">üîÑ Reintentar</button>\n                <a href="index.html" class="btn-secondary">üè† Volver al Inicio</a>\n            </div>\n        </div>`;const r=document.querySelector(".content-grid"),n=document.querySelector(".recent-games");r&&(r.style.display="none"),n&&(n.style.display="none")}document.addEventListener("DOMContentLoaded",function(){currentTeamId=getTeamIdFromUrl(),currentTeamId&&!isNaN(currentTeamId)?(configurarEventListeners(),cargarTorneos(),conectarSSE()):mostrarErrorEquipo("No se especific√≥ un equipo v√°lido. Verifica la URL.")}),window.addEventListener("beforeunload",function(){sseConnection&&(sseConnection.close(),sseConnection=null)}),console.log("‚úÖ equipo_v2.js cargado correctamente");